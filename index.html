<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DogWorld E-Learning - Piattaforma Educativa</title>
    <link rel="icon" type="image/png" href="/favicon-96x96.png" sizes="96x96" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <link rel="shortcut icon" href="/favicon.ico" />
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <style>
        :root {
            --primary-color: #003B46; --secondary-color: #07575B; --accent-color: #66A5AD;
            --danger-color: #c94c4c; --success-color: #4caf50; --warning-color: #f0ad4e;
            --light-color: #FFFFFF; --dark-text: #333333; --light-text: #f4f4f4;
            --font-family: 'Montserrat', sans-serif;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html { overflow-x: hidden; scroll-behavior: smooth; }
        body { font-family: var(--font-family); background-color: #f4f8f9; color: var(--dark-text); }
        body.modal-open { overflow: hidden; }
        .page-container { display: flex; min-height: 100vh; }
        h1, h2, h3, h4 { color: var(--primary-color); font-weight: 700; margin-bottom: 1rem; }
        p { line-height: 1.6; margin-bottom: 1rem; }
        a { color: var(--secondary-color); text-decoration: none; }
        .page { display: none; padding: 40px; animation: fadeIn 0.5s; }
        .page.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* Sidebar & Navigation */
        .sidebar { height: 100vh; width: 250px; position: fixed; top: 0; left: 0; background-color: var(--primary-color); color: var(--light-text); padding-top: 20px; display: flex; flex-direction: column; z-index: 100; }
        .sidebar-header { text-align: center; margin-bottom: 15px; padding: 0 10px; }
        .sidebar-header .logo { width: 200px; height: auto; margin-bottom: 10px; }
        .sidebar ul { list-style-type: none; width: 100%; padding-top: 15px; overflow-y: auto; flex-grow: 1; }
        .sidebar ul li a { display: flex; align-items: center; padding: 15px 25px; color: var(--light-text); transition: background-color 0.3s, padding-left 0.3s; cursor: pointer; }
        .sidebar ul li a .fas { margin-right: 15px; width: 20px; text-align: center; }
        .sidebar ul li a:hover, .sidebar ul li a.active { background-color: var(--secondary-color); padding-left: 35px; }
        .sidebar ul li[data-role] { display: none; }
        body.guest-view .sidebar ul li[data-role="guest"],
        body.student-view .sidebar ul li[data-role="student"],
        body.admin-view .sidebar ul li[data-role="admin"],
        body.admin-view .sidebar ul li[data-role="student"] { display: list-item; }

        /* Content Area */
        .content { margin-left: 250px; width: calc(100% - 250px); }
        .main-content { flex-grow: 1; }
        section { margin-bottom: 50px; padding: 25px; border-radius: 8px; background: #fff; box-shadow: 0 2px 10px rgba(0,0,0,0.05); position: relative; }

        /* Admin Mode & Controls */
        .admin-only { display: none !important; }
        body.admin-mode .admin-only { display: block !important; }
        .admin-controls { position: absolute; top: 10px; right: 10px; background: rgba(0,0,0,0.7); border-radius: 5px; padding: 5px; display: none; gap: 5px; z-index: 10; }
        body.admin-mode .admin-controls { display: flex !important; }
        .admin-btn { background: none; border: none; color: white; font-size: 16px; cursor: pointer; padding: 5px; border-radius: 3px; }
        .drag-handle { position: absolute; top: 10px; left: 10px; background: rgba(0,0,0,0.7); color: white; border-radius: 3px; padding: 5px 8px; cursor: move; z-index: 10; display: none; }
        body.admin-mode .drag-handle { display: block; }
        body.admin-mode [data-editable-text]:hover { box-shadow: 0 0 0 2px var(--accent-color); cursor: text; }
        body.admin-mode [data-editable-text].editing-now { outline: 2px solid var(--primary-color); }
        #text-editor-toolbar { position: absolute; z-index: 1010; background: var(--dark-text); padding: 5px 8px; border-radius: 5px; display: flex; gap: 8px; }
        #text-editor-toolbar button { background: none; border: none; color: white; font-size: 16px; cursor: pointer; width: 30px; height: 30px; }
        #text-editor-toolbar button:hover { background-color: var(--secondary-color); }
        
        /* Generic Components */
        .card-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; margin-top: 20px; }
        .request-card { background: white; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.08); padding: 20px; border-left: 5px solid var(--warning-color); }
        .request-actions { display: flex; gap: 10px; margin-top: 15px; }
        .btn-approve, .btn-reject { color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer; }
        .btn-approve { background: var(--success-color); }
        .btn-reject { background: var(--danger-color); }
        .btn-primary { background-color: var(--primary-color); color: var(--light-color); border: none; cursor: pointer; padding: 12px 25px; border-radius: 5px; font-size: 1.1em; }

        /* Modal Styles */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.8); }
        .modal-content-wrapper { display: flex; justify-content: center; align-items: center; min-height: 100%; padding: 20px; }
        .modal-content { background-color: #fefefe; padding: 25px; border-radius: 8px; width: 90%; max-width: 500px; position: relative; }
        .close-btn { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }

        /* Form Styles */
        .form-container input, .form-container button { width: 100%; padding: 12px; margin-bottom: 15px; border-radius: 5px; border: 1px solid #ddd; }
        .form-container button { background-color: var(--primary-color); color: var(--light-color); border: none; cursor: pointer; }

        /* Footer */
        .site-footer { background: var(--primary-color); color: var(--light-text); text-align: center; padding: 20px; }
        #logout-btn { background: var(--danger-color); color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer; }

        /* Responsive */
        @media (max-width: 992px) {
            .sidebar { width: 100%; height: auto; position: relative; flex-direction: row; justify-content: space-between; padding: 10px; }
            .sidebar-header .logo { display: none; }
            .sidebar ul { display: flex; flex-wrap: wrap; justify-content: center; width: auto; padding: 0; }
            .sidebar ul li { margin: 2px; }
            .sidebar ul li a { padding: 8px 12px; }
            .content { margin-left: 0; width: 100%; }
            .page { padding: 20px; }
        }
    </style>
</head>
<body>
    <div class="page-container">
        <!-- Sidebar Navigation -->
        <nav class="sidebar">
            <div class="sidebar-header"><img src="/images/logo-dogworld-chiaro.png" alt="DogWorld Logo" class="logo"></div>
            <ul>
                <li data-role="guest" data-role-default><a href="#" data-target="welcome"><i class="fas fa-door-open"></i> Benvenuto</a></li>
                <li data-role="student" data-role-default><a href="#" data-target="dashboard"><i class="fas fa-tachometer-alt"></i> Dashboard</a></li>
                <li data-role="student"><a href="#" data-target="courses"><i class="fas fa-graduation-cap"></i> I Miei Corsi</a></li>
                <li data-role="student"><a href="#" data-target="catalog"><i class="fas fa-book"></i> Catalogo Corsi</a></li>
                <li data-role="admin" data-role-default><a href="#" data-target="administration"><i class="fas fa-users-cog"></i> Amministrazione</a></li>
                <li data-role="admin"><a href="#" data-target="admin-courses"><i class="fas fa-cog"></i> Gestione Corsi</a></li>
                <li data-role="student" data-role="admin"><a href="#" data-target="support"><i class="fas fa-life-ring"></i> Supporto</a></li>
            </ul>
        </nav>

        <!-- Main Content Area -->
        <div class="content">
            <main class="main-content">
                <!-- Welcome Page (for guests) -->
                <div id="welcome-page" class="page">
                    <section style="text-align: center;">
                        <img src="/images/logo-dogworld-scuro.png" alt="DogWorld Logo" style="max-width: 300px; margin-bottom: 20px;">
                        <h1 data-editable-text="welcome/title">Piattaforma E-Learning DogWorld</h1>
                        <p data-editable-text="welcome/intro">Benvenuto nell'area dedicata alla formazione online di <a href="https://ilmondodelcane.net" target="_blank">DogWorld - Il Mondo del Cane</a>. Qui troverai corsi professionali per approfondire le tue conoscenze cinofile.</p>
                        <button id="welcome-login-btn" class="btn-primary">Accedi o Registrati</button>
                    </section>
                </div>

                <!-- Dashboard Page (for students) -->
                <div id="dashboard-page" class="page">
                    <section>
                        <h1 data-editable-text="dashboard/title">La Tua Dashboard</h1>
                        <p>Bentornato! Da qui puoi riprendere i tuoi corsi e monitorare i tuoi progressi.</p>
                    </section>
                </div>

                <!-- Administration Page (for admins) -->
                <div id="administration-page" class="page">
                    <section>
                        <h1 data-editable-text="admin/title">Amministrazione</h1>
                        <p>Gestisci le richieste di iscrizione, gli studenti e le impostazioni della piattaforma.</p>
                    </section>
                    <section>
                        <h3>Richieste di Iscrizione in Attesa</h3>
                        <div id="registration-requests-container" class="card-grid"></div>
                    </section>
                    <section>
                        <h3>Elenco Studenti Approvati</h3>
                        <div id="students-list-container"></div>
                    </section>
                </div>

                <!-- Other Pages -->
                <div id="courses-page" class="page"><section><h1>I Miei Corsi</h1></section></div>
                <div id="catalog-page" class="page"><section><h1>Catalogo Corsi</h1></section></div>
                <div id="admin-courses-page" class="page"><section><h1>Gestione Corsi</h1></section></div>
                <div id="support-page" class="page"><section><h1>Supporto</h1></section></div>
            </main>
        </div>
    </div>

    <!-- Modals -->
    <div id="login-modal" class="modal">
        <div class="modal-content-wrapper">
            <div class="modal-content">
                <span class="close-btn">×</span>
                <h3>Accesso Piattaforma</h3>
                <form id="login-form" class="form-container">
                    <input type="email" id="login-email" placeholder="Email" required>
                    <input type="password" id="login-password" placeholder="Password" required>
                    <button type="submit">Accedi</button>
                </form>
                <p style="text-align: center; margin-top: 15px;">Non hai un account? <a href="#" id="show-register-modal-btn">Registrati qui</a></p>
            </div>
        </div>
    </div>

    <div id="registration-modal" class="modal">
        <div class="modal-content-wrapper">
            <div class="modal-content">
                <span class="close-btn">×</span>
                <h3>Richiedi Accesso</h3>
                <form id="registration-form" class="form-container">
                    <input type="text" id="reg-firstName" placeholder="Nome" required>
                    <input type="text" id="reg-lastName" placeholder="Cognome" required>
                    <input type="email" id="reg-email" placeholder="Email" required>
                    <input type="tel" id="reg-phone" placeholder="Numero di Telefono" required>
                    <input type="text" id="reg-associatedId" placeholder="ID Associato (Opzionale)">
                    <button type="submit">Invia Richiesta</button>
                </form>
                <p style="text-align: center; margin-top: 15px;">Hai già un account? <a href="#" id="show-login-modal-btn">Accedi qui</a></p>
            </div>
        </div>
    </div>
    
    <div id="text-editor-toolbar" style="display:none;">
        <button class="save-text-btn" title="Salva"><i class="fas fa-check"></i></button>
        <button class="cancel-text-btn" title="Annulla"><i class="fas fa-times"></i></button>
    </div>

    <footer class="site-footer">
        <p>© 2024 DogWorld - Il Mondo del Cane. Tutti i diritti riservati.</p>
        <div class="footer-buttons">
            <button id="logout-btn" class="admin-only"><i class="fas fa-sign-out-alt"></i> Logout</button>
        </div>
    </footer>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>

    <script>
        // --- CONFIGURATIONS ---
        const firebaseConfig = {
            apiKey: "AIzaSyDygclohh3XpIOICCtyv6p_fZpevlCeRws",
            authDomain: "dogworld-f8518.firebaseapp.com",
            databaseURL: "https://dogworld-f8518-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "dogworld-f8518",
            storageBucket: "dogworld-f8518.firebasestorage.app",
        };
        const ADMIN_EMAILS = ['biomario94@gmail.com', 'info.ilmondodelcane@gmail.com'];
        const NETLIFY_FUNCTIONS_URL = '/.netlify/functions/';

        // --- FIREBASE INITIALIZATION ---
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const auth = firebase.auth();

        // --- GLOBAL VARIABLES ---
        let body, loginModal, registrationModal;

        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', initializeApp);

        async function initializeApp() {
            body = document.body;
            loginModal = document.getElementById('login-modal');
            registrationModal = document.getElementById('registration-modal');
            
            await authSystem.initialize();
            setupEventListeners();
        }

        function setupEventListeners() {
            // Modals
            document.querySelectorAll('.close-btn').forEach(btn => btn.addEventListener('click', () => closeModal(btn.closest('.modal'))));
            document.querySelectorAll('.modal').forEach(modal => modal.addEventListener('click', (e) => { if (e.target === modal) closeModal(modal); }));
            document.getElementById('show-register-modal-btn').addEventListener('click', (e) => { e.preventDefault(); closeModal(loginModal); openModal(registrationModal); });
            document.getElementById('show-login-modal-btn').addEventListener('click', (e) => { e.preventDefault(); closeModal(registrationModal); openModal(loginModal); });
            document.getElementById('welcome-login-btn').addEventListener('click', () => openModal(loginModal));
            
            // Forms
            document.getElementById('login-form').addEventListener('submit', authSystem.handleLogin);
            document.getElementById('registration-form').addEventListener('submit', authSystem.handleRegistrationRequest);
            document.getElementById('logout-btn').addEventListener('click', () => auth.signOut());

            // Navigation
            document.querySelectorAll('.sidebar a').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    switchPage(e.currentTarget.getAttribute('data-target'));
                });
            });
        }

        // --- AUTH & USER SYSTEM ---
        const authSystem = {
            currentUser: null, isAdmin: false, userProfile: null,

            async initialize() {
                return new Promise(resolve => {
                    auth.onAuthStateChanged(async (user) => {
                        this.currentUser = user;
                        if (user) {
                            this.isAdmin = ADMIN_EMAILS.includes(user.email);
                            if (!this.isAdmin) await this.loadUserProfile();
                        } else {
                            this.isAdmin = false;
                            this.userProfile = null;
                        }
                        this.updateUIRole();
                        resolve();
                    });
                });
            },

            async loadUserProfile() {
                const snapshot = await database.ref(`elearningUsers/${this.currentUser.uid}`).once('value');
                this.userProfile = snapshot.val();
            },

            updateUIRole() {
                body.classList.remove('guest-view', 'student-view', 'admin-view');
                let role = 'guest';
                if (this.currentUser) {
                    if (this.isAdmin) role = 'admin';
                    else if (this.userProfile && this.userProfile.accountStatus === 'approved') role = 'student';
                }
                body.classList.add(`${role}-view`);
                body.classList.toggle('admin-mode', this.isAdmin);

                const defaultPageLink = document.querySelector(`.sidebar li[data-role="${role}"][data-role-default] a`);
                if (defaultPageLink) switchPage(defaultPageLink.dataset.target);
                else switchPage('welcome');

                if (this.isAdmin) adminModule.initialize();
            },

            handleLogin: async (e) => {
                e.preventDefault();
                const email = document.getElementById('login-email').value;
                const password = document.getElementById('login-password').value;
                try {
                    await auth.signInWithEmailAndPassword(email, password);
                    closeModal(loginModal);
                } catch (error) { alert('Errore: ' + error.message); }
            },

            handleRegistrationRequest: async (e) => {
                e.preventDefault();
                const form = e.target;
                const formData = {
                    firstName: form.querySelector('#reg-firstName').value,
                    lastName: form.querySelector('#reg-lastName').value,
                    email: form.querySelector('#reg-email').value,
                    phone: form.querySelector('#reg-phone').value,
                    associatedId: form.querySelector('#reg-associatedId').value,
                };

                try {
                    const newRequestRef = await database.ref('elearningRegistrationRequests').push({
                        ...formData, status: 'pending', timestamp: firebase.database.ServerValue.TIMESTAMP
                    });

                    await fetch(NETLIFY_FUNCTIONS_URL + 'send-notification', {
                        method: 'POST',
                        body: JSON.stringify({ type: 'new_registration', ...formData, requestId: newRequestRef.key })
                    });

                    alert('Richiesta inviata! Riceverai un\'email di conferma dopo l\'approvazione.');
                    closeModal(registrationModal);
                    form.reset();
                } catch (error) { alert('Errore: ' + error.message); }
            }
        };

        // --- ADMIN MODULE ---
        const adminModule = {
            initialize() {
                this.loadPendingRequests();
                this.loadStudentsList();
                editableTextHandler.init();
            },
            
            loadPendingRequests() {
                const container = document.getElementById('registration-requests-container');
                database.ref('elearningRegistrationRequests').orderByChild('status').equalTo('pending').on('value', snapshot => {
                    container.innerHTML = '';
                    if (!snapshot.exists()) {
                        container.innerHTML = '<p>Nessuna richiesta in attesa.</p>';
                        return;
                    }
                    snapshot.forEach(child => {
                        container.innerHTML += this.createRequestCardHTML({ id: child.key, ...child.val() });
                    });
                });
            },

            loadStudentsList() {
                const container = document.getElementById('students-list-container');
                database.ref('elearningUsers').orderByChild('personalInfo/lastName').on('value', snapshot => {
                    container.innerHTML = '';
                    if (!snapshot.exists()) {
                        container.innerHTML = '<p>Nessuno studente approvato.</p>';
                        return;
                    }
                     snapshot.forEach(child => {
                        const student = { uid: child.key, ...child.val() };
                        container.innerHTML += `<p>${student.personalInfo.firstName} ${student.personalInfo.lastName} - ${student.personalInfo.email}</p>`; // Placeholder
                    });
                });
            },

            createRequestCardHTML(request) {
                return `
                    <div class="request-card" data-id="${request.id}">
                        <h4>${request.firstName} ${request.lastName}</h4>
                        <p><strong>Email:</strong> ${request.email}</p>
                        <p><strong>Tel:</strong> ${request.phone}</p>
                        ${request.associatedId ? `<p><strong>ID:</strong> ${request.associatedId}</p>` : ''}
                        <div class="request-actions">
                            <button class="btn-approve" onclick="adminModule.processRequest('${request.id}', 'approve')">Approva</button>
                            <button class="btn-reject" onclick="adminModule.processRequest('${request.id}', 'reject')">Rifiuta</button>
                        </div>
                    </div>
                `;
            },
            
            async processRequest(requestId, action) {
                if (action === 'reject' && !confirm("Sei sicuro di voler rifiutare questa richiesta?")) return;
                
                try {
                    const token = await auth.currentUser.getIdToken(true);
                    const response = await fetch(NETLIFY_FUNCTIONS_URL + 'manage-user-approval', {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${token}` },
                        body: JSON.stringify({ action, requestId })
                    });
                    
                    const result = await response.json();
                    if (!response.ok) throw new Error(result.error || 'Errore del server.');
                    
                    alert(`Richiesta ${action === 'approve' ? 'approvata' : 'rifiutata'} con successo! L'utente è stato notificato.`);
                } catch(err) {
                    alert("Operazione fallita: " + err.message);
                }
            }
        };
        window.adminModule = adminModule; // Expose to onclick handlers

        // --- INLINE TEXT EDITING ---
        const editableTextHandler = {
            currentEditingElement: null, originalContent: '',
            
            init() {
                this.loadTexts();
                document.body.addEventListener('click', (e) => {
                    if (!body.classList.contains('admin-mode')) return;
                    const target = e.target.closest('[data-editable-text]');
                    if (target && !target.isContentEditable) {
                        e.preventDefault(); e.stopPropagation();
                        this.makeTextEditable(target);
                    }
                }, true);
            },
            
            loadTexts() {
                database.ref('siteContent/elearning').once('value', snapshot => {
                    if (!snapshot.exists()) return;
                    const content = snapshot.val();
                    document.querySelectorAll('[data-editable-text]').forEach(el => {
                        const path = el.dataset.editableText.split('/');
                        let text = content;
                        try {
                            path.forEach(key => { text = text[key]; });
                            if (typeof text === 'string') el.innerHTML = text;
                        } catch (e) {}
                    });
                });
            },

            makeTextEditable(element) {
                if (this.currentEditingElement) this.cleanupEditingState();
                this.currentEditingElement = element;
                this.originalContent = element.innerHTML;
                element.contentEditable = true;
                element.classList.add('editing-now');
                element.focus();

                const toolbar = document.getElementById('text-editor-toolbar');
                document.body.appendChild(toolbar);
                const rect = element.getBoundingClientRect();
                toolbar.style.top = `${window.scrollY + rect.top - toolbar.offsetHeight - 5}px`;
                toolbar.style.left = `${window.scrollX + rect.left}px`;
                toolbar.style.display = 'flex';
                toolbar.querySelector('.save-text-btn').onclick = () => this.saveText();
                toolbar.querySelector('.cancel-text-btn').onclick = () => this.cancelText();
            },

            saveText() {
                const element = this.currentEditingElement;
                if (!element) return;
                const path = `siteContent/elearning/${element.dataset.editableText.replace(/\//g, '/')}`;
                database.ref(path).set(element.innerHTML)
                    .then(() => this.cleanupEditingState())
                    .catch(err => { alert("Errore salvataggio: " + err.message); this.cancelText(); });
            },

            cancelText() {
                if (this.currentEditingElement) this.currentEditingElement.innerHTML = this.originalContent;
                this.cleanupEditingState();
            },

            cleanupEditingState() {
                if (this.currentEditingElement) {
                    this.currentEditingElement.contentEditable = false;
                    this.currentEditingElement.classList.remove('editing-now');
                }
                document.getElementById('text-editor-toolbar').style.display = 'none';
                this.currentEditingElement = null;
            }
        };

        // --- UI HELPER FUNCTIONS ---
        function switchPage(targetId) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.sidebar a').forEach(a => a.classList.remove('active'));
            const targetPage = document.getElementById(targetId + '-page');
            const targetLink = document.querySelector(`a[data-target="${targetId}"]`);
            if (targetPage) targetPage.classList.add('active');
            if (targetLink) targetLink.classList.add('active');
        }

        function openModal(modal) { if (modal) { modal.style.display = 'flex'; body.classList.add('modal-open'); } }
        function closeModal(modal) { if (modal) { modal.style.display = 'none'; body.classList.remove('modal-open'); } }
    </script>
</body>
</html>