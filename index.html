<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DogWorld E-Learning - Piattaforma Educativa</title>
    <link rel="icon" type="image/png" href="/favicon-96x96.png" sizes="96x96" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <link rel="shortcut icon" href="/favicon.ico" />
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
    <meta name="apple-mobile-web-app-title" content="DogWorld E-Learning" />
    <link rel="manifest" href="/site.webmanifest" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <style>
        :root {
            --primary-color: #003B46;
            --secondary-color: #07575B;
            --accent-color: #66A5AD;
            --danger-color: #c94c4c;
            --success-color: #4caf50;
            --warning-color: #f0ad4e;
            --light-color: #FFFFFF;
            --dark-text: #333333;
            --light-text: #f4f4f4;
            --font-family: 'Montserrat', sans-serif;
            --star-color: #ffd700;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            overflow-x: hidden;
            scroll-behavior: smooth;
        }

        body {
            font-family: var(--font-family);
            background-color: var(--light-color);
            color: var(--dark-text);
        }

        body.modal-open, html.modal-open {
            overflow: hidden;
        }

        .page-container {
            display: flex;
            min-height: 100vh;
            transition: margin-left .3s;
        }

        h1, h2, h3, h4 {
            color: var(--primary-color);
            font-weight: 700;
            margin-bottom: 1rem;
        }

        p {
            line-height: 1.6;
            margin-bottom: 1rem;
        }

        a {
            color: var(--secondary-color);
            text-decoration: none;
        }

        button {
            font-family: var(--font-family);
        }

        .page {
            display: none;
            padding: 40px;
            animation: fadeIn 0.5s;
        }

        .page.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* Sidebar Styles */
        .sidebar {
            height: 100vh;
            width: 250px;
            position: fixed;
            top: 0;
            left: 0;
            background-color: var(--primary-color);
            color: var(--light-text);
            padding-top: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            z-index: 100;
        }

        .sidebar-header {
            text-align: center;
            margin-bottom: 15px;
            padding: 0 10px;
            flex-shrink: 0;
        }

        .sidebar-header .logo {
            width: 200px;
            height: auto;
            margin-bottom: 10px;
        }

        .sidebar-header .sidebar-title-group {
            display: none;
        }

        .sidebar-header h2 {
            color: var(--light-color);
            font-size: 1.2em;
            margin-bottom: 0.5rem;
        }

        .sidebar-header p {
            font-size: 0.9em;
            color: var(--accent-color);
        }

        .sidebar ul {
            list-style-type: none;
            width: 100%;
            padding-top: 15px;
            overflow-y: auto;
            flex-grow: 1;
        }

        .sidebar ul li a {
            display: flex;
            align-items: center;
            justify-content: flex-start;
            padding: 15px 25px;
            color: var(--light-text);
            transition: background-color 0.3s, padding-left 0.3s;
            cursor: pointer;
            position: relative;
        }

        .sidebar ul li a .fas {
            margin-right: 15px;
            width: 20px;
            text-align: center;
        }

        .sidebar ul li a:hover, .sidebar ul li a.active {
            background-color: var(--secondary-color);
            padding-left: 35px;
        }

        /* Content Area */
        .content {
            margin-left: 250px;
            width: calc(100% - 250px);
            display: flex;
            flex-direction: column;
        }

        .main-content {
            flex-grow: 1;
        }

        section {
            margin-bottom: 50px;
            padding: 20px;
            border-radius: 8px;
            background: #fdfdfd;
        }

        /* Admin Controls */
        .admin-only {
            display: none;
        }

        body.admin-mode .admin-only {
            display: block;
        }

        .admin-controls {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.7);
            border-radius: 5px;
            padding: 5px;
            display: none;
            gap: 5px;
        }

        body.admin-mode .admin-controls {
            display: flex !important;
        }

        .admin-btn {
            background: none;
            border: none;
            color: white;
            font-size: 16px;
            cursor: pointer;
            padding: 5px;
            border-radius: 3px;
            transition: background-color 0.2s;
        }

        .admin-btn:hover {
            background-color: rgba(255, 255, 255, 0.2);
        }

        .drag-handle {
            position: absolute;
            top: 5px;
            left: 5px;
            background: rgba(0, 59, 70, 0.7);
            color: white;
            border: none;
            border-radius: 3px;
            padding: 5px;
            cursor: move;
            font-size: 14px;
        }

        /* Course Cards */
        .courses-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .course-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            position: relative;
        }

        .course-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }

        .course-thumbnail {
            width: 100%;
            height: 200px;
            object-fit: cover;
        }

        .course-content {
            padding: 20px;
        }

        .course-title {
            font-size: 1.3em;
            font-weight: 600;
            color: var(--primary-color);
            margin-bottom: 10px;
        }

        .course-description {
            color: #666;
            font-size: 0.9em;
            margin-bottom: 15px;
            line-height: 1.5;
        }

        .course-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            font-size: 0.8em;
            color: #888;
        }

        .course-difficulty {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.7em;
            font-weight: 600;
            text-transform: uppercase;
        }

        .difficulty-beginner {
            background: #e8f5e8;
            color: #2e7d32;
        }

        .difficulty-intermediate {
            background: #fff3e0;
            color: #f57c00;
        }

        .difficulty-advanced {
            background: #ffebee;
            color: #c62828;
        }

        .course-progress {
            width: 100%;
            height: 6px;
            background: #e0e0e0;
            border-radius: 3px;
            margin-bottom: 15px;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--accent-color), var(--secondary-color));
            border-radius: 3px;
            transition: width 0.3s ease;
        }

        .course-actions {
            display: flex;
            gap: 10px;
        }

        .btn-primary {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: background-color 0.3s;
            flex: 1;
        }

        .btn-primary:hover {
            background: var(--secondary-color);
        }

        .btn-secondary {
            background: transparent;
            color: var(--primary-color);
            border: 2px solid var(--primary-color);
            padding: 8px 18px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .btn-secondary:hover {
            background: var(--primary-color);
            color: white;
        }

        /* Video Player */
        .video-player-container {
            position: relative;
            width: 100%;
            max-width: 800px;
            margin: 0 auto;
            background: #000;
            border-radius: 8px;
            overflow: hidden;
        }

        .video-player {
            width: 100%;
            height: auto;
        }

        .video-controls {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(transparent, rgba(0, 0, 0, 0.7));
            padding: 20px;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .play-pause-btn {
            background: none;
            border: none;
            color: white;
            font-size: 20px;
            cursor: pointer;
        }

        .progress-container {
            flex: 1;
            height: 6px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 3px;
            cursor: pointer;
        }

        .progress-filled {
            height: 100%;
            background: var(--accent-color);
            border-radius: 3px;
            transition: width 0.1s;
        }

        .time-display {
            color: white;
            font-size: 0.9em;
            min-width: 80px;
        }

        /* Quiz Styles */
        .quiz-container {
            max-width: 600px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .question {
            margin-bottom: 30px;
        }

        .question-text {
            font-size: 1.2em;
            font-weight: 600;
            margin-bottom: 20px;
            color: var(--primary-color);
        }

        .answer-option {
            display: flex;
            align-items: center;
            padding: 15px;
            margin-bottom: 10px;
            background: #f8f9fa;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .answer-option:hover {
            background: #e9ecef;
        }

        .answer-option.selected {
            background: var(--accent-color);
            color: white;
        }

        .answer-option input[type="radio"] {
            margin-right: 15px;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.8);
            animation: fadeIn 0.3s;
        }

        .modal-content-wrapper {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100%;
            padding: 20px;
        }

        .modal-content {
            margin: auto;
            display: block;
            position: relative;
            background-color: #fefefe;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            max-width: 700px;
            border-radius: 8px;
        }

        .close-btn {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close-btn:hover {
            color: black;
        }

        /* Form Styles */
        .form-container {
            max-width: 500px;
            margin: 0 auto;
        }

        .form-container input,
        .form-container select,
        .form-container textarea {
            width: 100%;
            padding: 12px;
            margin-bottom: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-family: var(--font-family);
        }

        .form-container label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            font-size: 0.9em;
        }

        .form-container button {
            padding: 12px 25px;
            background-color: var(--primary-color);
            color: var(--light-color);
            border: none;
            cursor: pointer;
            border-radius: 5px;
            transition: background-color 0.3s;
            width: 100%;
        }

        .form-container button:hover {
            background-color: var(--secondary-color);
        }

        /* Registration Request Cards */
        .registration-requests {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
        }

        .request-card {
            background: #fafafa;
            border: 1px solid #eee;
            border-left: 5px solid var(--accent-color);
            border-radius: 8px;
            padding: 20px;
            position: relative;
        }

        .request-card.pending {
            border-left-color: var(--warning-color);
        }

        .request-card.approved {
            border-left-color: var(--success-color);
        }

        .request-card.rejected {
            border-left-color: var(--danger-color);
        }

        .request-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .btn-approve {
            background: var(--success-color);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
        }

        .btn-reject {
            background: var(--danger-color);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
        }

        /* Responsive Design */
        @media (max-width: 992px) {
            .page-container {
                flex-direction: column;
            }

            .sidebar {
                width: 100%;
                height: auto;
                position: relative;
                padding-top: 10px;
                padding-bottom: 10px;
            }

            .sidebar-header {
                display: flex;
                align-items: center;
                justify-content: center;
                margin-bottom: 10px;
                padding: 0 10px;
            }

            .sidebar-header .logo {
                width: 50px;
                height: auto;
                margin-bottom: 0;
                margin-right: 15px;
            }

            .sidebar-header .sidebar-title-group {
                display: block;
            }

            .sidebar ul {
                display: flex;
                flex-wrap: wrap;
                justify-content: center;
                padding-top: 0;
                overflow-y: visible;
            }

            .sidebar ul li {
                margin: 5px;
            }

            .sidebar ul li a {
                padding: 10px 15px;
                border-radius: 5px;
                background-color: rgba(255, 255, 255, 0.1);
            }

            .sidebar ul li a:hover,
            .sidebar ul li a.active {
                padding-left: 15px;
                background-color: var(--secondary-color);
            }

            .content {
                margin-left: 0;
                width: 100%;
            }

            .courses-grid {
                grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            }
        }

        @media (max-width: 768px) {
            .page {
                padding: 20px;
            }

            .courses-grid {
                grid-template-columns: 1fr;
            }

            .registration-requests {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="page-container">
        <!-- Sidebar Navigation -->
        <nav class="sidebar">
            <div class="sidebar-header">
                <img src="/images/logo-dogworld-chiaro.png" alt="DogWorld Logo" class="logo">
                <div class="sidebar-title-group">
                    <h2>E-Learning</h2>
                    <p>Piattaforma Educativa</p>
                </div>
            </div>
            <ul>
                <li><a href="#" data-target="dashboard" class="active"><i class="fas fa-tachometer-alt"></i> Dashboard</a></li>
                <li><a href="#" data-target="courses"><i class="fas fa-graduation-cap"></i> I Miei Corsi</a></li>
                <li><a href="#" data-target="catalog"><i class="fas fa-book"></i> Catalogo Corsi</a></li>
                <li><a href="#" data-target="progress"><i class="fas fa-chart-line"></i> Progressi</a></li>
                <li><a href="#" data-target="certificates"><i class="fas fa-certificate"></i> Certificati</a></li>
                <li class="admin-only"><a href="#" data-target="admin-courses"><i class="fas fa-cog"></i> Gestione Corsi</a></li>
                <li class="admin-only"><a href="#" data-target="administration"><i class="fas fa-users-cog"></i> Amministrazione</a></li>
                <li><a href="#" data-target="support"><i class="fas fa-life-ring"></i> Supporto</a></li>
            </ul>
        </nav>

        <!-- Main Content Area -->
        <div class="content">
            <main class="main-content">
                <!-- Dashboard Page -->
                <div id="dashboard-page" class="page active">
                    <section>
                        <h1>Benvenuto nella Piattaforma E-Learning DogWorld</h1>
                        <p>Accedi ai migliori corsi di formazione cinofila, impara dalle tecniche più avanzate e ottieni certificazioni riconosciute nel settore.</p>
                        
                        <div class="dashboard-stats" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin: 30px 0;">
                            <div style="background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)); color: white; padding: 20px; border-radius: 12px; text-align: center;">
                                <i class="fas fa-graduation-cap" style="font-size: 2em; margin-bottom: 10px;"></i>
                                <h3 style="color: white; margin-bottom: 5px;">3</h3>
                                <p style="margin: 0; opacity: 0.9;">Corsi Attivi</p>
                            </div>
                            <div style="background: linear-gradient(135deg, var(--accent-color), var(--secondary-color)); color: white; padding: 20px; border-radius: 12px; text-align: center;">
                                <i class="fas fa-clock" style="font-size: 2em; margin-bottom: 10px;"></i>
                                <h3 style="color: white; margin-bottom: 5px;">24h</h3>
                                <p style="margin: 0; opacity: 0.9;">Tempo di Studio</p>
                            </div>
                            <div style="background: linear-gradient(135deg, var(--success-color), #66bb6a); color: white; padding: 20px; border-radius: 12px; text-align: center;">
                                <i class="fas fa-trophy" style="font-size: 2em; margin-bottom: 10px;"></i>
                                <h3 style="color: white; margin-bottom: 5px;">2</h3>
                                <p style="margin: 0; opacity: 0.9;">Certificati</p>
                            </div>
                            <div style="background: linear-gradient(135deg, var(--warning-color), #ffb74d); color: white; padding: 20px; border-radius: 12px; text-align: center;">
                                <i class="fas fa-chart-line" style="font-size: 2em; margin-bottom: 10px;"></i>
                                <h3 style="color: white; margin-bottom: 5px;">78%</h3>
                                <p style="margin: 0; opacity: 0.9;">Progresso Medio</p>
                            </div>
                        </div>

                        <h3>Continua i tuoi studi</h3>
                        <div class="courses-grid">
                            <div class="course-card">
                                <img src="/images/corso-base-educazione.jpg" alt="Corso Base Educazione" class="course-thumbnail">
                                <div class="course-content">
                                    <h4 class="course-title">Educazione di Base del Cane</h4>
                                    <p class="course-description">Impara i fondamenti dell'educazione canina con tecniche moderne e rispettose.</p>
                                    <div class="course-meta">
                                        <span>8 lezioni</span>
                                        <span class="course-difficulty difficulty-beginner">Principiante</span>
                                    </div>
                                    <div class="course-progress">
                                        <div class="progress-bar" style="width: 65%;"></div>
                                    </div>
                                    <div class="course-actions">
                                        <button class="btn-primary">Continua</button>
                                    </div>
                                </div>
                            </div>

                            <div class="course-card">
                                <img src="/images/corso-agility.jpg" alt="Corso Agility" class="course-thumbnail">
                                <div class="course-content">
                                    <h4 class="course-title">Agility per Principianti</h4>
                                    <p class="course-description">Introduzione al mondo dell'agility: ostacoli, tecniche e preparazione atletica.</p>
                                    <div class="course-meta">
                                        <span>12 lezioni</span>
                                        <span class="course-difficulty difficulty-intermediate">Intermedio</span>
                                    </div>
                                    <div class="course-progress">
                                        <div class="progress-bar" style="width: 30%;"></div>
                                    </div>
                                    <div class="course-actions">
                                        <button class="btn-primary">Continua</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </section>
                </div>

                <!-- Courses Page -->
                <div id="courses-page" class="page">
                    <section>
                        <h1>I Miei Corsi</h1>
                        <p>Gestisci i tuoi corsi attivi e monitora i progressi di apprendimento.</p>
                        
                        <div class="courses-grid" id="my-courses-container">
                            <!-- I corsi verranno caricati dinamicamente qui -->
                        </div>
                    </section>
                </div>

                <!-- Course Catalog Page -->
                <div id="catalog-page" class="page">
                    <section>
                        <h1>Catalogo Corsi</h1>
                        <p>Esplora tutti i corsi disponibili e iscriviti a quelli che ti interessano.</p>
                        
                        <div class="filter-bar" style="margin-bottom: 30px; display: flex; gap: 15px; flex-wrap: wrap;">
                            <select id="difficulty-filter" style="padding: 8px; border-radius: 5px; border: 1px solid #ddd;">
                                <option value="">Tutti i livelli</option>
                                <option value="beginner">Principiante</option>
                                <option value="intermediate">Intermedio</option>
                                <option value="advanced">Avanzato</option>
                            </select>
                            <select id="category-filter" style="padding: 8px; border-radius: 5px; border: 1px solid #ddd;">
                                <option value="">Tutte le categorie</option>
                                <option value="education">Educazione</option>
                                <option value="agility">Agility</option>
                                <option value="behavior">Comportamento</option>
                                <option value="health">Salute</option>
                            </select>
                            <input type="text" id="search-courses" placeholder="Cerca corsi..." style="padding: 8px; border-radius: 5px; border: 1px solid #ddd; flex: 1; min-width: 200px;">
                        </div>
                        
                        <div class="courses-grid" id="catalog-courses-container">
                            <!-- Il catalogo corsi verrà caricato dinamicamente qui -->
                        </div>
                    </section>
                </div>

                <!-- Progress Page -->
                <div id="progress-page" class="page">
                    <section>
                        <h1>I Tuoi Progressi</h1>
                        <p>Monitora i tuoi progressi di apprendimento e le statistiche di studio.</p>
                        
                        <div id="progress-charts">
                            <!-- Grafici e statistiche verranno inseriti qui -->
                        </div>
                    </section>
                </div>

                <!-- Certificates Page -->
                <div id="certificates-page" class="page">
                    <section>
                        <h1>I Tuoi Certificati</h1>
                        <p>Visualizza e scarica i certificati ottenuti completando i corsi.</p>
                        
                        <div id="certificates-container">
                            <!-- I certificati verranno caricati dinamicamente qui -->
                        </div>
                    </section>
                </div>

                <!-- Admin Courses Page -->
                <div id="admin-courses-page" class="page admin-only">
                    <section>
                        <h1>Gestione Corsi</h1>
                        <p>Crea, modifica e gestisci i corsi della piattaforma.</p>
                        
                        <button id="add-course-btn" class="btn-primary" style="margin-bottom: 20px;">
                            <i class="fas fa-plus"></i> Aggiungi Nuovo Corso
                        </button>
                        
                        <div id="admin-courses-container">
                            <!-- I corsi per admin verranno caricati qui -->
                        </div>
                    </section>
                </div>

                <!-- Administration Page -->
                <div id="administration-page" class="page admin-only">
                    <section>
                        <h1>Amministrazione</h1>
                        <p>Gestisci le richieste di registrazione e le impostazioni della piattaforma.</p>
                        
                        <h3>Richieste di Registrazione Pending</h3>
                        <div class="registration-requests" id="registration-requests-container">
                            <!-- Le richieste verranno caricate dinamicamente qui -->
                        </div>
                    </section>
                </div>

                <!-- Support Page -->
                <div id="support-page" class="page">
                    <section>
                        <h1>Supporto</h1>
                        <p>Hai bisogno di aiuto? Contattaci o consulta le domande frequenti.</p>
                        
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 30px;">
                            <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                                <h3><i class="fas fa-envelope"></i> Contatta il Supporto</h3>
                                <p>Per assistenza tecnica o domande sui corsi:</p>
                                <a href="mailto:info.ilmondodelcane@gmail.com" style="color: var(--primary-color); font-weight: 600;">info.ilmondodelcane@gmail.com</a>
                            </div>
                            
                            <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                                <h3><i class="fas fa-globe"></i> Sito Principale</h3>
                                <p>Visita il sito principale DogWorld:</p>
                                <a href="https://ilmondodelcane.net" target="_blank" style="color: var(--primary-color); font-weight: 600;">ilmondodelcane.net</a>
                            </div>
                        </div>
                    </section>
                </div>
            </main>
        </div>
    </div>

    <!-- Login Modal -->
    <div id="login-modal" class="modal">
        <div class="modal-content-wrapper">
            <div class="modal-content">
                <span class="close-btn" data-modal-id="login-modal">×</span>
                <h3>Accesso Studente</h3>
                <form id="student-login-form" class="form-container">
                    <input type="email" id="student-email" placeholder="Email" required>
                    <input type="password" id="student-password" placeholder="Password" required>
                    <button type="submit">Accedi</button>
                </form>
                <p style="text-align: center; margin-top: 15px;">
                    Non hai un account? <a href="#" id="show-register-form">Registrati qui</a>
                </p>
            </div>
        </div>
    </div>

    <!-- Registration Modal -->
    <div id="registration-modal" class="modal">
        <div class="modal-content-wrapper">
            <div class="modal-content">
                <span class="close-btn" data-modal-id="registration-modal">×</span>
                <h3>Registrazione Studente</h3>
                <p>Compila il form per richiedere l'accesso alla piattaforma. La tua richiesta verrà valutata dall'amministratore.</p>
                <form id="student-registration-form" class="form-container">
                    <label for="reg-firstName">Nome</label>
                    <input type="text" id="reg-firstName" required>
                    
                    <label for="reg-lastName">Cognome</label>
                    <input type="text" id="reg-lastName" required>
                    
                    <label for="reg-email">Indirizzo Email</label>
                    <input type="email" id="reg-email" required>
                    
                    <label for="reg-phone">Numero di Telefono</label>
                    <input type="tel" id="reg-phone" required>
                    
                    <label for="reg-associatedId">ID Associato</label>
                                 <input type="text" id="reg-associatedId" placeholder="ID Associato (opzionale)">
                    
                    <input type="password" id="reg-password" placeholder="Password" required>
                    
                    <button type="submit">Invia Richiesta</button>>
                </form>
                <p style="text-align: center; margin-top: 15px;">
                    Hai già un account? <a href="#" id="show-login-form">Accedi qui</a>
                </p>
            </div>
        </div>
    </div>

    <!-- Course Modal -->
    <div id="course-modal" class="modal">
        <div class="modal-content-wrapper">
            <div class="modal-content" style="max-width: 900px;">
                <span class="close-btn" data-modal-id="course-modal">×</span>
                <div id="course-modal-content">
                    <!-- Il contenuto del corso verrà caricato dinamicamente qui -->
                </div>
            </div>
        </div>
    </div>

    <!-- Video Player Modal -->
    <div id="video-modal" class="modal">
        <div class="modal-content-wrapper">
            <div class="modal-content" style="max-width: 1000px; padding: 0;">
                <span class="close-btn" data-modal-id="video-modal" style="position: absolute; top: 10px; right: 15px; z-index: 10; color: white;">×</span>
                <div class="video-player-container">
                    <video id="course-video" class="video-player" controls>
                        <source src="" type="video/mp4">
                        Il tuo browser non supporta il tag video.
                    </video>
                </div>
            </div>
        </div>
    </div>

    <!-- Course Creator Modal -->
    <div id="course-creator-modal" class="modal">
        <div class="modal-content-wrapper">
            <div class="modal-content" style="max-width: 1200px;">
                <span class="close-btn" data-modal-id="course-creator-modal">×</span>
                <h2>Crea Nuovo Corso</h2>
                
                <form id="course-creation-form">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                        <div>
                            <label for="course-title">Titolo del Corso</label>
                            <input type="text" id="course-title" required>
                        </div>
                        <div>
                            <label for="course-category">Categoria</label>
                            <select id="course-category" required>
                                <option value="">Seleziona categoria...</option>
                                <option value="educazione">Educazione</option>
                                <option value="agility">Agility</option>
                                <option value="comportamento">Comportamento</option>
                                <option value="salute">Salute</option>
                            </select>
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                        <div>
                            <label for="course-level">Livello</label>
                            <select id="course-level" required>
                                <option value="">Seleziona livello...</option>
                                <option value="principiante">Principiante</option>
                                <option value="intermedio">Intermedio</option>
                                <option value="avanzato">Avanzato</option>
                            </select>
                        </div>
                        <div>
                            <label for="course-duration">Durata (ore)</label>
                            <input type="number" id="course-duration" min="1" required>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <label for="course-description">Descrizione</label>
                        <textarea id="course-description" rows="4" required></textarea>
                    </div>
                    
                    <h3>Selezione Contenuti da Google Drive</h3>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                        <div>
                            <label for="course-folder-select">Cartella Progetto</label>
                            <select id="course-folder-select" onchange="loadLessonFolders(this.value)">
                                <option value="">Caricamento cartelle...</option>
                            </select>
                        </div>
                        <div>
                            <label for="lesson-folder-select">Cartella Lezione</label>
                            <select id="lesson-folder-select" onchange="loadLessonFiles(this.value)">
                                <option value="">Prima seleziona un progetto...</option>
                            </select>
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                        <div>
                            <h4>Video Disponibili</h4>
                            <div id="video-files-list" style="max-height: 200px; overflow-y: auto; border: 1px solid #ddd; padding: 10px; border-radius: 4px;">
                                <p>Seleziona una cartella lezione per vedere i video disponibili.</p>
                            </div>
                        </div>
                        <div>
                            <h4>PDF Disponibili</h4>
                            <div id="pdf-files-list" style="max-height: 200px; overflow-y: auto; border: 1px solid #ddd; padding: 10px; border-radius: 4px;">
                                <p>Seleziona una cartella lezione per vedere i PDF disponibili.</p>
                            </div>
                        </div>
                    </div>
                    
                    <div style="text-align: right;">
                        <button type="button" onclick="closeModal(document.getElementById('course-creator-modal'))" style="background: #ccc; color: #333; border: none; padding: 10px 20px; border-radius: 4px; margin-right: 10px;">
                            Annulla
                        </button>
                        <button type="submit" style="background: var(--primary-color); color: white; border: none; padding: 10px 20px; border-radius: 4px;">
                            Crea Corso
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Admin Registration Requests Modal -->
    <div id="admin-requests-modal" class="modal">
        <div class="modal-content-wrapper">
            <div class="modal-content" style="max-width: 800px;">
                <span class="close-btn" data-modal-id="admin-requests-modal">×</span>
                <h2>Gestione Richieste di Registrazione</h2>
                
                <div id="pending-registrations" style="max-height: 500px; overflow-y: auto;">
                    <!-- Le richieste verranno caricate dinamicamente qui -->
                </div>
            </div>
        </div>
    </div>

    <!-- Google Drive File Selector Modal -->
    <div id="drive-selector-modal" class="modal">
        <div class="modal-content-wrapper">
            <div class="modal-content" style="max-width: 900px;">
                <span class="close-btn" data-modal-id="drive-selector-modal">×</span>
                <h2>Seleziona File da Google Drive</h2>
                
                <div style="margin-bottom: 20px;">
                    <button id="drive-auth-btn" onclick="driveManager.signIn()" style="background: #4285f4; color: white; border: none; padding: 10px 20px; border-radius: 4px;">
                        <i class="fab fa-google-drive"></i> Accedi a Google Drive
                    </button>
                </div>
                
                <div id="drive-file-browser" style="display: none;">
                    <div style="margin-bottom: 15px;">
                        <label for="drive-folder-nav">Naviga nelle cartelle:</label>
                        <select id="drive-folder-nav" onchange="navigateToFolder(this.value)">
                            <option value="">Root</option>
                        </select>
                    </div>
                    
                    <div id="drive-files-list" style="max-height: 400px; overflow-y: auto; border: 1px solid #ddd; padding: 15px; border-radius: 4px;">
                        <!-- I file verranno caricati qui -->
                    </div>
                    
                    <div style="text-align: right; margin-top: 15px;">
                        <button onclick="confirmFileSelection()" style="background: var(--primary-color); color: white; border: none; padding: 10px 20px; border-radius: 4px;">
                            Conferma Selezione
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer style="background: var(--primary-color); color: var(--light-text); text-align: center; padding: 20px; margin-top: 50px;">
        <p><strong>DogWorld E-Learning Platform</strong></p>
        <p>© 2024 DogWorld - Il Mondo del Cane. Tutti i diritti riservati.</p>
        <div style="margin-top: 10px;">
            <button id="student-login-btn" style="background: var(--accent-color); color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer; margin-right: 10px;">
                <i class="fas fa-sign-in-alt"></i> Accedi
            </button>
            <button id="admin-login-btn" style="background: var(--secondary-color); color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer;">
                <i class="fas fa-user-shield"></i> Admin
            </button>
        </div>
    </footer>

       <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>
    
    <!-- Google Drive API -->
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://accounts.google.com/gsi/client"></script>

    <script>
        // Firebase Configuration - DogWorld Project
        const firebaseConfig = {
            apiKey: "AIzaSyDygclohh3XpIOICCtyv6p_fZpevlCeRws",
            authDomain: "dogworld-f8518.firebaseapp.com",
            databaseURL: "https://dogworld-f8518-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "dogworld-f8518",
            storageBucket: "dogworld-f8518.firebasestorage.app",
            messagingSenderId: "193133250764",
            appId: "1:193133250764:web:d38fcf7d5a55c48fefda69"
        };

        // Google Drive API Configuration
        const GOOGLE_DRIVE_CONFIG = {
            apiKey: 'AIzaSyDygclohh3XpIOICCtyv6p_fZpevlCeRws', // Stessa API key di Firebase
            clientId: '193133250764-p4es0537ohak1vghbg027na263uplgce.apps.googleusercontent.com', // Da configurare
            discoveryDoc: 'https://www.googleapis.com/discovery/v1/apis/drive/v3/rest',
            scopes: 'https://www.googleapis.com/auth/drive.readonly'
        };

        // Admin emails list
        const ADMIN_EMAILS = [
            'biomario94@gmail.com',
            'info.ilmondodelcane@gmail.com'
        ];;

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const auth = firebase.auth();
        const storage = firebase.storage();

        // Global variables
        let currentUser = null;
        let isAdmin = false;

        // DOM elements
        const body = document.body;
        const studentLoginBtn = document.getElementById('student-login-btn');
        const adminLoginBtn = document.getElementById('admin-login-btn');
        const loginModal = document.getElementById('login-modal');
        const registrationModal = document.getElementById('registration-modal');

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
        });

        async function initializeApp() {
            // Set up navigation
            setupNavigation();
            
            // Set up modals
            setupModals();
            
            // Set up authentication
            setupAuthentication();
            
            // Load initial data
            await loadPublicData();
            
            console.log('E-Learning platform initialized');
        }

        function setupNavigation() {
            // Navigation click handlers
            document.querySelectorAll('.sidebar ul li a').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const target = e.currentTarget.getAttribute('data-target');
                    switchPage(target);
                });
            });
        }

        function switchPage(targetId) {
            // Hide all pages
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });
            
            // Remove active class from all nav links
            document.querySelectorAll('.sidebar ul li a').forEach(link => {
                link.classList.remove('active');
            });
            
            // Show target page
            const targetPage = document.getElementById(targetId + '-page');
            if (targetPage) {
                targetPage.classList.add('active');
            }
            
            // Add active class to clicked nav link
            const targetLink = document.querySelector(`a[data-target="${targetId}"]`);
            if (targetLink) {
                targetLink.classList.add('active');
            }
            
            // Scroll to top
            window.scrollTo(0, 0);
        }

        function setupModals() {
            // Modal close handlers
            document.querySelectorAll('.close-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const modal = e.currentTarget.closest('.modal');
                    closeModal(modal);
                });
            });

            // Modal background click to close
            document.querySelectorAll('.modal').forEach(modal => {
                modal.addEventListener('click', (e) => {
                    if (e.target === modal || e.target.classList.contains('modal-content-wrapper')) {
                        closeModal(modal);
                    }
                });
            });

            // Login/Registration form toggles
            document.getElementById('show-register-form').addEventListener('click', (e) => {
                e.preventDefault();
                closeModal(loginModal);
                openModal(registrationModal);
            });

            document.getElementById('show-login-form').addEventListener('click', (e) => {
                e.preventDefault();
                closeModal(registrationModal);
                openModal(loginModal);
            });
        }

        function setupAuthentication() {
            // Student login button
            studentLoginBtn.addEventListener('click', () => {
                openModal(loginModal);
            });

            // Admin login button (redirect to main site admin)
            adminLoginBtn.addEventListener('click', () => {
                window.open('https://ilmondodelcane.net', '_blank');
            });

            // Student login form
            document.getElementById('student-login-form').addEventListener('submit', handleStudentLogin);

            // Student registration form
            document.getElementById('student-registration-form').addEventListener('submit', handleStudentRegistration);

            // Auth state change listener
            auth.onAuthStateChanged(async (user) => {
                currentUser = user;
                if (user) {
                    await checkUserRole(user);
                    await loadUserProfile(user);
                }
                updateUIForAuthState();
            });
        }

        async function checkUserRole(user) {
            // Check if user is admin by email
            isAdmin = ADMIN_EMAILS.includes(user.email);
            
            if (isAdmin) {
                console.log('Admin user detected:', user.email);
                // Ensure admin record exists
                const adminRef = database.ref(`admins/${user.uid}`);
                const adminSnapshot = await adminRef.once('value');
                
                if (!adminSnapshot.exists()) {
                    await adminRef.set({
                        email: user.email,
                        role: 'admin',
                        createdAt: firebase.database.ServerValue.TIMESTAMP
                    });
                }
            }
        }

        async function loadUserProfile(user) {
            try {
                if (isAdmin) {
                    // Admin profile is minimal
                    return;
                }

                // Load student profile
                const userRef = database.ref(`elearningUsers/${user.uid}`);
                const snapshot = await userRef.once('value');
                
                if (snapshot.exists()) {
                    window.userProfile = snapshot.val();
                } else {
                    // Check if user has pending registration
                    await checkPendingRegistration(user.email);
                }
            } catch (error) {
                console.error('Error loading user profile:', error);
            }
        }

        async function checkPendingRegistration(email) {
            try {
                const requestsRef = database.ref('elearningRegistrationRequests');
                const snapshot = await requestsRef.orderByChild('userInfo/email').equalTo(email).once('value');
                
                if (snapshot.exists()) {
                    const requests = snapshot.val();
                    const requestId = Object.keys(requests)[0];
                    const request = requests[requestId];
                    
                    if (request.requestDetails && request.requestDetails.status === 'pending') {
                        window.userProfile = {
                            status: 'pending_approval',
                            requestId: requestId
                        };
                    }
                }
            } catch (error) {
                console.error('Error checking pending registration:', error);
            }
        }

        async function handleStudentLogin(e) {
            e.preventDefault();
            const email = document.getElementById('student-email').value;
            const password = document.getElementById('student-password').value;

            try {
                await auth.signInWithEmailAndPassword(email, password);
                closeModal(loginModal);
                
                // Check if user is approved student or admin
                if (isAdmin) {
                    alert('Benvenuto Admin!');
                } else if (window.userProfile && window.userProfile.accountStatus && window.userProfile.accountStatus.status === 'approved') {
                    alert('Login effettuato con successo!');
                } else {
                    alert('Il tuo account è in attesa di approvazione.');
                }
            } catch (error) {
                alert('Errore durante il login: ' + error.message);
            }
        }

        async function handleStudentRegistration(e) {
            e.preventDefault();
            
            const formData = {
                firstName: document.getElementById('reg-firstName').value,
                lastName: document.getElementById('reg-lastName').value,
                email: document.getElementById('reg-email').value,
                phone: document.getElementById('reg-phone').value,
                associatedId: document.getElementById('reg-associatedId').value,
                password: document.getElementById('reg-password').value || 'TempPassword123!' // Temporary password
            };

            try {
                // Create Firebase Auth user
                const userCredential = await auth.createUserWithEmailAndPassword(formData.email, formData.password);
                const user = userCredential.user;

                // Create registration request for admin approval
                const requestData = {
                    userInfo: {
                        uid: user.uid,
                        firstName: formData.firstName,
                        lastName: formData.lastName,
                        email: formData.email,
                        phoneNumber: formData.phone,
                        associatedId: formData.associatedId
                    },
                    requestDetails: {
                        status: 'pending',
                        submissionDate: firebase.database.ServerValue.TIMESTAMP,
                        ipAddress: await getUserIP()
                    }
                };

                // Save registration request
                const requestRef = database.ref('elearningRegistrationRequests').push();
                await requestRef.set(requestData);

                // Send notification email to admin
                await sendAdminNotification(requestData, requestRef.key);

                // Sign out user until approved
                await auth.signOut();

                closeModal(registrationModal);
                alert('Registrazione completata! La tua richiesta è stata inviata per approvazione.');

            } catch (error) {
                console.error('Registration error:', error);
                alert('Errore durante la registrazione: ' + error.message);
            }
        }

        async function getUserIP() {
            try {
                const response = await fetch('https://api.ipify.org?format=json');
                const data = await response.json();
                return data.ip;
            } catch (error) {
                return 'Unknown';
            }
        }

        // Google Drive Integration
        class GoogleDriveManager {
            constructor() {
                this.isInitialized = false;
                this.isSignedIn = false;
            }

            async initialize() {
                try {
                    await gapi.load('auth2', async () => {
                        await gapi.auth2.init({
                            client_id: GOOGLE_DRIVE_CONFIG.clientId
                        });
                        this.isInitialized = true;
                    });

                    await gapi.load('client', async () => {
                        await gapi.client.init({
                            apiKey: GOOGLE_DRIVE_CONFIG.apiKey,
                            discoveryDocs: [GOOGLE_DRIVE_CONFIG.discoveryDoc]
                        });
                    });

                    console.log('Google Drive API initialized');
                } catch (error) {
                    console.error('Error initializing Google Drive API:', error);
                }
            }

            async signIn() {
                if (!this.isInitialized) {
                    await this.initialize();
                }

                try {
                    const authInstance = gapi.auth2.getAuthInstance();
                    await authInstance.signIn();
                    this.isSignedIn = authInstance.isSignedIn.get();
                    return this.isSignedIn;
                } catch (error) {
                    console.error('Error signing in to Google Drive:', error);
                    return false;
                }
            }

            async listFiles(folderId = null, mimeType = null) {
                if (!this.isSignedIn) {
                    await this.signIn();
                }

                try {
                    let query = "trashed=false";
                    
                    if (folderId) {
                        query += ` and '${folderId}' in parents`;
                    }
                    
                    if (mimeType) {
                        query += ` and mimeType='${mimeType}'`;
                    }

                    const response = await gapi.client.drive.files.list({
                        q: query,
                        fields: 'files(id,name,mimeType,size,modifiedTime,webViewLink,webContentLink)',
                        orderBy: 'name'
                    });

                    return response.result.files;
                } catch (error) {
                    console.error('Error listing files:', error);
                    return [];
                }
            }

            async getFolders(parentId = null) {
                return await this.listFiles(parentId, 'application/vnd.google-apps.folder');
            }

            async getVideoFiles(folderId = null) {
                const videoMimeTypes = ['video/mp4', 'video/webm', 'video/ogg'];
                let allVideos = [];

                for (const mimeType of videoMimeTypes) {
                    const videos = await this.listFiles(folderId, mimeType);
                    allVideos = allVideos.concat(videos);
                }

                return allVideos;
            }

            async getPDFFiles(folderId = null) {
                return await this.listFiles(folderId, 'application/pdf');
            }

            getDirectLink(fileId) {
                return `https://drive.google.com/file/d/${fileId}/view`;
            }

            getDownloadLink(fileId) {
                return `https://drive.google.com/uc?export=download&id=${fileId}`;
            }

            getEmbedLink(fileId) {
                return `https://drive.google.com/file/d/${fileId}/preview`;
            }
        }

        // Initialize Google Drive Manager
        const driveManager = new GoogleDriveManager();

        // Admin Panel Functions
        async function loadAdminPanel() {
            if (!isAdmin) {
                alert('Accesso negato: solo gli admin possono accedere a questa sezione.');
                return;
            }

            try {
                await loadPendingRegistrations();
                await loadAllStudents();
                await loadCourseManagement();
            } catch (error) {
                console.error('Error loading admin panel:', error);
            }
        }

        async function loadPendingRegistrations() {
            const container = document.getElementById('pending-registrations');
            if (!container) return;

            try {
                const snapshot = await database.ref('elearningRegistrationRequests')
                    .orderByChild('requestDetails/status')
                    .equalTo('pending')
                    .once('value');

                const requests = snapshot.val();
                container.innerHTML = '';

                if (!requests) {
                    container.innerHTML = '<p>Nessuna richiesta in attesa.</p>';
                    return;
                }

                Object.entries(requests).forEach(([requestId, request]) => {
                    const requestElement = createRegistrationRequestElement(requestId, request);
                    container.appendChild(requestElement);
                });

            } catch (error) {
                console.error('Error loading pending registrations:', error);
                container.innerHTML = '<p>Errore nel caricamento delle richieste.</p>';
            }
        }

        function createRegistrationRequestElement(requestId, request) {
            const div = document.createElement('div');
            div.className = 'registration-request-card';
            div.innerHTML = `
                <div class="request-header">
                    <h4>${request.userInfo.firstName} ${request.userInfo.lastName}</h4>
                    <span class="request-date">${new Date(request.requestDetails.submissionDate).toLocaleDateString()}</span>
                </div>
                <div class="request-details">
                    <p><strong>Email:</strong> ${request.userInfo.email}</p>
                    <p><strong>Telefono:</strong> ${request.userInfo.phoneNumber}</p>
                    <p><strong>ID Associato:</strong> ${request.userInfo.associatedId || 'Non specificato'}</p>
                </div>
                <div class="request-actions">
                    <button class="btn btn-success" onclick="approveStudent('${requestId}')">
                        Approva
                    </button>
                    <button class="btn btn-danger" onclick="rejectStudent('${requestId}')">
                        Rifiuta
                    </button>
                </div>
            `;
            return div;
        }

        async function approveStudent(requestId) {
            if (!confirm('Sei sicuro di voler approvare questo studente?')) return;

            try {
                const requestRef = database.ref(`elearningRegistrationRequests/${requestId}`);
                const snapshot = await requestRef.once('value');
                const requestData = snapshot.val();

                if (!requestData) {
                    alert('Richiesta non trovata');
                    return;
                }

                // Create student profile
                const studentData = {
                    personalInfo: {
                        firstName: requestData.userInfo.firstName,
                        lastName: requestData.userInfo.lastName,
                        email: requestData.userInfo.email,
                        phoneNumber: requestData.userInfo.phoneNumber,
                        associatedId: requestData.userInfo.associatedId
                    },
                    accountStatus: {
                        status: 'approved',
                        approvedBy: currentUser.email,
                        approvedAt: firebase.database.ServerValue.TIMESTAMP
                    },
                    learningProgress: {
                        enrolledCourses: {},
                        completedCourses: {},
                        certificates: {},
                        totalStudyTime: 0
                    },
                    createdAt: firebase.database.ServerValue.TIMESTAMP
                };

                // Save student profile
                await database.ref(`elearningUsers/${requestData.userInfo.uid}`).set(studentData);

                // Update request status
                await requestRef.update({
                    'requestDetails/status': 'approved',
                    'requestDetails/approvedBy': currentUser.email,
                    'requestDetails/approvedAt': firebase.database.ServerValue.TIMESTAMP
                });

                // Send approval email
                await sendApprovalEmail(requestData.userInfo);

                alert('Studente approvato con successo!');
                await loadPendingRegistrations(); // Refresh the list

            } catch (error) {
                console.error('Error approving student:', error);
                alert('Errore durante l\'approvazione: ' + error.message);
            }
        }

        async function rejectStudent(requestId) {
            const reason = prompt('Motivo del rifiuto (opzionale):');
            if (reason === null) return; // User cancelled

            try {
                const requestRef = database.ref(`elearningRegistrationRequests/${requestId}`);
                const snapshot = await requestRef.once('value');
                const requestData = snapshot.val();

                if (!requestData) {
                    alert('Richiesta non trovata');
                    return;
                }

                // Update request status
                await requestRef.update({
                    'requestDetails/status': 'rejected',
                    'requestDetails/rejectedBy': currentUser.email,
                    'requestDetails/rejectedAt': firebase.database.ServerValue.TIMESTAMP,
                    'requestDetails/rejectionReason': reason
                });

                // Send rejection email
                await sendRejectionEmail(requestData.userInfo, reason);

                alert('Richiesta rifiutata.');
                await loadPendingRegistrations(); // Refresh the list

            } catch (error) {
                console.error('Error rejecting student:', error);
                alert('Errore durante il rifiuto: ' + error.message);
            }
        }

        // Course Management Functions
        async function openCourseCreator() {
            if (!isAdmin) {
                alert('Accesso negato: solo gli admin possono creare corsi.');
                return;
            }

            // Initialize Google Drive if not already done
            if (!driveManager.isInitialized) {
                await driveManager.initialize();
            }

            const modal = document.getElementById('course-creator-modal');
            if (modal) {
                openModal(modal);
                await loadDriveFolders();
            }
        }

        async function loadDriveFolders() {
            try {
                const folders = await driveManager.getFolders();
                const folderSelect = document.getElementById('course-folder-select');
                
                if (folderSelect) {
                    folderSelect.innerHTML = '<option value="">Seleziona cartella progetto...</option>';
                    
                    folders.forEach(folder => {
                        const option = document.createElement('option');
                        option.value = folder.id;
                        option.textContent = folder.name;
                        folderSelect.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Error loading Drive folders:', error);
                alert('Errore nel caricamento delle cartelle Google Drive. Assicurati di aver effettuato l\'accesso.');
            }
        }

        async function loadLessonFolders(projectFolderId) {
            try {
                const lessonFolders = await driveManager.getFolders(projectFolderId);
                const lessonSelect = document.getElementById('lesson-folder-select');
                
                if (lessonSelect) {
                    lessonSelect.innerHTML = '<option value="">Seleziona cartella lezione...</option>';
                    
                    lessonFolders.forEach(folder => {
                        const option = document.createElement('option');
                        option.value = folder.id;
                        option.textContent = folder.name;
                        lessonSelect.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Error loading lesson folders:', error);
            }
        }

        async function loadLessonFiles(lessonFolderId) {
            try {
                const [videos, pdfs] = await Promise.all([
                    driveManager.getVideoFiles(lessonFolderId),
                    driveManager.getPDFFiles(lessonFolderId)
                ]);

                displayFileSelection('video-files-list', videos, 'video');
                displayFileSelection('pdf-files-list', pdfs, 'pdf');

            } catch (error) {
                console.error('Error loading lesson files:', error);
            }
        }

        function displayFileSelection(containerId, files, fileType) {
            const container = document.getElementById(containerId);
            if (!container) return;

            container.innerHTML = '';

            if (files.length === 0) {
                container.innerHTML = `<p>Nessun file ${fileType} trovato in questa cartella.</p>`;
                return;
            }

            files.forEach(file => {
                const fileElement = document.createElement('div');
                fileElement.className = 'file-selection-item';
                fileElement.innerHTML = `
                    <input type="checkbox" id="file-${file.id}" value="${file.id}" data-name="${file.name}">
                    <label for="file-${file.id}">
                        <span class="file-name">${file.name}</span>
                        <span class="file-size">${formatFileSize(file.size)}</span>
                    </label>
                `;
                container.appendChild(fileElement);
            });
        }

        function formatFileSize(bytes) {
            if (!bytes) return 'N/A';
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(1024));
            return Math.round(bytes / Math.pow(1024, i) * 100) / 100 + ' ' + sizes[i];
        }

        async function sendAdminNotification(requestData, requestId) {
            try {
                const emailData = {
                    type: 'Nuova Richiesta Registrazione E-Learning',
                    requestId: requestId,
                    userInfo: requestData.userInfo,
                    adminEmails: ADMIN_EMAILS
                };

                await fetch('/.netlify/functions/elearning-send-notification', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(emailData)
                });
            } catch (error) {
                console.error('Error sending admin notification:', error);
            }
        }

        async function sendApprovalEmail(userInfo) {
            try {
                const emailData = {
                    type: 'Approvazione Registrazione E-Learning',
                    recipientEmail: userInfo.email,
                    recipientName: `${userInfo.firstName} ${userInfo.lastName}`,
                    loginUrl: window.location.origin
                };

                await fetch('/.netlify/functions/elearning-send-notification', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(emailData)
                });
            } catch (error) {
                console.error('Error sending approval email:', error);
            }
        }

        async function sendRejectionEmail(userInfo, reason) {
            try {
                const emailData = {
                    type: 'Rifiuto Registrazione E-Learning',
                    recipientEmail: userInfo.email,
                    recipientName: `${userInfo.firstName} ${userInfo.lastName}`,
                    rejectionReason: reason,
                    contactUrl: 'https://ilmondodelcane.net'
                };

                await fetch('/.netlify/functions/elearning-send-notification', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(emailData)
                });
            } catch (error) {
                console.error('Error sending rejection email:', error);
            }
        }
                
                // Reset form
                document.getElementById('student-registration-form').reset();
            } catch (error) {
                alert('Errore durante la registrazione: ' + error.message);
            }
        }

        async function sendAdminNotification(formData) {
            // This would typically send an email to the admin
            // For now, we'll just log it
            console.log('Admin notification for new registration:', formData);
        }

        function updateUIForAuthState() {
            if (currentUser) {
                // User is logged in
                studentLoginBtn.innerHTML = '<i class="fas fa-user"></i> ' + currentUser.email;
                studentLoginBtn.onclick = () => auth.signOut();
                
                // Show/hide admin features based on role
                if (isAdmin) {
                    body.classList.add('admin-mode');
                    document.querySelectorAll('.admin-only').forEach(element => {
                        element.style.display = 'block';
                    });
                    loadAdminData();
                } else {
                    body.classList.remove('admin-mode');
                    document.querySelectorAll('.admin-only').forEach(element => {
                        element.style.display = 'none';
                    });
                }

                // Update navigation for students
                updateNavigationForRole();
                
            } else {
                // User is not logged in
                studentLoginBtn.innerHTML = '<i class="fas fa-sign-in-alt"></i> Accedi';
                studentLoginBtn.onclick = () => openModal(loginModal);
                body.classList.remove('admin-mode');
                
                // Hide admin features
                document.querySelectorAll('.admin-only').forEach(element => {
                    element.style.display = 'none';
                });
            }
        }

        function updateNavigationForRole() {
            // Enable/disable navigation based on user role and approval status
            const restrictedPages = ['courses', 'progress', 'certificates'];
            
            restrictedPages.forEach(pageId => {
                const menuItem = document.querySelector(`[data-target="${pageId}"]`);
                if (menuItem) {
                    if (isAdmin || (window.userProfile && window.userProfile.accountStatus && window.userProfile.accountStatus.status === 'approved')) {
                        menuItem.style.opacity = '1';
                        menuItem.style.pointerEvents = 'auto';
                        menuItem.parentElement.style.opacity = '1';
                    } else {
                        menuItem.style.opacity = '0.5';
                        menuItem.style.pointerEvents = 'none';
                        menuItem.parentElement.style.opacity = '0.5';
                    }
                }
            });
        }

        async function checkAdminStatus() {
            // Check if current user has admin privileges
            // This would check against the same admin credentials as the main site
            if (currentUser && currentUser.email === 'admin@dogworld.com') { // Replace with actual admin email
                body.classList.add('admin-mode');
                isAdmin = true;
                await loadAdminData();
            }
        }

        async function loadPublicData() {
            // Load courses catalog
            await loadCoursesCatalog();
            
            // Load user's enrolled courses if logged in
            if (currentUser) {
                await loadUserCourses();
            }
        }

        async function loadAdminData() {
            if (!isAdmin) return;
            
            try {
                // Load registration requests
                await loadPendingRegistrations();
                
                // Setup admin event listeners
                setupAdminEventListeners();
                
                console.log('Admin data loaded successfully');
            } catch (error) {
                console.error('Error loading admin data:', error);
            }
        }

        function setupAdminEventListeners() {
            // Add course button
            const addCourseBtn = document.getElementById('add-course-btn');
            if (addCourseBtn) {
                addCourseBtn.addEventListener('click', openCourseCreator);
            }

            // Course creation form
            const courseForm = document.getElementById('course-creation-form');
            if (courseForm) {
                courseForm.addEventListener('submit', handleCourseCreation);
            }

            // Administration page load
            const adminMenuItem = document.querySelector('[data-target="administration"]');
            if (adminMenuItem) {
                adminMenuItem.addEventListener('click', () => {
                    setTimeout(() => {
                        loadPendingRegistrations();
                    }, 100);
                });
            }
        }

        async function handleCourseCreation(e) {
            e.preventDefault();
            
            if (!isAdmin) {
                alert('Accesso negato: solo gli admin possono creare corsi.');
                return;
            }

            try {
                const courseData = {
                    title: document.getElementById('course-title').value,
                    category: document.getElementById('course-category').value,
                    level: document.getElementById('course-level').value,
                    duration: document.getElementById('course-duration').value,
                    description: document.getElementById('course-description').value,
                    createdBy: currentUser.email,
                    createdAt: firebase.database.ServerValue.TIMESTAMP,
                    status: 'active'
                };

                // Get selected files
                const selectedVideos = getSelectedFiles('video-files-list');
                const selectedPDFs = getSelectedFiles('pdf-files-list');

                courseData.content = {
                    videos: selectedVideos,
                    pdfs: selectedPDFs
                };

                // Save course to Firebase
                const courseRef = database.ref('courses').push();
                await courseRef.set(courseData);

                alert('Corso creato con successo!');
                closeModal(document.getElementById('course-creator-modal'));
                
                // Reset form
                document.getElementById('course-creation-form').reset();
                
            } catch (error) {
                console.error('Error creating course:', error);
                alert('Errore durante la creazione del corso: ' + error.message);
            }
        }

        function getSelectedFiles(containerId) {
            const container = document.getElementById(containerId);
            const selectedFiles = [];
            
            if (container) {
                const checkboxes = container.querySelectorAll('input[type="checkbox"]:checked');
                checkboxes.forEach(checkbox => {
                    selectedFiles.push({
                        id: checkbox.value,
                        name: checkbox.getAttribute('data-name'),
                        embedLink: driveManager.getEmbedLink(checkbox.value),
                        downloadLink: driveManager.getDownloadLink(checkbox.value)
                    });
                });
            }
            
            return selectedFiles;
        }

        // Additional utility functions
        function openModal(modal) {
            if (modal) {
                modal.style.display = 'flex';
                document.body.style.overflow = 'hidden';
            }
        }

        function closeModal(modal) {
            if (modal) {
                modal.style.display = 'none';
                document.body.style.overflow = 'auto';
            }
        }

        // CSS for file selection items
        const additionalStyles = `
            <style>
                .file-selection-item {
                    display: flex;
                    align-items: center;
                    padding: 8px;
                    border-bottom: 1px solid #eee;
                    cursor: pointer;
                }

                .file-selection-item:hover {
                    background-color: #f5f5f5;
                }

                .file-selection-item input[type="checkbox"] {
                    margin-right: 10px;
                }

                .file-selection-item label {
                    display: flex;
                    justify-content: space-between;
                    width: 100%;
                    cursor: pointer;
                }

                .file-name {
                    font-weight: 500;
                }

                .file-size {
                    color: #666;
                    font-size: 0.9em;
                }

                .registration-request-card {
                    background: white;
                    border: 1px solid #ddd;
                    border-radius: 8px;
                    padding: 20px;
                    margin-bottom: 15px;
                    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                }

                .request-header {
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    margin-bottom: 15px;
                }

                .request-header h4 {
                    margin: 0;
                    color: var(--primary-color);
                }

                .request-date {
                    color: #666;
                    font-size: 0.9em;
                }

                .request-details p {
                    margin: 5px 0;
                }

                .request-actions {
                    display: flex;
                    gap: 10px;
                    margin-top: 15px;
                }

                .btn {
                    padding: 8px 16px;
                    border: none;
                    border-radius: 4px;
                    cursor: pointer;
                    font-weight: 500;
                    transition: background-color 0.3s;
                }

                .btn-success {
                    background-color: var(--success-color);
                    color: white;
                }

                .btn-success:hover {
                    background-color: #45a049;
                }

                .btn-danger {
                    background-color: var(--error-color);
                    color: white;
                }

                .btn-danger:hover {
                    background-color: #d32f2f;
                }
            </style>
        `;

        // Add additional styles to head
        document.head.insertAdjacentHTML('beforeend', additionalStyles);

        async function loadCoursesCatalog() {
            // This would load courses from Firebase
            // For now, we'll use sample data
            const sampleCourses = [
                {
                    id: 'course1',
                    title: 'Educazione di Base del Cane',
                    description: 'Impara i fondamenti dell\'educazione canina con tecniche moderne e rispettose.',
                    difficulty: 'beginner',
                    category: 'education',
                    thumbnail: '/images/corso-base-educazione.jpg',
                    lessons: 8,
                    duration: '6 ore'
                },
                {
                    id: 'course2',
                    title: 'Agility per Principianti',
                    description: 'Introduzione al mondo dell\'agility: ostacoli, tecniche e preparazione atletica.',
                    difficulty: 'intermediate',
                    category: 'agility',
                    thumbnail: '/images/corso-agility.jpg',
                    lessons: 12,
                    duration: '10 ore'
                }
            ];

            renderCoursesCatalog(sampleCourses);
        }

        function renderCoursesCatalog(courses) {
            const container = document.getElementById('catalog-courses-container');
            container.innerHTML = '';

            courses.forEach(course => {
                const courseCard = createCourseCard(course);
                container.appendChild(courseCard);
            });
        }

        function createCourseCard(course) {
            const card = document.createElement('div');
            card.className = 'course-card';
            
            const difficultyClass = `difficulty-${course.difficulty}`;
            
            card.innerHTML = `
                <img src="${course.thumbnail}" alt="${course.title}" class="course-thumbnail">
                <div class="course-content">
                    <h4 class="course-title">${course.title}</h4>
                    <p class="course-description">${course.description}</p>
                    <div class="course-meta">
                        <span>${course.lessons} lezioni</span>
                        <span class="course-difficulty ${difficultyClass}">${course.difficulty}</span>
                    </div>
                    <div class="course-actions">
                        <button class="btn-primary" onclick="enrollInCourse('${course.id}')">Iscriviti</button>
                        <button class="btn-secondary" onclick="previewCourse('${course.id}')">Anteprima</button>
                    </div>
                </div>
            `;

            return card;
        }

        async function loadUserCourses() {
            // Load user's enrolled courses
            // This would fetch from Firebase based on current user
        }

        async function loadRegistrationRequests() {
            if (!isAdmin) return;

            try {
                const snapshot = await database.ref('elearningRegistrationRequests').orderByChild('status').equalTo('pending').once('value');
                const requests = snapshot.val() || {};
                
                renderRegistrationRequests(requests);
            } catch (error) {
                console.error('Error loading registration requests:', error);
            }
        }

        function renderRegistrationRequests(requests) {
            const container = document.getElementById('registration-requests-container');
            container.innerHTML = '';

            if (Object.keys(requests).length === 0) {
                container.innerHTML = '<p>Nessuna richiesta di registrazione in attesa.</p>';
                return;
            }

            Object.entries(requests).forEach(([id, request]) => {
                const requestCard = createRequestCard(id, request);
                container.appendChild(requestCard);
            });
        }

        function createRequestCard(id, request) {
            const card = document.createElement('div');
            card.className = `request-card ${request.status}`;
            
            card.innerHTML = `
                <h4>${request.firstName} ${request.lastName}</h4>
                <p><strong>Email:</strong> ${request.email}</p>
                <p><strong>Telefono:</strong> ${request.phone}</p>
                <p><strong>ID Associato:</strong> ${request.associatedId}</p>
                <p><strong>Data Richiesta:</strong> ${new Date(request.submissionDate).toLocaleDateString('it-IT')}</p>
                
                <div class="request-actions">
                    <button class="btn-approve" onclick="approveRequest('${id}')">
                        <i class="fas fa-check"></i> Approva
                    </button>
                    <button class="btn-reject" onclick="rejectRequest('${id}')">
                        <i class="fas fa-times"></i> Rifiuta
                    </button>
                </div>
            `;

            return card;
        }

        async function approveRequest(requestId) {
            if (!confirm('Sei sicuro di voler approvare questa richiesta?')) return;

            try {
                // Update request status
                await database.ref(`elearningRegistrationRequests/${requestId}`).update({
                    status: 'approved',
                    processedBy: currentUser.uid,
                    processedDate: firebase.database.ServerValue.TIMESTAMP
                });

                // Create user account (you'll need to implement this)
                // Send approval email (you'll need to implement this)

                alert('Richiesta approvata con successo!');
                await loadRegistrationRequests(); // Reload the list
            } catch (error) {
                alert('Errore durante l\'approvazione: ' + error.message);
            }
        }

        async function rejectRequest(requestId) {
            const reason = prompt('Motivo del rifiuto (opzionale):');
            if (reason === null) return; // User cancelled

            try {
                await database.ref(`elearningRegistrationRequests/${requestId}`).update({
                    status: 'rejected',
                    rejectionReason: reason,
                    processedBy: currentUser.uid,
                    processedDate: firebase.database.ServerValue.TIMESTAMP
                });

                // Send rejection email (you'll need to implement this)

                alert('Richiesta rifiutata.');
                await loadRegistrationRequests(); // Reload the list
            } catch (error) {
                alert('Errore durante il rifiuto: ' + error.message);
            }
        }

        function enrollInCourse(courseId) {
            if (!currentUser) {
                alert('Devi effettuare il login per iscriverti a un corso.');
                openModal(loginModal);
                return;
            }

            // Implement course enrollment logic
            alert('Funzionalità di iscrizione in sviluppo.');
        }

        function previewCourse(courseId) {
            // Implement course preview logic
            alert('Anteprima corso in sviluppo.');
        }

        // Utility functions
        function openModal(modal) {
            if (modal) {
                modal.style.display = 'block';
                body.classList.add('modal-open');
            }
        }

        function closeModal(modal) {
            if (modal) {
                modal.style.display = 'none';
                body.classList.remove('modal-open');
            }
        }
    </script>
    <!-- Advanced Authentication and User Management Script -->
    <script>
        // Enhanced Authentication System
        class ELearningAuth {
            constructor() {
                this.currentUser = null;
                this.isAdmin = false;
                this.userProfile = null;
                this.adminEmails = ['info.ilmondodelcane@gmail.com']; // Admin emails from main site
            }

            async initialize() {
                // Listen for auth state changes
                auth.onAuthStateChanged(async (user) => {
                    this.currentUser = user;
                    if (user) {
                        await this.loadUserProfile();
                        await this.checkAdminStatus();
                    } else {
                        this.userProfile = null;
                        this.isAdmin = false;
                    }
                    this.updateUI();
                });
            }

            async loadUserProfile() {
                if (!this.currentUser) return;

                try {
                    const snapshot = await database.ref(`elearningUsers/${this.currentUser.uid}`).once('value');
                    this.userProfile = snapshot.val();
                    
                    // Update last login
                    if (this.userProfile) {
                        await database.ref(`elearningUsers/${this.currentUser.uid}/personalInfo/lastLoginDate`)
                            .set(firebase.database.ServerValue.TIMESTAMP);
                    }
                } catch (error) {
                    console.error('Error loading user profile:', error);
                }
            }

            async checkAdminStatus() {
                if (!this.currentUser) return;
                
                // Check if user email is in admin list
                this.isAdmin = this.adminEmails.includes(this.currentUser.email);
                
                if (this.isAdmin) {
                    body.classList.add('admin-mode');
                    await loadAdminData();
                } else {
                    body.classList.remove('admin-mode');
                }
            }

            async registerStudent(formData) {
                try {
                    // Create registration request
                    const requestData = {
                        userInfo: {
                            firstName: formData.firstName,
                            lastName: formData.lastName,
                            email: formData.email,
                            phone: formData.phone,
                            associatedId: formData.associatedId
                        },
                        requestDetails: {
                            submissionDate: firebase.database.ServerValue.TIMESTAMP,
                            status: 'pending'
                        },
                        verification: {
                            emailVerified: false,
                            phoneVerified: false
                        }
                    };

                    // Save to database
                    const requestRef = await database.ref('elearningRegistrationRequests').push(requestData);
                    
                    // Send email notification to admin
                    await this.sendAdminNotificationEmail(requestData, requestRef.key);
                    
                    return { success: true, requestId: requestRef.key };
                } catch (error) {
                    console.error('Registration error:', error);
                    throw error;
                }
            }

            async sendAdminNotificationEmail(requestData, requestId) {
                // Email notification payload
                const emailData = {
                    type: 'Nuova Richiesta E-Learning',
                    studentName: `${requestData.userInfo.firstName} ${requestData.userInfo.lastName}`,
                    studentEmail: requestData.userInfo.email,
                    studentPhone: requestData.userInfo.phone,
                    associatedId: requestData.userInfo.associatedId,
                    requestId: requestId,
                    adminUrl: `${window.location.origin}${window.location.pathname}#administration`
                };

                // This would integrate with the existing notification system
                try {
                    await fetch('/.netlify/functions/send-notification', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(emailData)
                    });
                } catch (error) {
                    console.error('Error sending admin notification:', error);
                }
            }

            async approveRegistration(requestId, requestData) {
                try {
                    // Create temporary password
                    const tempPassword = this.generateTempPassword();
                    
                    // Create Firebase user account
                    const userCredential = await auth.createUserWithEmailAndPassword(
                        requestData.userInfo.email, 
                        tempPassword
                    );
                    
                    const user = userCredential.user;
                    
                    // Create user profile in database
                    const userProfileData = {
                        personalInfo: {
                            firstName: requestData.userInfo.firstName,
                            lastName: requestData.userInfo.lastName,
                            email: requestData.userInfo.email,
                            phone: requestData.userInfo.phone,
                            associatedId: requestData.userInfo.associatedId,
                            registrationDate: firebase.database.ServerValue.TIMESTAMP,
                            lastLoginDate: null
                        },
                        accountStatus: {
                            status: 'approved',
                            approvedBy: this.currentUser.uid,
                            approvalDate: firebase.database.ServerValue.TIMESTAMP
                        },
                        learningProgress: {
                            enrolledCourses: {},
                            certificates: {}
                        }
                    };

                    await database.ref(`elearningUsers/${user.uid}`).set(userProfileData);
                    
                    // Update registration request
                    await database.ref(`elearningRegistrationRequests/${requestId}`).update({
                        'requestDetails/status': 'approved',
                        'requestDetails/processedBy': this.currentUser.uid,
                        'requestDetails/processedDate': firebase.database.ServerValue.TIMESTAMP
                    });

                    // Send approval email with login credentials
                    await this.sendApprovalEmail(requestData.userInfo, tempPassword);
                    
                    return { success: true, tempPassword };
                } catch (error) {
                    console.error('Error approving registration:', error);
                    throw error;
                }
            }

            async rejectRegistration(requestId, reason) {
                try {
                    // Get request data for email
                    const snapshot = await database.ref(`elearningRegistrationRequests/${requestId}`).once('value');
                    const requestData = snapshot.val();
                    
                    // Update registration request
                    await database.ref(`elearningRegistrationRequests/${requestId}`).update({
                        'requestDetails/status': 'rejected',
                        'requestDetails/rejectionReason': reason,
                        'requestDetails/processedBy': this.currentUser.uid,
                        'requestDetails/processedDate': firebase.database.ServerValue.TIMESTAMP
                    });

                    // Send rejection email
                    await this.sendRejectionEmail(requestData.userInfo, reason);
                    
                    return { success: true };
                } catch (error) {
                    console.error('Error rejecting registration:', error);
                    throw error;
                }
            }

            async sendApprovalEmail(userInfo, tempPassword) {
                const emailData = {
                    type: 'Approvazione E-Learning',
                    recipientEmail: userInfo.email,
                    recipientName: `${userInfo.firstName} ${userInfo.lastName}`,
                    tempPassword: tempPassword,
                    loginUrl: `${window.location.origin}${window.location.pathname}`,
                    supportEmail: 'info.ilmondodelcane@gmail.com'
                };

                try {
                    await fetch('/.netlify/functions/send-notification', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(emailData)
                    });
                } catch (error) {
                    console.error('Error sending approval email:', error);
                }
            }

            async sendRejectionEmail(userInfo, reason) {
                const emailData = {
                    type: 'Rifiuto E-Learning',
                    recipientEmail: userInfo.email,
                    recipientName: `${userInfo.firstName} ${userInfo.lastName}`,
                    rejectionReason: reason,
                    contactUrl: 'https://ilmondodelcane.net',
                    supportEmail: 'info.ilmondodelcane@gmail.com'
                };

                try {
                    await fetch('/.netlify/functions/send-notification', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(emailData)
                    });
                } catch (error) {
                    console.error('Error sending rejection email:', error);
                }
            }

            generateTempPassword() {
                const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
                let password = '';
                for (let i = 0; i < 12; i++) {
                    password += chars.charAt(Math.floor(Math.random() * chars.length));
                }
                return password;
            }

            async loginStudent(email, password) {
                try {
                    const userCredential = await auth.signInWithEmailAndPassword(email, password);
                    const user = userCredential.user;
                    
                    // Check if user has e-learning access
                    const snapshot = await database.ref(`elearningUsers/${user.uid}`).once('value');
                    const userProfile = snapshot.val();
                    
                    if (!userProfile) {
                        await auth.signOut();
                        throw new Error('Account non autorizzato per la piattaforma e-learning.');
                    }
                    
                    if (userProfile.accountStatus.status !== 'approved') {
                        await auth.signOut();
                        throw new Error('Account in attesa di approvazione o sospeso.');
                    }
                    
                    return { success: true, user };
                } catch (error) {
                    console.error('Login error:', error);
                    throw error;
                }
            }

            updateUI() {
                const studentLoginBtn = document.getElementById('student-login-btn');
                
                if (this.currentUser && this.userProfile) {
                    // User is logged in and has valid profile
                    const displayName = this.userProfile.personalInfo.firstName || this.currentUser.email;
                    studentLoginBtn.innerHTML = `<i class="fas fa-user"></i> ${displayName}`;
                    studentLoginBtn.onclick = () => this.showUserMenu();
                    
                    // Show user-specific content
                    this.loadUserDashboard();
                } else if (this.currentUser) {
                    // User is logged in but no e-learning profile
                    studentLoginBtn.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Account non autorizzato';
                    studentLoginBtn.onclick = () => auth.signOut();
                } else {
                    // User is not logged in
                    studentLoginBtn.innerHTML = '<i class="fas fa-sign-in-alt"></i> Accedi';
                    studentLoginBtn.onclick = () => openModal(loginModal);
                }
            }

            showUserMenu() {
                const menu = document.createElement('div');
                menu.style.cssText = `
                    position: fixed;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%);
                    background: white;
                    border-radius: 8px;
                    box-shadow: 0 4px 20px rgba(0,0,0,0.3);
                    padding: 20px;
                    z-index: 1001;
                    min-width: 250px;
                `;
                
                menu.innerHTML = `
                    <h3 style="margin-top: 0; color: var(--primary-color);">Menu Utente</h3>
                    <p><strong>${this.userProfile.personalInfo.firstName} ${this.userProfile.personalInfo.lastName}</strong></p>
                    <p style="font-size: 0.9em; color: #666;">${this.currentUser.email}</p>
                    <hr style="margin: 15px 0;">
                    <button onclick="switchPage('dashboard')" style="width: 100%; margin-bottom: 10px; padding: 8px; background: var(--primary-color); color: white; border: none; border-radius: 4px; cursor: pointer;">Dashboard</button>
                    <button onclick="switchPage('progress')" style="width: 100%; margin-bottom: 10px; padding: 8px; background: var(--secondary-color); color: white; border: none; border-radius: 4px; cursor: pointer;">I Miei Progressi</button>
                    <button onclick="elearningAuth.changePassword()" style="width: 100%; margin-bottom: 10px; padding: 8px; background: var(--accent-color); color: white; border: none; border-radius: 4px; cursor: pointer;">Cambia Password</button>
                    <button onclick="auth.signOut()" style="width: 100%; padding: 8px; background: var(--danger-color); color: white; border: none; border-radius: 4px; cursor: pointer;">Logout</button>
                    <button onclick="this.parentElement.remove()" style="position: absolute; top: 10px; right: 10px; background: none; border: none; font-size: 18px; cursor: pointer;">×</button>
                `;
                
                document.body.appendChild(menu);
                
                // Close menu when clicking outside
                setTimeout(() => {
                    document.addEventListener('click', function closeMenu(e) {
                        if (!menu.contains(e.target)) {
                            menu.remove();
                            document.removeEventListener('click', closeMenu);
                        }
                    });
                }, 100);
            }

            async changePassword() {
                const newPassword = prompt('Inserisci la nuova password (minimo 6 caratteri):');
                if (!newPassword || newPassword.length < 6) {
                    alert('Password non valida. Deve essere di almeno 6 caratteri.');
                    return;
                }

                try {
                    await this.currentUser.updatePassword(newPassword);
                    alert('Password aggiornata con successo!');
                } catch (error) {
                    if (error.code === 'auth/requires-recent-login') {
                        alert('Per sicurezza, devi effettuare nuovamente il login prima di cambiare la password.');
                        auth.signOut();
                    } else {
                        alert('Errore durante l\'aggiornamento della password: ' + error.message);
                    }
                }
            }

            async loadUserDashboard() {
                if (!this.userProfile) return;

                // Load user's enrolled courses
                const enrolledCourses = this.userProfile.learningProgress?.enrolledCourses || {};
                
                // Update dashboard stats
                this.updateDashboardStats(enrolledCourses);
                
                // Load recent activity
                this.loadRecentActivity();
            }

            updateDashboardStats(enrolledCourses) {
                const coursesCount = Object.keys(enrolledCourses).length;
                const totalProgress = Object.values(enrolledCourses)
                    .reduce((sum, course) => sum + (course.completionPercentage || 0), 0);
                const avgProgress = coursesCount > 0 ? Math.round(totalProgress / coursesCount) : 0;
                
                // Update stats in dashboard
                const statsElements = document.querySelectorAll('.dashboard-stats > div');
                if (statsElements.length >= 4) {
                    statsElements[0].querySelector('h3').textContent = coursesCount;
                    statsElements[3].querySelector('h3').textContent = avgProgress + '%';
                }
            }

            loadRecentActivity() {
                // Load and display recent learning activity
                // This would show recent lessons completed, quiz scores, etc.
            }
        }

        // Initialize enhanced authentication system
        const elearningAuth = new ELearningAuth();

        // Update the existing initialization
        async function initializeApp() {
            // Set up navigation
            setupNavigation();
            
            // Set up modals
            setupModals();
            
            // Initialize enhanced authentication
            await elearningAuth.initialize();
            
            // Set up form handlers
            setupFormHandlers();
            
            // Load initial data
            await loadPublicData();
            
            console.log('E-Learning platform initialized with enhanced authentication');
        }

        function setupFormHandlers() {
            // Enhanced student login form
            document.getElementById('student-login-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const email = document.getElementById('student-email').value;
                const password = document.getElementById('student-password').value;

                try {
                    await elearningAuth.loginStudent(email, password);
                    closeModal(loginModal);
                    alert('Login effettuato con successo!');
                } catch (error) {
                    alert('Errore durante il login: ' + error.message);
                }
            });

            // Enhanced student registration form
            document.getElementById('student-registration-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const formData = {
                    firstName: document.getElementById('reg-firstName').value,
                    lastName: document.getElementById('reg-lastName').value,
                    email: document.getElementById('reg-email').value,
                    phone: document.getElementById('reg-phone').value,
                    associatedId: document.getElementById('reg-associatedId').value
                };

                try {
                    const result = await elearningAuth.registerStudent(formData);
                    closeModal(registrationModal);
                    alert('Richiesta di registrazione inviata con successo! Riceverai una email di conferma una volta approvata.');
                    
                    // Reset form
                    document.getElementById('student-registration-form').reset();
                } catch (error) {
                    alert('Errore durante la registrazione: ' + error.message);
                }
            });
        }

        // Enhanced admin functions
        async function approveRequest(requestId) {
            if (!confirm('Sei sicuro di voler approvare questa richiesta?')) return;

            try {
                const snapshot = await database.ref(`elearningRegistrationRequests/${requestId}`).once('value');
                const requestData = snapshot.val();
                
                const result = await elearningAuth.approveRegistration(requestId, requestData);
                
                alert(`Richiesta approvata con successo! Password temporanea: ${result.tempPassword}`);
                await loadRegistrationRequests(); // Reload the list
            } catch (error) {
                alert('Errore durante l\'approvazione: ' + error.message);
            }
        }

        async function rejectRequest(requestId) {
            const reason = prompt('Motivo del rifiuto (opzionale):');
            if (reason === null) return; // User cancelled

            try {
                await elearningAuth.rejectRegistration(requestId, reason);
                alert('Richiesta rifiutata e notifica inviata all\'utente.');
                await loadRegistrationRequests(); // Reload the list
            } catch (error) {
                alert('Errore durante il rifiuto: ' + error.message);
            }
        }

        // Enhanced registration requests loading
        async function loadRegistrationRequests() {
            if (!elearningAuth.isAdmin) return;

            try {
                const snapshot = await database.ref('elearningRegistrationRequests')
                    .orderByChild('requestDetails/submissionDate')
                    .once('value');
                const requests = snapshot.val() || {};
                
                renderRegistrationRequests(requests);
            } catch (error) {
                console.error('Error loading registration requests:', error);
            }
        }

        function renderRegistrationRequests(requests) {
            const container = document.getElementById('registration-requests-container');
            container.innerHTML = '';

            const pendingRequests = Object.entries(requests)
                .filter(([id, request]) => request.requestDetails.status === 'pending')
                .sort(([,a], [,b]) => b.requestDetails.submissionDate - a.requestDetails.submissionDate);

            if (pendingRequests.length === 0) {
                container.innerHTML = '<p>Nessuna richiesta di registrazione in attesa.</p>';
                return;
            }

            pendingRequests.forEach(([id, request]) => {
                const requestCard = createEnhancedRequestCard(id, request);
                container.appendChild(requestCard);
            });

            // Show processed requests section
            const processedRequests = Object.entries(requests)
                .filter(([id, request]) => request.requestDetails.status !== 'pending')
                .sort(([,a], [,b]) => b.requestDetails.processedDate - a.requestDetails.processedDate)
                .slice(0, 10); // Show last 10 processed

            if (processedRequests.length > 0) {
                const processedSection = document.createElement('div');
                processedSection.innerHTML = '<h3 style="margin-top: 40px;">Richieste Elaborate Recenti</h3>';
                
                processedRequests.forEach(([id, request]) => {
                    const card = createEnhancedRequestCard(id, request, true);
                    processedSection.appendChild(card);
                });
                
                container.appendChild(processedSection);
            }
        }

        function createEnhancedRequestCard(id, request, isProcessed = false) {
            const card = document.createElement('div');
            card.className = `request-card ${request.requestDetails.status}`;
            
            const submissionDate = new Date(request.requestDetails.submissionDate).toLocaleDateString('it-IT');
            const processedDate = request.requestDetails.processedDate ? 
                new Date(request.requestDetails.processedDate).toLocaleDateString('it-IT') : null;
            
            let statusBadge = '';
            switch(request.requestDetails.status) {
                case 'pending':
                    statusBadge = '<span style="background: var(--warning-color); color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.8em;">In Attesa</span>';
                    break;
                case 'approved':
                    statusBadge = '<span style="background: var(--success-color); color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.8em;">Approvata</span>';
                    break;
                case 'rejected':
                    statusBadge = '<span style="background: var(--danger-color); color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.8em;">Rifiutata</span>';
                    break;
            }
            
            card.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px;">
                    <h4 style="margin: 0;">${request.userInfo.firstName} ${request.userInfo.lastName}</h4>
                    ${statusBadge}
                </div>
                <p><strong>Email:</strong> ${request.userInfo.email}</p>
                <p><strong>Telefono:</strong> ${request.userInfo.phone}</p>
                <p><strong>ID Associato:</strong> ${request.userInfo.associatedId}</p>
                <p><strong>Data Richiesta:</strong> ${submissionDate}</p>
                ${processedDate ? `<p><strong>Data Elaborazione:</strong> ${processedDate}</p>` : ''}
                ${request.requestDetails.rejectionReason ? `<p><strong>Motivo Rifiuto:</strong> ${request.requestDetails.rejectionReason}</p>` : ''}
                
                ${!isProcessed && request.requestDetails.status === 'pending' ? `
                    <div class="request-actions">
                        <button class="btn-approve" onclick="approveRequest('${id}')">
                            <i class="fas fa-check"></i> Approva
                        </button>
                        <button class="btn-reject" onclick="rejectRequest('${id}')">
                            <i class="fas fa-times"></i> Rifiuta
                        </button>
                    </div>
                ` : ''}
            `;

            return card;
        }

        // Update the existing checkAdminStatus function
        async function checkAdminStatus() {
            // This is now handled by the ELearningAuth class
            return elearningAuth.checkAdminStatus();
        }

        // Update the existing updateUIForAuthState function
        function updateUIForAuthState() {
            // This is now handled by the ELearningAuth class
            return elearningAuth.updateUI();
        }
    </script>


    <!-- Advanced Admin Panel Script -->
    <script>
        // Enhanced Admin Management System
        class AdminPanel {
            constructor() {
                this.sortableInstances = {};
                this.currentEditingCourse = null;
                this.draggedElement = null;
            }

            async initialize() {
                if (!elearningAuth.isAdmin) return;

                // Initialize drag and drop for all admin elements
                this.initializeDragAndDrop();
                
                // Set up admin event listeners
                this.setupAdminEventListeners();
                
                // Load admin data
                await this.loadAdminDashboard();
            }

            initializeDragAndDrop() {
                // Initialize sortable for courses grid
                const coursesGrid = document.getElementById('catalog-courses-container');
                if (coursesGrid) {
                    this.sortableInstances.courses = new Sortable(coursesGrid, {
                        animation: 150,
                        ghostClass: 'sortable-ghost',
                        chosenClass: 'sortable-chosen',
                        dragClass: 'sortable-drag',
                        onEnd: (evt) => this.handleCoursesReorder(evt)
                    });
                }

                // Initialize sortable for registration requests
                const requestsContainer = document.getElementById('registration-requests-container');
                if (requestsContainer) {
                    this.sortableInstances.requests = new Sortable(requestsContainer, {
                        animation: 150,
                        ghostClass: 'sortable-ghost',
                        chosenClass: 'sortable-chosen',
                        dragClass: 'sortable-drag',
                        disabled: true // Requests shouldn't be reorderable
                    });
                }

                // Add drag handles to all admin-editable elements
                this.addDragHandles();
            }

            addDragHandles() {
                if (!elearningAuth.isAdmin) return;

                // Add drag handles to course cards
                document.querySelectorAll('.course-card').forEach(card => {
                    if (!card.querySelector('.drag-handle')) {
                        const dragHandle = document.createElement('button');
                        dragHandle.className = 'drag-handle';
                        dragHandle.innerHTML = '<i class="fas fa-grip-vertical"></i>';
                        dragHandle.title = 'Trascina per riordinare';
                        card.appendChild(dragHandle);
                    }
                });

                // Add admin controls to editable sections
                document.querySelectorAll('section').forEach(section => {
                    if (!section.querySelector('.admin-controls')) {
                        const adminControls = document.createElement('div');
                        adminControls.className = 'admin-controls';
                        adminControls.innerHTML = `
                            <button class="admin-btn" onclick="adminPanel.editSection(this)" title="Modifica Sezione">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="admin-btn" onclick="adminPanel.deleteSection(this)" title="Elimina Sezione">
                                <i class="fas fa-trash"></i>
                            </button>
                        `;
                        section.style.position = 'relative';
                        section.appendChild(adminControls);
                    }
                });
            }

            setupAdminEventListeners() {
                // Add course button
                const addCourseBtn = document.getElementById('add-course-btn');
                if (addCourseBtn) {
                    addCourseBtn.addEventListener('click', () => this.openCourseModal());
                }

                // Bulk actions for registration requests
                this.setupBulkActions();
            }

            setupBulkActions() {
                // Add bulk action controls to admin page
                const adminPage = document.getElementById('administration-page');
                if (adminPage && !adminPage.querySelector('.bulk-actions')) {
                    const bulkActionsHTML = `
                        <div class="bulk-actions" style="margin: 20px 0; padding: 15px; background: #f8f9fa; border-radius: 8px; display: none;">
                            <h4>Azioni Multiple</h4>
                            <div style="display: flex; gap: 10px; align-items: center;">
                                <button class="btn-approve" onclick="adminPanel.bulkApprove()">
                                    <i class="fas fa-check-double"></i> Approva Selezionate
                                </button>
                                <button class="btn-reject" onclick="adminPanel.bulkReject()">
                                    <i class="fas fa-times-circle"></i> Rifiuta Selezionate
                                </button>
                                <span id="selected-count">0 selezionate</span>
                            </div>
                        </div>
                    `;
                    
                    const requestsSection = adminPage.querySelector('h3');
                    if (requestsSection) {
                        requestsSection.insertAdjacentHTML('afterend', bulkActionsHTML);
                    }
                }
            }

            async loadAdminDashboard() {
                // Load admin statistics
                await this.loadAdminStats();
                
                // Load recent activity
                await this.loadRecentActivity();
                
                // Update admin UI elements
                this.updateAdminUI();
            }

            async loadAdminStats() {
                try {
                    // Get registration requests stats
                    const requestsSnapshot = await database.ref('elearningRegistrationRequests').once('value');
                    const requests = requestsSnapshot.val() || {};
                    
                    const pendingCount = Object.values(requests).filter(r => r.requestDetails.status === 'pending').length;
                    const approvedCount = Object.values(requests).filter(r => r.requestDetails.status === 'approved').length;
                    const rejectedCount = Object.values(requests).filter(r => r.requestDetails.status === 'rejected').length;

                    // Get users stats
                    const usersSnapshot = await database.ref('elearningUsers').once('value');
                    const users = usersSnapshot.val() || {};
                    const activeUsers = Object.values(users).filter(u => u.accountStatus.status === 'approved').length;

                    // Update admin dashboard if on admin page
                    this.updateAdminStatsDisplay({
                        pendingRequests: pendingCount,
                        approvedRequests: approvedCount,
                        rejectedRequests: rejectedCount,
                        activeUsers: activeUsers
                    });

                } catch (error) {
                    console.error('Error loading admin stats:', error);
                }
            }

            updateAdminStatsDisplay(stats) {
                // Add admin stats to administration page
                const adminPage = document.getElementById('administration-page');
                if (adminPage && !adminPage.querySelector('.admin-stats')) {
                    const statsHTML = `
                        <div class="admin-stats" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin: 30px 0;">
                            <div style="background: linear-gradient(135deg, var(--warning-color), #ffcc02); color: white; padding: 20px; border-radius: 12px; text-align: center;">
                                <i class="fas fa-clock" style="font-size: 2em; margin-bottom: 10px;"></i>
                                <h3 style="color: white; margin-bottom: 5px;">${stats.pendingRequests}</h3>
                                <p style="margin: 0; opacity: 0.9;">Richieste in Attesa</p>
                            </div>
                            <div style="background: linear-gradient(135deg, var(--success-color), #66bb6a); color: white; padding: 20px; border-radius: 12px; text-align: center;">
                                <i class="fas fa-check-circle" style="font-size: 2em; margin-bottom: 10px;"></i>
                                <h3 style="color: white; margin-bottom: 5px;">${stats.approvedRequests}</h3>
                                <p style="margin: 0; opacity: 0.9;">Richieste Approvate</p>
                            </div>
                            <div style="background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)); color: white; padding: 20px; border-radius: 12px; text-align: center;">
                                <i class="fas fa-users" style="font-size: 2em; margin-bottom: 10px;"></i>
                                <h3 style="color: white; margin-bottom: 5px;">${stats.activeUsers}</h3>
                                <p style="margin: 0; opacity: 0.9;">Utenti Attivi</p>
                            </div>
                            <div style="background: linear-gradient(135deg, var(--danger-color), #e57373); color: white; padding: 20px; border-radius: 12px; text-align: center;">
                                <i class="fas fa-times-circle" style="font-size: 2em; margin-bottom: 10px;"></i>
                                <h3 style="color: white; margin-bottom: 5px;">${stats.rejectedRequests}</h3>
                                <p style="margin: 0; opacity: 0.9;">Richieste Rifiutate</p>
                            </div>
                        </div>
                    `;
                    
                    const firstSection = adminPage.querySelector('section');
                    if (firstSection) {
                        firstSection.insertAdjacentHTML('afterbegin', statsHTML);
                    }
                }
            }

            async loadRecentActivity() {
                // Load recent user activity, course completions, etc.
                try {
                    const recentActivity = [];
                    
                    // Get recent registrations
                    const requestsSnapshot = await database.ref('elearningRegistrationRequests')
                        .orderByChild('requestDetails/submissionDate')
                        .limitToLast(5)
                        .once('value');
                    
                    const requests = requestsSnapshot.val() || {};
                    Object.entries(requests).forEach(([id, request]) => {
                        recentActivity.push({
                            type: 'registration',
                            timestamp: request.requestDetails.submissionDate,
                            description: `Nuova richiesta da ${request.userInfo.firstName} ${request.userInfo.lastName}`,
                            status: request.requestDetails.status
                        });
                    });

                    // Sort by timestamp
                    recentActivity.sort((a, b) => b.timestamp - a.timestamp);
                    
                    this.displayRecentActivity(recentActivity);
                    
                } catch (error) {
                    console.error('Error loading recent activity:', error);
                }
            }

            displayRecentActivity(activities) {
                const adminPage = document.getElementById('administration-page');
                if (adminPage && !adminPage.querySelector('.recent-activity')) {
                    const activityHTML = `
                        <div class="recent-activity" style="margin-top: 40px;">
                            <h3>Attività Recente</h3>
                            <div class="activity-list" style="background: white; border-radius: 8px; padding: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                                ${activities.length > 0 ? activities.map(activity => `
                                    <div class="activity-item" style="display: flex; align-items: center; padding: 10px 0; border-bottom: 1px solid #eee;">
                                        <div class="activity-icon" style="margin-right: 15px; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; background: ${this.getActivityColor(activity.status)};">
                                            <i class="fas ${this.getActivityIcon(activity.type)}" style="color: white;"></i>
                                        </div>
                                        <div class="activity-content" style="flex: 1;">
                                            <p style="margin: 0; font-weight: 600;">${activity.description}</p>
                                            <p style="margin: 0; font-size: 0.8em; color: #666;">${new Date(activity.timestamp).toLocaleString('it-IT')}</p>
                                        </div>
                                        <div class="activity-status">
                                            <span class="status-badge ${activity.status}" style="padding: 4px 8px; border-radius: 12px; font-size: 0.7em; font-weight: 600; text-transform: uppercase;">
                                                ${activity.status}
                                            </span>
                                        </div>
                                    </div>
                                `).join('') : '<p style="text-align: center; color: #666;">Nessuna attività recente</p>'}
                            </div>
                        </div>
                    `;
                    
                    adminPage.querySelector('section').insertAdjacentHTML('beforeend', activityHTML);
                }
            }

            getActivityColor(status) {
                switch(status) {
                    case 'pending': return 'var(--warning-color)';
                    case 'approved': return 'var(--success-color)';
                    case 'rejected': return 'var(--danger-color)';
                    default: return 'var(--primary-color)';
                }
            }

            getActivityIcon(type) {
                switch(type) {
                    case 'registration': return 'fa-user-plus';
                    case 'course': return 'fa-graduation-cap';
                    case 'completion': return 'fa-trophy';
                    default: return 'fa-info-circle';
                }
            }

            updateAdminUI() {
                // Add admin-specific UI elements
                this.addDragHandles();
                
                // Update admin controls visibility
                if (elearningAuth.isAdmin) {
                    body.classList.add('admin-mode');
                }
            }

            async handleCoursesReorder(evt) {
                // Handle course reordering
                const courseId = evt.item.dataset.courseId;
                const newIndex = evt.newIndex;
                
                try {
                    // Update course order in database
                    await database.ref(`courses/${courseId}/metadata/order`).set(newIndex);
                    console.log('Course order updated');
                } catch (error) {
                    console.error('Error updating course order:', error);
                }
            }

            openCourseModal(courseId = null) {
                // Open course creation/editing modal
                this.currentEditingCourse = courseId;
                
                const modal = this.createCourseModal(courseId);
                document.body.appendChild(modal);
                openModal(modal);
            }

            createCourseModal(courseId) {
                const modal = document.createElement('div');
                modal.className = 'modal';
                modal.id = 'course-edit-modal';
                
                const isEditing = courseId !== null;
                
                modal.innerHTML = `
                    <div class="modal-content-wrapper">
                        <div class="modal-content" style="max-width: 800px;">
                            <span class="close-btn" onclick="this.closest('.modal').remove()">×</span>
                            <h3>${isEditing ? 'Modifica Corso' : 'Nuovo Corso'}</h3>
                            
                            <form id="course-edit-form" class="form-container">
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                                    <div>
                                        <label for="course-title">Titolo del Corso</label>
                                        <input type="text" id="course-title" required>
                                        
                                        <label for="course-category">Categoria</label>
                                        <select id="course-category" required>
                                            <option value="">Seleziona categoria</option>
                                            <option value="education">Educazione</option>
                                            <option value="agility">Agility</option>
                                            <option value="behavior">Comportamento</option>
                                            <option value="health">Salute</option>
                                        </select>
                                        
                                        <label for="course-difficulty">Livello di Difficoltà</label>
                                        <select id="course-difficulty" required>
                                            <option value="">Seleziona livello</option>
                                            <option value="beginner">Principiante</option>
                                            <option value="intermediate">Intermedio</option>
                                            <option value="advanced">Avanzato</option>
                                        </select>
                                        
                                        <label for="course-duration">Durata Stimata (ore)</label>
                                        <input type="number" id="course-duration" min="1" required>
                                    </div>
                                    
                                    <div>
                                        <label for="course-thumbnail">Immagine di Anteprima</label>
                                        <input type="file" id="course-thumbnail" accept="image/*">
                                        
                                        <label for="course-price">Prezzo (€)</label>
                                        <input type="number" id="course-price" min="0" step="0.01">
                                        
                                        <label for="course-access">Livello di Accesso</label>
                                        <select id="course-access" required>
                                            <option value="public">Pubblico</option>
                                            <option value="private">Privato</option>
                                            <option value="premium">Premium</option>
                                        </select>
                                        
                                        <div style="margin-top: 15px;">
                                            <label>
                                                <input type="checkbox" id="course-published"> Pubblica immediatamente
                                            </label>
                                        </div>
                                    </div>
                                </div>
                                
                                <label for="course-description">Descrizione</label>
                                <textarea id="course-description" rows="4" required></textarea>
                                
                                <div style="display: flex; gap: 10px; margin-top: 20px;">
                                    <button type="submit" class="btn-primary" style="flex: 1;">
                                        ${isEditing ? 'Aggiorna Corso' : 'Crea Corso'}
                                    </button>
                                    <button type="button" onclick="this.closest('.modal').remove()" class="btn-secondary">
                                        Annulla
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                `;
                
                // Set up form submission
                modal.querySelector('#course-edit-form').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.saveCourse(courseId);
                });
                
                return modal;
            }

            async saveCourse(courseId) {
                const form = document.getElementById('course-edit-form');
                const formData = new FormData(form);
                
                const courseData = {
                    metadata: {
                        title: document.getElementById('course-title').value,
                        description: document.getElementById('course-description').value,
                        category: document.getElementById('course-category').value,
                        difficulty: document.getElementById('course-difficulty').value,
                        estimatedDuration: parseInt(document.getElementById('course-duration').value),
                        isPublished: document.getElementById('course-published').checked,
                        lastModified: firebase.database.ServerValue.TIMESTAMP
                    },
                    access: {
                        isPaid: parseFloat(document.getElementById('course-price').value) > 0,
                        price: parseFloat(document.getElementById('course-price').value) || 0,
                        accessLevel: document.getElementById('course-access').value
                    }
                };

                if (!courseId) {
                    courseData.metadata.createdDate = firebase.database.ServerValue.TIMESTAMP;
                    courseData.content = { lessons: {}, quizzes: {} };
                    courseData.access.enrolledUsers = [];
                }

                try {
                    let courseRef;
                    if (courseId) {
                        courseRef = database.ref(`courses/${courseId}`);
                        await courseRef.update(courseData);
                    } else {
                        courseRef = database.ref('courses').push();
                        await courseRef.set(courseData);
                    }

                    // Handle thumbnail upload if provided
                    const thumbnailFile = document.getElementById('course-thumbnail').files[0];
                    if (thumbnailFile) {
                        await this.uploadCourseThumbnail(courseRef.key, thumbnailFile);
                    }

                    alert(courseId ? 'Corso aggiornato con successo!' : 'Corso creato con successo!');
                    document.getElementById('course-edit-modal').remove();
                    
                    // Reload courses
                    await loadCoursesCatalog();
                    
                } catch (error) {
                    console.error('Error saving course:', error);
                    alert('Errore durante il salvataggio del corso: ' + error.message);
                }
            }

            async uploadCourseThumbnail(courseId, file) {
                try {
                    const storageRef = storage.ref(`course-thumbnails/${courseId}`);
                    const snapshot = await storageRef.put(file);
                    const downloadURL = await snapshot.ref.getDownloadURL();
                    
                    // Update course with thumbnail URL
                    await database.ref(`courses/${courseId}/metadata/thumbnailUrl`).set(downloadURL);
                    
                    return downloadURL;
                } catch (error) {
                    console.error('Error uploading thumbnail:', error);
                    throw error;
                }
            }

            editSection(button) {
                const section = button.closest('section');
                const content = section.innerHTML;
                
                // Create inline editor
                const editor = document.createElement('div');
                editor.style.cssText = `
                    position: fixed;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%);
                    background: white;
                    border-radius: 8px;
                    box-shadow: 0 4px 20px rgba(0,0,0,0.3);
                    padding: 20px;
                    z-index: 1001;
                    min-width: 500px;
                    max-width: 80vw;
                    max-height: 80vh;
                    overflow-y: auto;
                `;
                
                editor.innerHTML = `
                    <h3>Modifica Sezione</h3>
                    <textarea id="section-editor" style="width: 100%; height: 300px; margin: 15px 0; font-family: monospace;">${content}</textarea>
                    <div style="display: flex; gap: 10px;">
                        <button onclick="adminPanel.saveSection(this, '${section.id}')" class="btn-primary">Salva</button>
                        <button onclick="this.parentElement.parentElement.remove()" class="btn-secondary">Annulla</button>
                    </div>
                `;
                
                document.body.appendChild(editor);
            }

            saveSection(button, sectionId) {
                const editor = button.closest('div').parentElement;
                const newContent = document.getElementById('section-editor').value;
                const section = document.getElementById(sectionId);
                
                if (section) {
                    section.innerHTML = newContent;
                    this.addDragHandles(); // Re-add admin controls
                }
                
                editor.remove();
                alert('Sezione aggiornata con successo!');
            }

            deleteSection(button) {
                if (confirm('Sei sicuro di voler eliminare questa sezione?')) {
                    const section = button.closest('section');
                    section.remove();
                    alert('Sezione eliminata con successo!');
                }
            }

            // Bulk actions for registration requests
            bulkApprove() {
                const selectedRequests = this.getSelectedRequests();
                if (selectedRequests.length === 0) {
                    alert('Seleziona almeno una richiesta.');
                    return;
                }

                if (confirm(`Sei sicuro di voler approvare ${selectedRequests.length} richieste?`)) {
                    selectedRequests.forEach(async (requestId) => {
                        try {
                            await approveRequest(requestId);
                        } catch (error) {
                            console.error(`Error approving request ${requestId}:`, error);
                        }
                    });
                }
            }

            bulkReject() {
                const selectedRequests = this.getSelectedRequests();
                if (selectedRequests.length === 0) {
                    alert('Seleziona almeno una richiesta.');
                    return;
                }

                const reason = prompt('Motivo del rifiuto (opzionale):');
                if (reason === null) return;

                if (confirm(`Sei sicuro di voler rifiutare ${selectedRequests.length} richieste?`)) {
                    selectedRequests.forEach(async (requestId) => {
                        try {
                            await rejectRequest(requestId);
                        } catch (error) {
                            console.error(`Error rejecting request ${requestId}:`, error);
                        }
                    });
                }
            }

            getSelectedRequests() {
                const checkboxes = document.querySelectorAll('.request-checkbox:checked');
                return Array.from(checkboxes).map(cb => cb.dataset.requestId);
            }
        }

        // Initialize admin panel
        const adminPanel = new AdminPanel();

        // Update the existing loadAdminData function
        async function loadAdminData() {
            if (!elearningAuth.isAdmin) return;
            
            // Load registration requests
            await loadRegistrationRequests();
            
            // Initialize admin panel
            await adminPanel.initialize();
        }

        // Add CSS for sortable elements
        const sortableCSS = `
            <style>
                .sortable-ghost {
                    opacity: 0.4;
                }
                
                .sortable-chosen {
                    transform: scale(1.05);
                }
                
                .sortable-drag {
                    transform: rotate(5deg);
                }
                
                .drag-handle {
                    cursor: move;
                    opacity: 0.7;
                    transition: opacity 0.2s;
                }
                
                .drag-handle:hover {
                    opacity: 1;
                }
                
                .status-badge.pending {
                    background: var(--warning-color);
                    color: white;
                }
                
                .status-badge.approved {
                    background: var(--success-color);
                    color: white;
                }
                
                .status-badge.rejected {
                    background: var(--danger-color);
                    color: white;
                }
                
                .request-checkbox {
                    margin-right: 10px;
                }
                
                .bulk-actions {
                    border: 2px dashed var(--accent-color);
                }
                
                .activity-item:last-child {
                    border-bottom: none !important;
                }
            </style>
        `;
        
        document.head.insertAdjacentHTML('beforeend', sortableCSS);
    </script>


    <!-- Advanced Course Management and Content System -->
    <script>
        // Enhanced Course Management System
        class CourseManager {
            constructor() {
                this.currentCourse = null;
                this.currentLesson = null;
                this.videoPlayer = null;
                this.progressTracker = new ProgressTracker();
                this.contentRenderer = new ContentRenderer();
            }

            async initialize() {
                // Set up course event listeners
                this.setupCourseEventListeners();
                
                // Initialize video player
                this.initializeVideoPlayer();
                
                // Load user's courses if logged in
                if (elearningAuth.currentUser) {
                    await this.loadUserCourses();
                }
            }

            setupCourseEventListeners() {
                // Course enrollment
                document.addEventListener('click', (e) => {
                    if (e.target.matches('.enroll-btn')) {
                        const courseId = e.target.dataset.courseId;
                        this.enrollInCourse(courseId);
                    }
                    
                    if (e.target.matches('.continue-btn, .start-btn')) {
                        const courseId = e.target.dataset.courseId;
                        this.openCourse(courseId);
                    }
                    
                    if (e.target.matches('.lesson-item')) {
                        const lessonId = e.target.dataset.lessonId;
                        this.openLesson(lessonId);
                    }
                });
            }

            initializeVideoPlayer() {
                const videoModal = document.getElementById('video-modal');
                const video = document.getElementById('course-video');
                
                if (video) {
                    // Custom video controls
                    video.addEventListener('loadedmetadata', () => {
                        this.setupVideoControls(video);
                    });
                    
                    video.addEventListener('timeupdate', () => {
                        this.trackVideoProgress(video);
                    });
                    
                    video.addEventListener('ended', () => {
                        this.onVideoCompleted(video);
                    });
                }
            }

            setupVideoControls(video) {
                // Create custom video controls overlay
                const container = video.parentElement;
                
                if (!container.querySelector('.custom-video-controls')) {
                    const controlsHTML = `
                        <div class="custom-video-controls" style="position: absolute; bottom: 0; left: 0; right: 0; background: linear-gradient(transparent, rgba(0,0,0,0.8)); padding: 20px; display: flex; align-items: center; gap: 15px;">
                            <button class="video-play-pause" style="background: none; border: none; color: white; font-size: 20px; cursor: pointer;">
                                <i class="fas fa-play"></i>
                            </button>
                            
                            <div class="video-progress-container" style="flex: 1; height: 6px; background: rgba(255,255,255,0.3); border-radius: 3px; cursor: pointer; position: relative;">
                                <div class="video-progress-bar" style="height: 100%; background: var(--accent-color); border-radius: 3px; width: 0%; transition: width 0.1s;"></div>
                                <div class="video-progress-handle" style="position: absolute; top: -3px; right: -6px; width: 12px; height: 12px; background: white; border-radius: 50%; cursor: pointer; transform: translateX(50%);"></div>
                            </div>
                            
                            <div class="video-time" style="color: white; font-size: 0.9em; min-width: 80px;">
                                <span class="current-time">0:00</span> / <span class="total-time">0:00</span>
                            </div>
                            
                            <button class="video-speed" style="background: none; border: none; color: white; font-size: 0.9em; cursor: pointer;">1x</button>
                            
                            <button class="video-fullscreen" style="background: none; border: none; color: white; font-size: 16px; cursor: pointer;">
                                <i class="fas fa-expand"></i>
                            </button>
                        </div>
                    `;
                    
                    container.insertAdjacentHTML('beforeend', controlsHTML);
                    this.setupVideoControlsEvents(video, container);
                }
            }

            setupVideoControlsEvents(video, container) {
                const playPauseBtn = container.querySelector('.video-play-pause');
                const progressContainer = container.querySelector('.video-progress-container');
                const progressBar = container.querySelector('.video-progress-bar');
                const currentTimeSpan = container.querySelector('.current-time');
                const totalTimeSpan = container.querySelector('.total-time');
                const speedBtn = container.querySelector('.video-speed');
                const fullscreenBtn = container.querySelector('.video-fullscreen');

                // Play/Pause
                playPauseBtn.addEventListener('click', () => {
                    if (video.paused) {
                        video.play();
                        playPauseBtn.innerHTML = '<i class="fas fa-pause"></i>';
                    } else {
                        video.pause();
                        playPauseBtn.innerHTML = '<i class="fas fa-play"></i>';
                    }
                });

                // Progress bar
                progressContainer.addEventListener('click', (e) => {
                    const rect = progressContainer.getBoundingClientRect();
                    const percent = (e.clientX - rect.left) / rect.width;
                    video.currentTime = percent * video.duration;
                });

                // Speed control
                const speeds = [0.5, 0.75, 1, 1.25, 1.5, 2];
                let currentSpeedIndex = 2; // 1x
                speedBtn.addEventListener('click', () => {
                    currentSpeedIndex = (currentSpeedIndex + 1) % speeds.length;
                    video.playbackRate = speeds[currentSpeedIndex];
                    speedBtn.textContent = speeds[currentSpeedIndex] + 'x';
                });

                // Fullscreen
                fullscreenBtn.addEventListener('click', () => {
                    if (container.requestFullscreen) {
                        container.requestFullscreen();
                    }
                });

                // Update time display
                video.addEventListener('timeupdate', () => {
                    const current = this.formatTime(video.currentTime);
                    const total = this.formatTime(video.duration);
                    currentTimeSpan.textContent = current;
                    totalTimeSpan.textContent = total;
                    
                    const percent = (video.currentTime / video.duration) * 100;
                    progressBar.style.width = percent + '%';
                });
            }

            formatTime(seconds) {
                const mins = Math.floor(seconds / 60);
                const secs = Math.floor(seconds % 60);
                return `${mins}:${secs.toString().padStart(2, '0')}`;
            }

            trackVideoProgress(video) {
                if (!this.currentLesson || !elearningAuth.currentUser) return;

                const progress = (video.currentTime / video.duration) * 100;
                
                // Update lesson progress every 10 seconds
                if (Math.floor(video.currentTime) % 10 === 0) {
                    this.progressTracker.updateLessonProgress(
                        this.currentCourse.id,
                        this.currentLesson.id,
                        progress
                    );
                }
            }

            onVideoCompleted(video) {
                if (!this.currentLesson || !elearningAuth.currentUser) return;

                // Mark lesson as completed
                this.progressTracker.markLessonCompleted(
                    this.currentCourse.id,
                    this.currentLesson.id
                );

                // Show completion message and next lesson
                this.showLessonCompletionDialog();
            }

            showLessonCompletionDialog() {
                const dialog = document.createElement('div');
                dialog.style.cssText = `
                    position: fixed;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%);
                    background: white;
                    border-radius: 12px;
                    box-shadow: 0 8px 30px rgba(0,0,0,0.3);
                    padding: 30px;
                    z-index: 1002;
                    text-align: center;
                    min-width: 400px;
                `;
                
                const nextLesson = this.getNextLesson();
                
                dialog.innerHTML = `
                    <div style="color: var(--success-color); font-size: 3em; margin-bottom: 15px;">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    <h3 style="color: var(--primary-color); margin-bottom: 15px;">Lezione Completata!</h3>
                    <p style="margin-bottom: 25px;">Hai completato con successo "${this.currentLesson.title}"</p>
                    
                    ${nextLesson ? `
                        <div style="margin-bottom: 20px;">
                            <p><strong>Prossima lezione:</strong> ${nextLesson.title}</p>
                        </div>
                        <div style="display: flex; gap: 10px; justify-content: center;">
                            <button onclick="courseManager.openLesson('${nextLesson.id}')" class="btn-primary">
                                Continua con la Prossima Lezione
                            </button>
                            <button onclick="this.parentElement.parentElement.remove()" class="btn-secondary">
                                Torna al Corso
                            </button>
                        </div>
                    ` : `
                        <div style="background: linear-gradient(135deg, var(--success-color), #66bb6a); color: white; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                            <h4 style="color: white; margin-bottom: 10px;">🎉 Corso Completato!</h4>
                            <p style="margin: 0;">Congratulazioni! Hai completato tutto il corso.</p>
                        </div>
                        <div style="display: flex; gap: 10px; justify-content: center;">
                            <button onclick="courseManager.generateCertificate()" class="btn-primary">
                                Scarica Certificato
                            </button>
                            <button onclick="this.parentElement.parentElement.remove()" class="btn-secondary">
                                Chiudi
                            </button>
                        </div>
                    `}
                `;
                
                document.body.appendChild(dialog);
                
                // Auto-remove after 10 seconds if no action
                setTimeout(() => {
                    if (dialog.parentElement) {
                        dialog.remove();
                    }
                }, 10000);
            }

            async enrollInCourse(courseId) {
                if (!elearningAuth.currentUser) {
                    alert('Devi effettuare il login per iscriverti a un corso.');
                    openModal(loginModal);
                    return;
                }

                try {
                    // Check if already enrolled
                    const userProfile = elearningAuth.userProfile;
                    if (userProfile?.learningProgress?.enrolledCourses?.[courseId]) {
                        alert('Sei già iscritto a questo corso.');
                        return;
                    }

                    // Add enrollment
                    await database.ref(`elearningUsers/${elearningAuth.currentUser.uid}/learningProgress/enrolledCourses/${courseId}`).set({
                        enrollmentDate: firebase.database.ServerValue.TIMESTAMP,
                        completionPercentage: 0,
                        lastAccessDate: firebase.database.ServerValue.TIMESTAMP,
                        completedLessons: []
                    });

                    // Add user to course enrolled users
                    await database.ref(`courses/${courseId}/access/enrolledUsers`).push(elearningAuth.currentUser.uid);

                    alert('Iscrizione completata con successo!');
                    
                    // Reload user profile and courses
                    await elearningAuth.loadUserProfile();
                    await this.loadUserCourses();
                    
                } catch (error) {
                    console.error('Error enrolling in course:', error);
                    alert('Errore durante l\'iscrizione: ' + error.message);
                }
            }

            async openCourse(courseId) {
                try {
                    // Load course data
                    const snapshot = await database.ref(`courses/${courseId}`).once('value');
                    this.currentCourse = { id: courseId, ...snapshot.val() };
                    
                    if (!this.currentCourse) {
                        alert('Corso non trovato.');
                        return;
                    }

                    // Update last access
                    if (elearningAuth.currentUser) {
                        await database.ref(`elearningUsers/${elearningAuth.currentUser.uid}/learningProgress/enrolledCourses/${courseId}/lastAccessDate`)
                            .set(firebase.database.ServerValue.TIMESTAMP);
                    }

                    // Show course content modal
                    this.showCourseModal();
                    
                } catch (error) {
                    console.error('Error opening course:', error);
                    alert('Errore durante l\'apertura del corso: ' + error.message);
                }
            }

            showCourseModal() {
                const modal = document.getElementById('course-modal');
                const content = document.getElementById('course-modal-content');
                
                const lessons = this.currentCourse.content?.lessons || {};
                const userProgress = elearningAuth.userProfile?.learningProgress?.enrolledCourses?.[this.currentCourse.id];
                const completedLessons = userProgress?.completedLessons || [];

                content.innerHTML = `
                    <div class="course-header" style="margin-bottom: 30px;">
                        <h2>${this.currentCourse.metadata.title}</h2>
                        <p>${this.currentCourse.metadata.description}</p>
                        
                        <div class="course-meta" style="display: flex; gap: 20px; margin: 20px 0; flex-wrap: wrap;">
                            <span><i class="fas fa-clock"></i> ${this.currentCourse.metadata.estimatedDuration} ore</span>
                            <span><i class="fas fa-signal"></i> ${this.currentCourse.metadata.difficulty}</span>
                            <span><i class="fas fa-tag"></i> ${this.currentCourse.metadata.category}</span>
                        </div>
                        
                        ${userProgress ? `
                            <div class="course-progress" style="margin: 20px 0;">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                    <span>Progresso del corso</span>
                                    <span>${Math.round(userProgress.completionPercentage || 0)}%</span>
                                </div>
                                <div style="width: 100%; height: 8px; background: #e0e0e0; border-radius: 4px; overflow: hidden;">
                                    <div style="height: 100%; background: linear-gradient(90deg, var(--accent-color), var(--secondary-color)); width: ${userProgress.completionPercentage || 0}%; transition: width 0.3s;"></div>
                                </div>
                            </div>
                        ` : ''}
                    </div>
                    
                    <div class="course-content">
                        <h3>Contenuti del Corso</h3>
                        <div class="lessons-list">
                            ${Object.entries(lessons).sort(([,a], [,b]) => (a.order || 0) - (b.order || 0)).map(([lessonId, lesson]) => `
                                <div class="lesson-item ${completedLessons.includes(lessonId) ? 'completed' : ''}" 
                                     data-lesson-id="${lessonId}" 
                                     style="display: flex; align-items: center; padding: 15px; margin: 10px 0; background: ${completedLessons.includes(lessonId) ? '#e8f5e8' : '#f8f9fa'}; border-radius: 8px; cursor: pointer; transition: background-color 0.3s;">
                                    
                                    <div class="lesson-icon" style="margin-right: 15px; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; background: ${completedLessons.includes(lessonId) ? 'var(--success-color)' : 'var(--primary-color)'}; color: white;">
                                        <i class="fas ${this.getLessonIcon(lesson.type)}"></i>
                                    </div>
                                    
                                    <div class="lesson-content" style="flex: 1;">
                                        <h4 style="margin: 0 0 5px 0; color: var(--primary-color);">${lesson.title}</h4>
                                        <p style="margin: 0; color: #666; font-size: 0.9em;">${lesson.description || ''}</p>
                                        ${lesson.duration ? `<span style="font-size: 0.8em; color: #888;"><i class="fas fa-clock"></i> ${lesson.duration} min</span>` : ''}
                                    </div>
                                    
                                    <div class="lesson-status" style="margin-left: 15px;">
                                        ${completedLessons.includes(lessonId) ? 
                                            '<i class="fas fa-check-circle" style="color: var(--success-color); font-size: 1.2em;"></i>' : 
                                            '<i class="fas fa-play-circle" style="color: var(--primary-color); font-size: 1.2em;"></i>'
                                        }
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;

                openModal(modal);
            }

            getLessonIcon(type) {
                switch(type) {
                    case 'video': return 'fa-play';
                    case 'pdf': return 'fa-file-pdf';
                    case 'quiz': return 'fa-question-circle';
                    case 'interactive': return 'fa-mouse-pointer';
                    default: return 'fa-book';
                }
            }

            async openLesson(lessonId) {
                try {
                    const lesson = this.currentCourse.content.lessons[lessonId];
                    if (!lesson) {
                        alert('Lezione non trovata.');
                        return;
                    }

                    this.currentLesson = { id: lessonId, ...lesson };

                    // Close course modal
                    closeModal(document.getElementById('course-modal'));

                    // Open appropriate content viewer
                    switch(lesson.type) {
                        case 'video':
                            this.openVideoLesson(lesson);
                            break;
                        case 'pdf':
                            this.openPDFLesson(lesson);
                            break;
                        case 'quiz':
                            this.openQuizLesson(lesson);
                            break;
                        case 'interactive':
                            this.openInteractiveLesson(lesson);
                            break;
                        default:
                            alert('Tipo di lezione non supportato.');
                    }

                } catch (error) {
                    console.error('Error opening lesson:', error);
                    alert('Errore durante l\'apertura della lezione: ' + error.message);
                }
            }

            openVideoLesson(lesson) {
                const videoModal = document.getElementById('video-modal');
                const video = document.getElementById('course-video');
                
                // Set video source
                video.src = lesson.content.videoUrl;
                
                // Add lesson title overlay
                const container = video.parentElement;
                let titleOverlay = container.querySelector('.lesson-title-overlay');
                if (!titleOverlay) {
                    titleOverlay = document.createElement('div');
                    titleOverlay.className = 'lesson-title-overlay';
                    titleOverlay.style.cssText = `
                        position: absolute;
                        top: 20px;
                        left: 20px;
                        background: rgba(0,0,0,0.7);
                        color: white;
                        padding: 10px 15px;
                        border-radius: 5px;
                        z-index: 10;
                    `;
                    container.appendChild(titleOverlay);
                }
                titleOverlay.innerHTML = `<h4 style="margin: 0; color: white;">${lesson.title}</h4>`;

                openModal(videoModal);
            }

            openPDFLesson(lesson) {
                // Create PDF viewer modal
                const pdfModal = document.createElement('div');
                pdfModal.className = 'modal';
                pdfModal.innerHTML = `
                    <div class="modal-content-wrapper">
                        <div class="modal-content" style="max-width: 90vw; max-height: 90vh; padding: 0;">
                            <div style="background: var(--primary-color); color: white; padding: 15px; display: flex; justify-content: space-between; align-items: center;">
                                <h3 style="margin: 0; color: white;">${lesson.title}</h3>
                                <button onclick="this.closest('.modal').remove()" style="background: none; border: none; color: white; font-size: 24px; cursor: pointer;">×</button>
                            </div>
                            <iframe src="${lesson.content.pdfUrl}" style="width: 100%; height: 80vh; border: none;"></iframe>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(pdfModal);
                openModal(pdfModal);
            }

            openQuizLesson(lesson) {
                // This will be implemented in the quiz system
                alert('Sistema quiz in sviluppo.');
            }

            openInteractiveLesson(lesson) {
                // This will be implemented for interactive content
                alert('Contenuto interattivo in sviluppo.');
            }

            async loadUserCourses() {
                if (!elearningAuth.currentUser || !elearningAuth.userProfile) return;

                const enrolledCourses = elearningAuth.userProfile.learningProgress?.enrolledCourses || {};
                
                // Update "My Courses" page
                await this.renderUserCourses(enrolledCourses);
                
                // Update dashboard
                await this.updateDashboardCourses(enrolledCourses);
            }

            async renderUserCourses(enrolledCourses) {
                const container = document.getElementById('my-courses-container');
                if (!container) return;

                container.innerHTML = '';

                if (Object.keys(enrolledCourses).length === 0) {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 40px; color: #666;">
                            <i class="fas fa-graduation-cap" style="font-size: 3em; margin-bottom: 20px; opacity: 0.5;"></i>
                            <h3>Nessun corso attivo</h3>
                            <p>Non sei ancora iscritto a nessun corso.</p>
                            <button onclick="switchPage('catalog')" class="btn-primary" style="margin-top: 15px;">
                                Esplora il Catalogo
                            </button>
                        </div>
                    `;
                    return;
                }

                // Load course details for each enrolled course
                for (const [courseId, enrollment] of Object.entries(enrolledCourses)) {
                    try {
                        const snapshot = await database.ref(`courses/${courseId}`).once('value');
                        const courseData = snapshot.val();
                        
                        if (courseData) {
                            const courseCard = this.createUserCourseCard(courseId, courseData, enrollment);
                            container.appendChild(courseCard);
                        }
                    } catch (error) {
                        console.error(`Error loading course ${courseId}:`, error);
                    }
                }
            }

            createUserCourseCard(courseId, courseData, enrollment) {
                const card = document.createElement('div');
                card.className = 'course-card';
                
                const progress = enrollment.completionPercentage || 0;
                const lastAccess = enrollment.lastAccessDate ? 
                    new Date(enrollment.lastAccessDate).toLocaleDateString('it-IT') : 'Mai';

                card.innerHTML = `
                    <img src="${courseData.metadata.thumbnailUrl || '/images/default-course.jpg'}" alt="${courseData.metadata.title}" class="course-thumbnail">
                    <div class="course-content">
                        <h4 class="course-title">${courseData.metadata.title}</h4>
                        <p class="course-description">${courseData.metadata.description}</p>
                        
                        <div class="course-meta">
                            <span>Ultimo accesso: ${lastAccess}</span>
                            <span class="course-difficulty difficulty-${courseData.metadata.difficulty}">${courseData.metadata.difficulty}</span>
                        </div>
                        
                        <div class="course-progress">
                            <div class="progress-bar" style="width: ${progress}%;"></div>
                        </div>
                        
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 10px; font-size: 0.9em; color: #666;">
                            <span>${Math.round(progress)}% completato</span>
                            <span>${enrollment.completedLessons?.length || 0} lezioni completate</span>
                        </div>
                        
                        <div class="course-actions">
                            <button class="btn-primary continue-btn" data-course-id="${courseId}">
                                ${progress > 0 ? 'Continua' : 'Inizia'}
                            </button>
                        </div>
                    </div>
                `;

                return card;
            }

            async updateDashboardCourses(enrolledCourses) {
                // Update the dashboard with user's active courses
                const dashboardContainer = document.querySelector('#dashboard-page .courses-grid');
                if (!dashboardContainer) return;

                // Clear existing courses
                dashboardContainer.innerHTML = '';

                // Show top 2 most recent courses
                const recentCourses = Object.entries(enrolledCourses)
                    .sort(([,a], [,b]) => (b.lastAccessDate || 0) - (a.lastAccessDate || 0))
                    .slice(0, 2);

                for (const [courseId, enrollment] of recentCourses) {
                    try {
                        const snapshot = await database.ref(`courses/${courseId}`).once('value');
                        const courseData = snapshot.val();
                        
                        if (courseData) {
                            const courseCard = this.createUserCourseCard(courseId, courseData, enrollment);
                            dashboardContainer.appendChild(courseCard);
                        }
                    } catch (error) {
                        console.error(`Error loading course ${courseId}:`, error);
                    }
                }
            }

            getNextLesson() {
                const lessons = this.currentCourse.content?.lessons || {};
                const lessonEntries = Object.entries(lessons).sort(([,a], [,b]) => (a.order || 0) - (b.order || 0));
                
                const currentIndex = lessonEntries.findIndex(([id]) => id === this.currentLesson.id);
                
                if (currentIndex >= 0 && currentIndex < lessonEntries.length - 1) {
                    const [nextId, nextLesson] = lessonEntries[currentIndex + 1];
                    return { id: nextId, ...nextLesson };
                }
                
                return null;
            }

            async generateCertificate() {
                if (!this.currentCourse || !elearningAuth.currentUser) return;

                try {
                    // Create certificate data
                    const certificateData = {
                        courseId: this.currentCourse.id,
                        courseTitle: this.currentCourse.metadata.title,
                        studentName: `${elearningAuth.userProfile.personalInfo.firstName} ${elearningAuth.userProfile.personalInfo.lastName}`,
                        completionDate: new Date().toISOString(),
                        certificateId: this.generateCertificateId()
                    };

                    // Save certificate to user profile
                    await database.ref(`elearningUsers/${elearningAuth.currentUser.uid}/learningProgress/certificates/${certificateData.certificateId}`)
                        .set(certificateData);

                    // Generate and download certificate
                    this.downloadCertificate(certificateData);

                } catch (error) {
                    console.error('Error generating certificate:', error);
                    alert('Errore durante la generazione del certificato: ' + error.message);
                }
            }

            generateCertificateId() {
                return 'CERT-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9).toUpperCase();
            }

            downloadCertificate(certificateData) {
                // Create a simple certificate HTML
                const certificateHTML = `
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <meta charset="UTF-8">
                        <title>Certificato di Completamento</title>
                        <style>
                            body { font-family: 'Times New Roman', serif; text-align: center; padding: 50px; background: #f9f9f9; }
                            .certificate { background: white; padding: 60px; border: 10px solid #003B46; max-width: 800px; margin: 0 auto; }
                            .header { color: #003B46; margin-bottom: 30px; }
                            .title { font-size: 2.5em; margin-bottom: 20px; }
                            .subtitle { font-size: 1.2em; margin-bottom: 40px; }
                            .student-name { font-size: 2em; color: #07575B; margin: 30px 0; font-weight: bold; }
                            .course-title { font-size: 1.5em; color: #003B46; margin: 20px 0; }
                            .date { margin-top: 40px; font-size: 1.1em; }
                            .signature { margin-top: 50px; display: flex; justify-content: space-around; }
                            .signature div { text-align: center; }
                        </style>
                    </head>
                    <body>
                        <div class="certificate">
                            <div class="header">
                                <h1 class="title">CERTIFICATO DI COMPLETAMENTO</h1>
                                <p class="subtitle">DogWorld - Il Mondo del Cane</p>
                            </div>
                            
                            <p style="font-size: 1.2em;">Si certifica che</p>
                            
                            <div class="student-name">${certificateData.studentName}</div>
                            
                            <p style="font-size: 1.2em;">ha completato con successo il corso</p>
                            
                            <div class="course-title">"${certificateData.courseTitle}"</div>
                            
                            <div class="date">
                                <p>Data di completamento: ${new Date(certificateData.completionDate).toLocaleDateString('it-IT')}</p>
                                <p>Certificato ID: ${certificateData.certificateId}</p>
                            </div>
                            
                            <div class="signature">
                                <div>
                                    <div style="border-top: 2px solid #003B46; width: 200px; margin: 20px auto 10px;"></div>
                                    <p>DogWorld - Il Mondo del Cane</p>
                                </div>
                            </div>
                        </div>
                    </body>
                    </html>
                `;

                // Create and download the certificate
                const blob = new Blob([certificateHTML], { type: 'text/html' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `Certificato_${certificateData.courseTitle.replace(/[^a-zA-Z0-9]/g, '_')}_${certificateData.certificateId}.html`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

                alert('Certificato scaricato con successo!');
            }
        }

        // Progress Tracking System
        class ProgressTracker {
            async updateLessonProgress(courseId, lessonId, progress) {
                if (!elearningAuth.currentUser) return;

                try {
                    await database.ref(`elearningUsers/${elearningAuth.currentUser.uid}/learningProgress/enrolledCourses/${courseId}/lessonProgress/${lessonId}`)
                        .set({
                            progress: progress,
                            lastUpdate: firebase.database.ServerValue.TIMESTAMP
                        });

                    // Update overall course progress
                    await this.updateCourseProgress(courseId);

                } catch (error) {
                    console.error('Error updating lesson progress:', error);
                }
            }

            async markLessonCompleted(courseId, lessonId) {
                if (!elearningAuth.currentUser) return;

                try {
                    // Add to completed lessons
                    const completedRef = database.ref(`elearningUsers/${elearningAuth.currentUser.uid}/learningProgress/enrolledCourses/${courseId}/completedLessons`);
                    const snapshot = await completedRef.once('value');
                    const completed = snapshot.val() || [];
                    
                    if (!completed.includes(lessonId)) {
                        completed.push(lessonId);
                        await completedRef.set(completed);
                    }

                    // Update course progress
                    await this.updateCourseProgress(courseId);

                } catch (error) {
                    console.error('Error marking lesson completed:', error);
                }
            }

            async updateCourseProgress(courseId) {
                if (!elearningAuth.currentUser) return;

                try {
                    // Get course data
                    const courseSnapshot = await database.ref(`courses/${courseId}`).once('value');
                    const courseData = courseSnapshot.val();
                    
                    if (!courseData) return;

                    const totalLessons = Object.keys(courseData.content?.lessons || {}).length;
                    
                    // Get completed lessons
                    const completedSnapshot = await database.ref(`elearningUsers/${elearningAuth.currentUser.uid}/learningProgress/enrolledCourses/${courseId}/completedLessons`).once('value');
                    const completedLessons = completedSnapshot.val() || [];
                    
                    const completionPercentage = totalLessons > 0 ? (completedLessons.length / totalLessons) * 100 : 0;

                    // Update completion percentage
                    await database.ref(`elearningUsers/${elearningAuth.currentUser.uid}/learningProgress/enrolledCourses/${courseId}/completionPercentage`)
                        .set(completionPercentage);

                    // If course is completed, trigger completion event
                    if (completionPercentage >= 100) {
                        await this.onCourseCompleted(courseId);
                    }

                } catch (error) {
                    console.error('Error updating course progress:', error);
                }
            }

            async onCourseCompleted(courseId) {
                try {
                    // Mark course completion date
                    await database.ref(`elearningUsers/${elearningAuth.currentUser.uid}/learningProgress/enrolledCourses/${courseId}/completionDate`)
                        .set(firebase.database.ServerValue.TIMESTAMP);

                    // Send completion notification email
                    const courseSnapshot = await database.ref(`courses/${courseId}`).once('value');
                    const courseData = courseSnapshot.val();
                    
                    if (courseData) {
                        await this.sendCompletionNotification(courseData);
                    }

                } catch (error) {
                    console.error('Error handling course completion:', error);
                }
            }

            async sendCompletionNotification(courseData) {
                const emailData = {
                    type: 'Completamento Corso',
                    recipientEmail: elearningAuth.currentUser.email,
                    recipientName: `${elearningAuth.userProfile.personalInfo.firstName} ${elearningAuth.userProfile.personalInfo.lastName}`,
                    courseTitle: courseData.metadata.title,
                    completionDate: new Date().toLocaleDateString('it-IT')
                };

                try {
                    await fetch('/.netlify/functions/send-notification', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(emailData)
                    });
                } catch (error) {
                    console.error('Error sending completion notification:', error);
                }
            }
        }

        // Content Renderer for different content types
        class ContentRenderer {
            renderVideoContent(content) {
                return `
                    <div class="video-content">
                        <video controls style="width: 100%; max-width: 800px;">
                            <source src="${content.videoUrl}" type="video/mp4">
                            Il tuo browser non supporta il tag video.
                        </video>
                        ${content.transcript ? `
                            <div class="transcript" style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 5px;">
                                <h4>Trascrizione</h4>
                                <p>${content.transcript}</p>
                            </div>
                        ` : ''}
                    </div>
                `;
            }

            renderPDFContent(content) {
                return `
                    <div class="pdf-content">
                        <iframe src="${content.pdfUrl}" style="width: 100%; height: 600px; border: none;"></iframe>
                        <div style="margin-top: 15px; text-align: center;">
                            <a href="${content.pdfUrl}" target="_blank" class="btn-secondary">
                                <i class="fas fa-download"></i> Scarica PDF
                            </a>
                        </div>
                    </div>
                `;
            }
        }

        // Initialize course manager
        const courseManager = new CourseManager();

        // Update the existing initializeApp function
        async function initializeApp() {
            // Set up navigation
            setupNavigation();
            
            // Set up modals
            setupModals();
            
            // Initialize enhanced authentication
            await elearningAuth.initialize();
            
            // Initialize course manager
            await courseManager.initialize();
            
            // Set up form handlers
            setupFormHandlers();
            
            // Load initial data
            await loadPublicData();
            
            console.log('E-Learning platform initialized with course management');
        }
    </script>


    <!-- Advanced Quiz and Interactive System -->
    <script>
        // Enhanced Quiz System
        class QuizSystem {
            constructor() {
                this.currentQuiz = null;
                this.currentQuestionIndex = 0;
                this.userAnswers = {};
                this.quizStartTime = null;
                this.questionStartTime = null;
                this.timeSpent = {};
                this.attempts = {};
            }

            async openQuizLesson(lesson) {
                try {
                    // Load quiz data
                    const quizId = lesson.content.quizId;
                    const snapshot = await database.ref(`courses/${courseManager.currentCourse.id}/content/quizzes/${quizId}`).once('value');
                    this.currentQuiz = { id: quizId, ...snapshot.val() };
                    
                    if (!this.currentQuiz) {
                        alert('Quiz non trovato.');
                        return;
                    }

                    // Initialize quiz state
                    this.currentQuestionIndex = 0;
                    this.userAnswers = {};
                    this.quizStartTime = Date.now();
                    this.timeSpent = {};

                    // Load user's previous attempts
                    await this.loadQuizAttempts();

                    // Show quiz modal
                    this.showQuizModal();

                } catch (error) {
                    console.error('Error opening quiz:', error);
                    alert('Errore durante l\'apertura del quiz: ' + error.message);
                }
            }

            async loadQuizAttempts() {
                if (!elearningAuth.currentUser) return;

                try {
                    const snapshot = await database.ref(`elearningUsers/${elearningAuth.currentUser.uid}/learningProgress/enrolledCourses/${courseManager.currentCourse.id}/quizScores/${this.currentQuiz.id}`)
                        .once('value');
                    
                    this.attempts = snapshot.val() || { attempts: 0, bestScore: 0, scores: [] };
                } catch (error) {
                    console.error('Error loading quiz attempts:', error);
                    this.attempts = { attempts: 0, bestScore: 0, scores: [] };
                }
            }

            showQuizModal() {
                const modal = document.createElement('div');
                modal.className = 'modal';
                modal.id = 'quiz-modal';
                
                const questions = Object.entries(this.currentQuiz.questions || {});
                const maxAttempts = this.currentQuiz.maxAttempts || 3;
                const passingScore = this.currentQuiz.passingScore || 70;

                modal.innerHTML = `
                    <div class="modal-content-wrapper">
                        <div class="modal-content" style="max-width: 800px;">
                            <span class="close-btn" onclick="this.closest('.modal').remove()">×</span>
                            
                            <div id="quiz-intro" class="quiz-section">
                                <div class="quiz-header" style="text-align: center; margin-bottom: 30px;">
                                    <h2>${this.currentQuiz.title}</h2>
                                    <div class="quiz-info" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin: 20px 0; text-align: center;">
                                        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px;">
                                            <i class="fas fa-question-circle" style="color: var(--primary-color); font-size: 1.5em; margin-bottom: 5px;"></i>
                                            <p style="margin: 0; font-weight: 600;">${questions.length}</p>
                                            <p style="margin: 0; font-size: 0.9em; color: #666;">Domande</p>
                                        </div>
                                        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px;">
                                            <i class="fas fa-target" style="color: var(--success-color); font-size: 1.5em; margin-bottom: 5px;"></i>
                                            <p style="margin: 0; font-weight: 600;">${passingScore}%</p>
                                            <p style="margin: 0; font-size: 0.9em; color: #666;">Punteggio Minimo</p>
                                        </div>
                                        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px;">
                                            <i class="fas fa-redo" style="color: var(--warning-color); font-size: 1.5em; margin-bottom: 5px;"></i>
                                            <p style="margin: 0; font-weight: 600;">${maxAttempts}</p>
                                            <p style="margin: 0; font-size: 0.9em; color: #666;">Tentativi Max</p>
                                        </div>
                                        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px;">
                                            <i class="fas fa-trophy" style="color: var(--accent-color); font-size: 1.5em; margin-bottom: 5px;"></i>
                                            <p style="margin: 0; font-weight: 600;">${this.attempts.bestScore || 0}%</p>
                                            <p style="margin: 0; font-size: 0.9em; color: #666;">Miglior Punteggio</p>
                                        </div>
                                    </div>
                                </div>

                                ${this.attempts.attempts > 0 ? `
                                    <div class="previous-attempts" style="background: #e3f2fd; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                                        <h4 style="color: var(--primary-color); margin-bottom: 15px;">
                                            <i class="fas fa-history"></i> Tentativi Precedenti
                                        </h4>
                                        <p>Hai già completato questo quiz <strong>${this.attempts.attempts}</strong> volta/e.</p>
                                        <p>Miglior punteggio: <strong>${this.attempts.bestScore}%</strong></p>
                                        ${this.attempts.attempts >= maxAttempts ? `
                                            <div style="background: var(--danger-color); color: white; padding: 10px; border-radius: 5px; margin-top: 10px;">
                                                <i class="fas fa-exclamation-triangle"></i> Hai raggiunto il numero massimo di tentativi per questo quiz.
                                            </div>
                                        ` : ''}
                                    </div>
                                ` : ''}

                                <div class="quiz-instructions" style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 30px;">
                                    <h4><i class="fas fa-info-circle"></i> Istruzioni</h4>
                                    <ul style="margin: 10px 0; padding-left: 20px;">
                                        <li>Leggi attentamente ogni domanda prima di rispondere</li>
                                        <li>Puoi navigare tra le domande usando i pulsanti "Precedente" e "Successiva"</li>
                                        <li>Le tue risposte vengono salvate automaticamente</li>
                                        <li>Puoi rivedere le tue risposte prima di inviare il quiz</li>
                                        <li>Una volta inviato, non potrai più modificare le risposte</li>
                                    </ul>
                                </div>

                                <div style="text-align: center;">
                                    ${this.attempts.attempts < maxAttempts ? `
                                        <button onclick="quizSystem.startQuiz()" class="btn-primary" style="padding: 15px 30px; font-size: 1.1em;">
                                            <i class="fas fa-play"></i> ${this.attempts.attempts > 0 ? 'Riprova Quiz' : 'Inizia Quiz'}
                                        </button>
                                    ` : `
                                        <button class="btn-secondary" disabled style="padding: 15px 30px; font-size: 1.1em;">
                                            <i class="fas fa-ban"></i> Tentativi Esauriti
                                        </button>
                                    `}
                                </div>
                            </div>

                            <div id="quiz-content" class="quiz-section" style="display: none;">
                                <!-- Quiz questions will be loaded here -->
                            </div>

                            <div id="quiz-results" class="quiz-section" style="display: none;">
                                <!-- Quiz results will be shown here -->
                            </div>
                        </div>
                    </div>
                `;

                document.body.appendChild(modal);
                openModal(modal);
            }

            startQuiz() {
                this.questionStartTime = Date.now();
                this.showQuizSection('quiz-content');
                this.renderQuestion();
            }

            showQuizSection(sectionId) {
                document.querySelectorAll('.quiz-section').forEach(section => {
                    section.style.display = 'none';
                });
                document.getElementById(sectionId).style.display = 'block';
            }

            renderQuestion() {
                const questions = Object.entries(this.currentQuiz.questions || {});
                const [questionId, question] = questions[this.currentQuestionIndex];
                const totalQuestions = questions.length;

                const content = document.getElementById('quiz-content');
                content.innerHTML = `
                    <div class="quiz-progress" style="margin-bottom: 30px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <span style="font-weight: 600;">Domanda ${this.currentQuestionIndex + 1} di ${totalQuestions}</span>
                            <span style="color: #666;">Quiz: ${this.currentQuiz.title}</span>
                        </div>
                        <div style="width: 100%; height: 8px; background: #e0e0e0; border-radius: 4px; overflow: hidden;">
                            <div style="height: 100%; background: linear-gradient(90deg, var(--accent-color), var(--secondary-color)); width: ${((this.currentQuestionIndex + 1) / totalQuestions) * 100}%; transition: width 0.3s;"></div>
                        </div>
                    </div>

                    <div class="question-container">
                        <div class="question-header" style="margin-bottom: 25px;">
                            <h3 style="color: var(--primary-color); margin-bottom: 10px;">
                                ${question.question}
                            </h3>
                            ${question.points ? `<p style="color: #666; font-size: 0.9em;"><i class="fas fa-star"></i> ${question.points} punti</p>` : ''}
                        </div>

                        <div class="question-content">
                            ${this.renderQuestionByType(questionId, question)}
                        </div>
                    </div>

                    <div class="quiz-navigation" style="display: flex; justify-content: space-between; align-items: center; margin-top: 40px; padding-top: 20px; border-top: 1px solid #eee;">
                        <button onclick="quizSystem.previousQuestion()" 
                                class="btn-secondary" 
                                ${this.currentQuestionIndex === 0 ? 'disabled' : ''}>
                            <i class="fas fa-arrow-left"></i> Precedente
                        </button>

                        <div class="question-indicators" style="display: flex; gap: 5px;">
                            ${questions.map((_, index) => `
                                <div class="question-indicator ${index === this.currentQuestionIndex ? 'active' : ''} ${this.userAnswers[questions[index][0]] ? 'answered' : ''}" 
                                     style="width: 12px; height: 12px; border-radius: 50%; background: ${index === this.currentQuestionIndex ? 'var(--primary-color)' : this.userAnswers[questions[index][0]] ? 'var(--success-color)' : '#ddd'}; cursor: pointer;"
                                     onclick="quizSystem.goToQuestion(${index})"
                                     title="Domanda ${index + 1}">
                                </div>
                            `).join('')}
                        </div>

                        ${this.currentQuestionIndex === totalQuestions - 1 ? `
                            <button onclick="quizSystem.showReviewPage()" class="btn-primary">
                                <i class="fas fa-check"></i> Rivedi Risposte
                            </button>
                        ` : `
                            <button onclick="quizSystem.nextQuestion()" class="btn-primary">
                                Successiva <i class="fas fa-arrow-right"></i>
                            </button>
                        `}
                    </div>
                `;
            }

            renderQuestionByType(questionId, question) {
                const userAnswer = this.userAnswers[questionId];

                switch (question.type) {
                    case 'multiple_choice':
                        return `
                            <div class="multiple-choice-options">
                                ${question.options.map((option, index) => `
                                    <div class="answer-option ${userAnswer === index ? 'selected' : ''}" 
                                         onclick="quizSystem.selectAnswer('${questionId}', ${index})"
                                         style="display: flex; align-items: center; padding: 15px; margin: 10px 0; background: ${userAnswer === index ? 'var(--accent-color)' : '#f8f9fa'}; color: ${userAnswer === index ? 'white' : 'inherit'}; border-radius: 8px; cursor: pointer; transition: all 0.3s; border: 2px solid ${userAnswer === index ? 'var(--accent-color)' : 'transparent'};">
                                        <div style="width: 20px; height: 20px; border-radius: 50%; border: 2px solid ${userAnswer === index ? 'white' : '#ddd'}; margin-right: 15px; display: flex; align-items: center; justify-content: center; background: ${userAnswer === index ? 'white' : 'transparent'};">
                                            ${userAnswer === index ? '<div style="width: 8px; height: 8px; border-radius: 50%; background: var(--accent-color);"></div>' : ''}
                                        </div>
                                        <span>${option}</span>
                                    </div>
                                `).join('')}
                            </div>
                        `;

                    case 'true_false':
                        return `
                            <div class="true-false-options" style="display: flex; gap: 20px; justify-content: center;">
                                <div class="answer-option ${userAnswer === true ? 'selected' : ''}" 
                                     onclick="quizSystem.selectAnswer('${questionId}', true)"
                                     style="flex: 1; text-align: center; padding: 20px; background: ${userAnswer === true ? 'var(--success-color)' : '#f8f9fa'}; color: ${userAnswer === true ? 'white' : 'inherit'}; border-radius: 8px; cursor: pointer; transition: all 0.3s; border: 2px solid ${userAnswer === true ? 'var(--success-color)' : 'transparent'};">
                                    <i class="fas fa-check" style="font-size: 2em; margin-bottom: 10px;"></i>
                                    <p style="margin: 0; font-weight: 600;">VERO</p>
                                </div>
                                <div class="answer-option ${userAnswer === false ? 'selected' : ''}" 
                                     onclick="quizSystem.selectAnswer('${questionId}', false)"
                                     style="flex: 1; text-align: center; padding: 20px; background: ${userAnswer === false ? 'var(--danger-color)' : '#f8f9fa'}; color: ${userAnswer === false ? 'white' : 'inherit'}; border-radius: 8px; cursor: pointer; transition: all 0.3s; border: 2px solid ${userAnswer === false ? 'var(--danger-color)' : 'transparent'};">
                                    <i class="fas fa-times" style="font-size: 2em; margin-bottom: 10px;"></i>
                                    <p style="margin: 0; font-weight: 600;">FALSO</p>
                                </div>
                            </div>
                        `;

                    case 'open_ended':
                        return `
                            <div class="open-ended-answer">
                                <textarea id="answer-${questionId}" 
                                          placeholder="Scrivi la tua risposta qui..."
                                          style="width: 100%; min-height: 120px; padding: 15px; border: 2px solid #ddd; border-radius: 8px; font-family: var(--font-family); resize: vertical;"
                                          onchange="quizSystem.selectAnswer('${questionId}', this.value)">${userAnswer || ''}</textarea>
                                <p style="margin-top: 10px; color: #666; font-size: 0.9em;">
                                    <i class="fas fa-info-circle"></i> Fornisci una risposta dettagliata e completa.
                                </p>
                            </div>
                        `;

                    default:
                        return '<p>Tipo di domanda non supportato.</p>';
                }
            }

            selectAnswer(questionId, answer) {
                // Record time spent on this question
                if (this.questionStartTime) {
                    const timeSpent = Date.now() - this.questionStartTime;
                    this.timeSpent[questionId] = (this.timeSpent[questionId] || 0) + timeSpent;
                }

                this.userAnswers[questionId] = answer;
                this.questionStartTime = Date.now();

                // Re-render to update UI
                this.renderQuestion();
            }

            previousQuestion() {
                if (this.currentQuestionIndex > 0) {
                    this.currentQuestionIndex--;
                    this.questionStartTime = Date.now();
                    this.renderQuestion();
                }
            }

            nextQuestion() {
                const questions = Object.entries(this.currentQuiz.questions || {});
                if (this.currentQuestionIndex < questions.length - 1) {
                    this.currentQuestionIndex++;
                    this.questionStartTime = Date.now();
                    this.renderQuestion();
                }
            }

            goToQuestion(index) {
                this.currentQuestionIndex = index;
                this.questionStartTime = Date.now();
                this.renderQuestion();
            }

            showReviewPage() {
                const questions = Object.entries(this.currentQuiz.questions || {});
                const answeredCount = Object.keys(this.userAnswers).length;
                const unansweredQuestions = questions.filter(([id]) => !this.userAnswers.hasOwnProperty(id));

                const content = document.getElementById('quiz-content');
                content.innerHTML = `
                    <div class="quiz-review">
                        <h3 style="color: var(--primary-color); margin-bottom: 20px;">
                            <i class="fas fa-clipboard-check"></i> Rivedi le Tue Risposte
                        </h3>

                        <div class="review-summary" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 30px;">
                            <div style="background: #e8f5e8; padding: 15px; border-radius: 8px; text-align: center;">
                                <i class="fas fa-check-circle" style="color: var(--success-color); font-size: 1.5em; margin-bottom: 5px;"></i>
                                <p style="margin: 0; font-weight: 600;">${answeredCount}</p>
                                <p style="margin: 0; font-size: 0.9em;">Risposte Date</p>
                            </div>
                            <div style="background: #ffebee; padding: 15px; border-radius: 8px; text-align: center;">
                                <i class="fas fa-question-circle" style="color: var(--danger-color); font-size: 1.5em; margin-bottom: 5px;"></i>
                                <p style="margin: 0; font-weight: 600;">${unansweredQuestions.length}</p>
                                <p style="margin: 0; font-size: 0.9em;">Non Risposte</p>
                            </div>
                            <div style="background: #e3f2fd; padding: 15px; border-radius: 8px; text-align: center;">
                                <i class="fas fa-clock" style="color: var(--primary-color); font-size: 1.5em; margin-bottom: 5px;"></i>
                                <p style="margin: 0; font-weight: 600;">${Math.round((Date.now() - this.quizStartTime) / 60000)}</p>
                                <p style="margin: 0; font-size: 0.9em;">Minuti Trascorsi</p>
                            </div>
                        </div>

                        ${unansweredQuestions.length > 0 ? `
                            <div class="unanswered-warning" style="background: #fff3cd; border: 1px solid #ffeaa7; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                                <h4 style="color: #856404; margin-bottom: 10px;">
                                    <i class="fas fa-exclamation-triangle"></i> Domande Non Risposte
                                </h4>
                                <p style="margin-bottom: 10px;">Le seguenti domande non hanno ancora una risposta:</p>
                                <ul style="margin: 0; padding-left: 20px;">
                                    ${unansweredQuestions.map(([id, question], index) => `
                                        <li style="margin-bottom: 5px;">
                                            <a href="#" onclick="quizSystem.goToQuestion(${questions.findIndex(([qId]) => qId === id)}); return false;" 
                                               style="color: var(--primary-color); text-decoration: underline;">
                                                Domanda ${questions.findIndex(([qId]) => qId === id) + 1}: ${question.question.substring(0, 50)}...
                                            </a>
                                        </li>
                                    `).join('')}
                                </ul>
                            </div>
                        ` : ''}

                        <div class="review-questions" style="margin-bottom: 30px;">
                            <h4>Riepilogo Risposte</h4>
                            ${questions.map(([questionId, question], index) => `
                                <div class="review-question" style="background: #f8f9fa; padding: 15px; margin: 10px 0; border-radius: 8px; border-left: 4px solid ${this.userAnswers[questionId] ? 'var(--success-color)' : 'var(--danger-color)'};">
                                    <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                                        <div style="flex: 1;">
                                            <h5 style="margin: 0 0 10px 0; color: var(--primary-color);">
                                                Domanda ${index + 1}: ${question.question}
                                            </h5>
                                            <p style="margin: 0; color: #666;">
                                                <strong>Risposta:</strong> 
                                                ${this.userAnswers[questionId] !== undefined ? 
                                                    this.formatAnswerForReview(question, this.userAnswers[questionId]) : 
                                                    '<em style="color: var(--danger-color);">Non risposta</em>'
                                                }
                                            </p>
                                        </div>
                                        <button onclick="quizSystem.goToQuestion(${index})" 
                                                class="btn-secondary" 
                                                style="margin-left: 15px; padding: 5px 10px; font-size: 0.8em;">
                                            Modifica
                                        </button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>

                        <div class="review-actions" style="display: flex; gap: 15px; justify-content: center;">
                            <button onclick="quizSystem.goToQuestion(0)" class="btn-secondary">
                                <i class="fas fa-edit"></i> Continua a Modificare
                            </button>
                            <button onclick="quizSystem.submitQuiz()" class="btn-primary" style="padding: 15px 30px;">
                                <i class="fas fa-paper-plane"></i> Invia Quiz
                            </button>
                        </div>
                    </div>
                `;
            }

            formatAnswerForReview(question, answer) {
                switch (question.type) {
                    case 'multiple_choice':
                        return question.options[answer] || 'Risposta non valida';
                    case 'true_false':
                        return answer ? 'VERO' : 'FALSO';
                    case 'open_ended':
                        return answer.length > 100 ? answer.substring(0, 100) + '...' : answer;
                    default:
                        return String(answer);
                }
            }

            async submitQuiz() {
                if (!confirm('Sei sicuro di voler inviare il quiz? Non potrai più modificare le risposte.')) {
                    return;
                }

                try {
                    // Calculate score
                    const score = this.calculateScore();
                    const totalTime = Date.now() - this.quizStartTime;

                    // Save quiz attempt
                    await this.saveQuizAttempt(score, totalTime);

                    // Show results
                    this.showQuizResults(score, totalTime);

                } catch (error) {
                    console.error('Error submitting quiz:', error);
                    alert('Errore durante l\'invio del quiz: ' + error.message);
                }
            }

            calculateScore() {
                const questions = Object.entries(this.currentQuiz.questions || {});
                let totalPoints = 0;
                let earnedPoints = 0;

                questions.forEach(([questionId, question]) => {
                    const points = question.points || 1;
                    totalPoints += points;

                    const userAnswer = this.userAnswers[questionId];
                    const correctAnswer = question.correctAnswer;

                    if (this.isAnswerCorrect(question, userAnswer, correctAnswer)) {
                        earnedPoints += points;
                    }
                });

                return totalPoints > 0 ? Math.round((earnedPoints / totalPoints) * 100) : 0;
            }

            isAnswerCorrect(question, userAnswer, correctAnswer) {
                if (userAnswer === undefined || userAnswer === null) return false;

                switch (question.type) {
                    case 'multiple_choice':
                    case 'true_false':
                        return userAnswer === correctAnswer;
                    case 'open_ended':
                        // For open-ended questions, we'll need manual grading
                        // For now, we'll give partial credit if the answer contains key terms
                        const userText = String(userAnswer).toLowerCase();
                        const correctText = String(correctAnswer).toLowerCase();
                        return userText.includes(correctText) || correctText.includes(userText);
                    default:
                        return false;
                }
            }

            async saveQuizAttempt(score, totalTime) {
                if (!elearningAuth.currentUser) return;

                const attemptData = {
                    score: score,
                    totalTime: totalTime,
                    answers: this.userAnswers,
                    timeSpent: this.timeSpent,
                    timestamp: firebase.database.ServerValue.TIMESTAMP
                };

                // Update attempts count and best score
                const newAttempts = (this.attempts.attempts || 0) + 1;
                const newBestScore = Math.max(this.attempts.bestScore || 0, score);
                const scores = [...(this.attempts.scores || []), score];

                await database.ref(`elearningUsers/${elearningAuth.currentUser.uid}/learningProgress/enrolledCourses/${courseManager.currentCourse.id}/quizScores/${this.currentQuiz.id}`)
                    .set({
                        attempts: newAttempts,
                        bestScore: newBestScore,
                        scores: scores,
                        lastAttempt: attemptData
                    });

                // If quiz is passed, mark lesson as completed
                const passingScore = this.currentQuiz.passingScore || 70;
                if (score >= passingScore) {
                    await courseManager.progressTracker.markLessonCompleted(
                        courseManager.currentCourse.id,
                        courseManager.currentLesson.id
                    );
                }
            }

            showQuizResults(score, totalTime) {
                const passingScore = this.currentQuiz.passingScore || 70;
                const passed = score >= passingScore;
                const questions = Object.entries(this.currentQuiz.questions || {});

                this.showQuizSection('quiz-results');

                const content = document.getElementById('quiz-results');
                content.innerHTML = `
                    <div class="quiz-results-container" style="text-align: center;">
                        <div class="result-header" style="margin-bottom: 30px;">
                            <div style="font-size: 4em; margin-bottom: 15px; color: ${passed ? 'var(--success-color)' : 'var(--danger-color)'};">
                                <i class="fas ${passed ? 'fa-check-circle' : 'fa-times-circle'}"></i>
                            </div>
                            <h2 style="color: ${passed ? 'var(--success-color)' : 'var(--danger-color)'}; margin-bottom: 10px;">
                                ${passed ? 'Quiz Superato!' : 'Quiz Non Superato'}
                            </h2>
                            <p style="font-size: 1.2em; color: #666;">
                                ${passed ? 'Congratulazioni! Hai superato il quiz.' : 'Non hai raggiunto il punteggio minimo richiesto.'}
                            </p>
                        </div>

                        <div class="score-display" style="background: linear-gradient(135deg, ${passed ? 'var(--success-color)' : 'var(--danger-color)'}, ${passed ? '#66bb6a' : '#e57373'}); color: white; padding: 30px; border-radius: 15px; margin-bottom: 30px;">
                            <h3 style="color: white; margin-bottom: 15px;">Il Tuo Punteggio</h3>
                            <div style="font-size: 3em; font-weight: bold; margin-bottom: 10px;">${score}%</div>
                            <p style="margin: 0; opacity: 0.9;">Punteggio minimo richiesto: ${passingScore}%</p>
                        </div>

                        <div class="result-details" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px;">
                            <div style="background: #f8f9fa; padding: 20px; border-radius: 8px;">
                                <i class="fas fa-question-circle" style="color: var(--primary-color); font-size: 1.5em; margin-bottom: 10px;"></i>
                                <h4 style="margin: 0 0 5px 0;">Domande Totali</h4>
                                <p style="margin: 0; font-size: 1.2em; font-weight: 600;">${questions.length}</p>
                            </div>
                            <div style="background: #f8f9fa; padding: 20px; border-radius: 8px;">
                                <i class="fas fa-check" style="color: var(--success-color); font-size: 1.5em; margin-bottom: 10px;"></i>
                                <h4 style="margin: 0 0 5px 0;">Risposte Corrette</h4>
                                <p style="margin: 0; font-size: 1.2em; font-weight: 600;">${this.getCorrectAnswersCount()}</p>
                            </div>
                            <div style="background: #f8f9fa; padding: 20px; border-radius: 8px;">
                                <i class="fas fa-clock" style="color: var(--accent-color); font-size: 1.5em; margin-bottom: 10px;"></i>
                                <h4 style="margin: 0 0 5px 0;">Tempo Impiegato</h4>
                                <p style="margin: 0; font-size: 1.2em; font-weight: 600;">${Math.round(totalTime / 60000)} min</p>
                            </div>
                            <div style="background: #f8f9fa; padding: 20px; border-radius: 8px;">
                                <i class="fas fa-redo" style="color: var(--warning-color); font-size: 1.5em; margin-bottom: 10px;"></i>
                                <h4 style="margin: 0 0 5px 0;">Tentativo</h4>
                                <p style="margin: 0; font-size: 1.2em; font-weight: 600;">${(this.attempts.attempts || 0) + 1}</p>
                            </div>
                        </div>

                        <div class="detailed-results" style="text-align: left; margin-bottom: 30px;">
                            <h4 style="text-align: center; margin-bottom: 20px;">Dettaglio Risposte</h4>
                            ${questions.map(([questionId, question], index) => {
                                const userAnswer = this.userAnswers[questionId];
                                const isCorrect = this.isAnswerCorrect(question, userAnswer, question.correctAnswer);
                                
                                return `
                                    <div class="result-question" style="background: ${isCorrect ? '#e8f5e8' : '#ffebee'}; padding: 15px; margin: 10px 0; border-radius: 8px; border-left: 4px solid ${isCorrect ? 'var(--success-color)' : 'var(--danger-color)'};">
                                        <div style="display: flex; align-items: flex-start; gap: 15px;">
                                            <div style="color: ${isCorrect ? 'var(--success-color)' : 'var(--danger-color)'}; font-size: 1.2em;">
                                                <i class="fas ${isCorrect ? 'fa-check' : 'fa-times'}"></i>
                                            </div>
                                            <div style="flex: 1;">
                                                <h5 style="margin: 0 0 10px 0;">Domanda ${index + 1}: ${question.question}</h5>
                                                <p style="margin: 5px 0;"><strong>La tua risposta:</strong> ${this.formatAnswerForReview(question, userAnswer)}</p>
                                                <p style="margin: 5px 0;"><strong>Risposta corretta:</strong> ${this.formatAnswerForReview(question, question.correctAnswer)}</p>
                                                ${question.explanation ? `<p style="margin: 5px 0; font-style: italic; color: #666;"><strong>Spiegazione:</strong> ${question.explanation}</p>` : ''}
                                            </div>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>

                        <div class="result-actions" style="display: flex; gap: 15px; justify-content: center;">
                            ${!passed && (this.attempts.attempts || 0) + 1 < (this.currentQuiz.maxAttempts || 3) ? `
                                <button onclick="quizSystem.retakeQuiz()" class="btn-primary">
                                    <i class="fas fa-redo"></i> Riprova Quiz
                                </button>
                            ` : ''}
                            <button onclick="document.getElementById('quiz-modal').remove(); courseManager.openCourse('${courseManager.currentCourse.id}')" class="btn-secondary">
                                <i class="fas fa-arrow-left"></i> Torna al Corso
                            </button>
                            ${passed ? `
                                <button onclick="quizSystem.continueToNextLesson()" class="btn-primary">
                                    <i class="fas fa-arrow-right"></i> Continua
                                </button>
                            ` : ''}
                        </div>
                    </div>
                `;
            }

            getCorrectAnswersCount() {
                const questions = Object.entries(this.currentQuiz.questions || {});
                let correctCount = 0;

                questions.forEach(([questionId, question]) => {
                    const userAnswer = this.userAnswers[questionId];
                    if (this.isAnswerCorrect(question, userAnswer, question.correctAnswer)) {
                        correctCount++;
                    }
                });

                return correctCount;
            }

            retakeQuiz() {
                // Reset quiz state
                this.currentQuestionIndex = 0;
                this.userAnswers = {};
                this.quizStartTime = Date.now();
                this.timeSpent = {};

                // Start quiz again
                this.startQuiz();
            }

            continueToNextLesson() {
                document.getElementById('quiz-modal').remove();
                
                const nextLesson = courseManager.getNextLesson();
                if (nextLesson) {
                    courseManager.openLesson(nextLesson.id);
                } else {
                    // Course completed
                    courseManager.generateCertificate();
                }
            }
        }

        // Initialize quiz system
        const quizSystem = new QuizSystem();

        // Update CourseManager to use quiz system
        CourseManager.prototype.openQuizLesson = function(lesson) {
            quizSystem.openQuizLesson(lesson);
        };

        // Add CSS for quiz system
        const quizCSS = `
            <style>
                .quiz-section {
                    animation: fadeIn 0.3s ease-in-out;
                }
                
                .answer-option:hover {
                    transform: translateY(-2px);
                    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
                }
                
                .question-indicator {
                    transition: all 0.3s ease;
                }
                
                .question-indicator:hover {
                    transform: scale(1.2);
                }
                
                .result-question {
                    transition: all 0.3s ease;
                }
                
                .result-question:hover {
                    transform: translateX(5px);
                }
                
                @keyframes pulse {
                    0% { transform: scale(1); }
                    50% { transform: scale(1.05); }
                    100% { transform: scale(1); }
                }
                
                .score-display {
                    animation: pulse 2s ease-in-out;
                }
            </style>
        `;
        
        document.head.insertAdjacentHTML('beforeend', quizCSS);
    </script>


    <!-- Enhanced Design Integration with Main Site -->
    <style>
        /* Import Google Fonts matching main site */
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&family=Inter:wght@300;400;500;600;700&display=swap');

        /* Enhanced CSS Variables matching main site design */
        :root {
            /* Primary Colors from DogWorld site */
            --primary-color: #003B46;
            --secondary-color: #07575B;
            --accent-color: #66A5AD;
            --highlight-color: #C4DFE6;
            --warning-color: #FFB74D;
            --success-color: #4CAF50;
            --danger-color: #F44336;
            --info-color: #2196F3;

            /* Enhanced Color Palette */
            --primary-dark: #002329;
            --primary-light: #004d5a;
            --secondary-dark: #054449;
            --secondary-light: #0a6b70;
            --accent-dark: #5a9aa1;
            --accent-light: #7db1b8;

            /* Typography */
            --font-family: 'Poppins', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            --font-family-secondary: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            --font-size-xs: 0.75rem;
            --font-size-sm: 0.875rem;
            --font-size-base: 1rem;
            --font-size-lg: 1.125rem;
            --font-size-xl: 1.25rem;
            --font-size-2xl: 1.5rem;
            --font-size-3xl: 1.875rem;
            --font-size-4xl: 2.25rem;

            /* Spacing */
            --spacing-xs: 0.25rem;
            --spacing-sm: 0.5rem;
            --spacing-md: 1rem;
            --spacing-lg: 1.5rem;
            --spacing-xl: 2rem;
            --spacing-2xl: 3rem;
            --spacing-3xl: 4rem;

            /* Border Radius */
            --radius-sm: 0.375rem;
            --radius-md: 0.5rem;
            --radius-lg: 0.75rem;
            --radius-xl: 1rem;
            --radius-2xl: 1.5rem;

            /* Shadows */
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);

            /* Transitions */
            --transition-fast: 0.15s ease-in-out;
            --transition-normal: 0.3s ease-in-out;
            --transition-slow: 0.5s ease-in-out;
        }

        /* Enhanced Global Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-family);
            line-height: 1.6;
            color: var(--primary-color);
            background: linear-gradient(135deg, #f8fafb 0%, #e8f4f8 100%);
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Enhanced Header Styles */
        .header {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: white;
            padding: var(--spacing-lg) 0;
            box-shadow: var(--shadow-lg);
            position: relative;
            overflow: hidden;
        }

        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grain" width="100" height="100" patternUnits="userSpaceOnUse"><circle cx="25" cy="25" r="1" fill="rgba(255,255,255,0.05)"/><circle cx="75" cy="75" r="1" fill="rgba(255,255,255,0.05)"/><circle cx="50" cy="10" r="0.5" fill="rgba(255,255,255,0.03)"/><circle cx="10" cy="60" r="0.5" fill="rgba(255,255,255,0.03)"/><circle cx="90" cy="40" r="0.5" fill="rgba(255,255,255,0.03)"/></pattern></defs><rect width="100" height="100" fill="url(%23grain)"/></svg>');
            opacity: 0.3;
            pointer-events: none;
        }

        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 var(--spacing-lg);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
            z-index: 1;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
            font-size: var(--font-size-2xl);
            font-weight: 700;
            text-decoration: none;
            color: white;
            transition: var(--transition-normal);
        }

        .logo:hover {
            transform: translateY(-2px);
            text-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }

        .logo-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--accent-color), var(--highlight-color));
            border-radius: var(--radius-lg);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5em;
            color: var(--primary-color);
            box-shadow: var(--shadow-md);
        }

        /* Enhanced Navigation Styles */
        .nav-menu {
            display: flex;
            list-style: none;
            gap: var(--spacing-lg);
            align-items: center;
        }

        .nav-item {
            position: relative;
        }

        .nav-link {
            color: white;
            text-decoration: none;
            font-weight: 500;
            padding: var(--spacing-sm) var(--spacing-md);
            border-radius: var(--radius-md);
            transition: var(--transition-normal);
            position: relative;
            overflow: hidden;
        }

        .nav-link::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: var(--transition-normal);
        }

        .nav-link:hover::before {
            left: 100%;
        }

        .nav-link:hover {
            background: rgba(255,255,255,0.1);
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .nav-link.active {
            background: var(--accent-color);
            color: var(--primary-color);
            font-weight: 600;
        }

        /* Enhanced Mobile Menu */
        .mobile-menu-toggle {
            display: none;
            background: none;
            border: none;
            color: white;
            font-size: 1.5em;
            cursor: pointer;
            padding: var(--spacing-sm);
            border-radius: var(--radius-md);
            transition: var(--transition-normal);
        }

        .mobile-menu-toggle:hover {
            background: rgba(255,255,255,0.1);
        }

        /* Enhanced Main Content */
        .main-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: var(--spacing-2xl) var(--spacing-lg);
            position: relative;
        }

        /* Enhanced Page Styles */
        .page {
            display: none;
            animation: fadeInUp 0.6s ease-out;
        }

        .page.active {
            display: block;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Enhanced Section Styles */
        .section {
            background: white;
            border-radius: var(--radius-xl);
            padding: var(--spacing-2xl);
            margin-bottom: var(--spacing-2xl);
            box-shadow: var(--shadow-lg);
            position: relative;
            overflow: hidden;
            border: 1px solid rgba(102, 165, 173, 0.1);
        }

        .section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--accent-color), var(--highlight-color));
        }

        .section-title {
            font-size: var(--font-size-3xl);
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: var(--spacing-lg);
            position: relative;
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
        }

        .section-title::after {
            content: '';
            flex: 1;
            height: 2px;
            background: linear-gradient(90deg, var(--accent-color), transparent);
            margin-left: var(--spacing-lg);
        }

        /* Enhanced Card Styles */
        .course-card {
            background: white;
            border-radius: var(--radius-xl);
            overflow: hidden;
            box-shadow: var(--shadow-md);
            transition: var(--transition-normal);
            border: 1px solid rgba(102, 165, 173, 0.1);
            position: relative;
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        .course-card:hover {
            transform: translateY(-8px);
            box-shadow: var(--shadow-xl);
            border-color: var(--accent-color);
        }

        .course-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, transparent 0%, rgba(102, 165, 173, 0.05) 100%);
            opacity: 0;
            transition: var(--transition-normal);
            pointer-events: none;
        }

        .course-card:hover::before {
            opacity: 1;
        }

        .course-thumbnail {
            width: 100%;
            height: 200px;
            object-fit: cover;
            transition: var(--transition-normal);
        }

        .course-card:hover .course-thumbnail {
            transform: scale(1.05);
        }

        .course-content {
            padding: var(--spacing-lg);
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .course-title {
            font-size: var(--font-size-xl);
            font-weight: 600;
            color: var(--primary-color);
            margin-bottom: var(--spacing-sm);
            line-height: 1.3;
        }

        .course-description {
            color: #666;
            margin-bottom: var(--spacing-md);
            flex: 1;
            line-height: 1.5;
        }

        .course-meta {
            display: flex;
            gap: var(--spacing-md);
            margin-bottom: var(--spacing-md);
            flex-wrap: wrap;
        }

        .course-meta span {
            background: var(--highlight-color);
            color: var(--primary-color);
            padding: var(--spacing-xs) var(--spacing-sm);
            border-radius: var(--radius-md);
            font-size: var(--font-size-sm);
            font-weight: 500;
        }

        .course-difficulty {
            text-transform: capitalize;
        }

        .difficulty-beginner {
            background: #e8f5e9 !important;
            color: var(--success-color) !important;
        }

        .difficulty-intermediate {
            background: #fff3e0 !important;
            color: var(--warning-color) !important;
        }

        .difficulty-advanced {
            background: #ffebee !important;
            color: var(--danger-color) !important;
        }

        /* Enhanced Progress Bar */
        .course-progress {
            width: 100%;
            height: 8px;
            background: #e0e0e0;
            border-radius: var(--radius-md);
            overflow: hidden;
            margin-bottom: var(--spacing-md);
            position: relative;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--accent-color), var(--secondary-color));
            border-radius: var(--radius-md);
            transition: width 0.6s ease-out;
            position: relative;
        }

        .progress-bar::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            animation: shimmer 2s infinite;
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        /* Enhanced Button Styles */
        .btn-primary, .btn-secondary, .btn-success, .btn-warning, .btn-danger {
            padding: var(--spacing-sm) var(--spacing-lg);
            border: none;
            border-radius: var(--radius-lg);
            font-family: var(--font-family);
            font-weight: 600;
            font-size: var(--font-size-base);
            cursor: pointer;
            transition: var(--transition-normal);
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: var(--spacing-sm);
            position: relative;
            overflow: hidden;
            min-height: 44px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            box-shadow: var(--shadow-md);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
            background: linear-gradient(135deg, var(--primary-dark), var(--secondary-dark));
        }

        .btn-secondary {
            background: linear-gradient(135deg, var(--accent-color), var(--highlight-color));
            color: var(--primary-color);
            box-shadow: var(--shadow-md);
        }

        .btn-secondary:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
            background: linear-gradient(135deg, var(--accent-dark), var(--accent-light));
        }

        .btn-success {
            background: linear-gradient(135deg, var(--success-color), #66bb6a);
            color: white;
        }

        .btn-warning {
            background: linear-gradient(135deg, var(--warning-color), #ffcc02);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--danger-color), #e57373);
            color: white;
        }

        /* Enhanced Form Styles */
        .form-container {
            background: white;
            padding: var(--spacing-2xl);
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-lg);
            border: 1px solid rgba(102, 165, 173, 0.1);
        }

        .form-group {
            margin-bottom: var(--spacing-lg);
        }

        label {
            display: block;
            margin-bottom: var(--spacing-sm);
            font-weight: 600;
            color: var(--primary-color);
            font-size: var(--font-size-sm);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        input, textarea, select {
            width: 100%;
            padding: var(--spacing-md);
            border: 2px solid #e0e0e0;
            border-radius: var(--radius-lg);
            font-family: var(--font-family);
            font-size: var(--font-size-base);
            transition: var(--transition-normal);
            background: white;
        }

        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 0 3px rgba(102, 165, 173, 0.1);
            transform: translateY(-1px);
        }

        /* Enhanced Modal Styles */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 59, 70, 0.8);
            backdrop-filter: blur(8px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: var(--transition-normal);
        }

        .modal.active {
            opacity: 1;
            visibility: visible;
        }

        .modal-content-wrapper {
            max-width: 90vw;
            max-height: 90vh;
            overflow-y: auto;
            animation: modalSlideIn 0.4s ease-out;
        }

        .modal-content {
            background: white;
            border-radius: var(--radius-2xl);
            padding: var(--spacing-2xl);
            position: relative;
            box-shadow: var(--shadow-xl);
            border: 1px solid rgba(102, 165, 173, 0.1);
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-50px) scale(0.9);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .close-btn {
            position: absolute;
            top: var(--spacing-lg);
            right: var(--spacing-lg);
            background: none;
            border: none;
            font-size: var(--font-size-2xl);
            color: #999;
            cursor: pointer;
            transition: var(--transition-normal);
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .close-btn:hover {
            background: var(--danger-color);
            color: white;
            transform: rotate(90deg);
        }

        /* Enhanced Grid Layouts */
        .courses-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: var(--spacing-xl);
            margin-top: var(--spacing-xl);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: var(--spacing-lg);
            margin-bottom: var(--spacing-2xl);
        }

        .stat-card {
            background: white;
            padding: var(--spacing-xl);
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-md);
            text-align: center;
            border: 1px solid rgba(102, 165, 173, 0.1);
            transition: var(--transition-normal);
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--accent-color), var(--highlight-color));
        }

        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
        }

        .stat-icon {
            font-size: var(--font-size-4xl);
            margin-bottom: var(--spacing-md);
            background: linear-gradient(135deg, var(--accent-color), var(--highlight-color));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .stat-number {
            font-size: var(--font-size-3xl);
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: var(--spacing-sm);
        }

        .stat-label {
            color: #666;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-size: var(--font-size-sm);
        }

        /* Enhanced Admin Styles */
        .admin-mode .admin-controls {
            opacity: 1;
            visibility: visible;
        }

        .admin-controls {
            position: absolute;
            top: var(--spacing-sm);
            right: var(--spacing-sm);
            display: flex;
            gap: var(--spacing-xs);
            opacity: 0;
            visibility: hidden;
            transition: var(--transition-normal);
            z-index: 10;
        }

        .admin-btn {
            width: 32px;
            height: 32px;
            border: none;
            border-radius: var(--radius-md);
            background: rgba(0, 59, 70, 0.8);
            color: white;
            cursor: pointer;
            transition: var(--transition-normal);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: var(--font-size-sm);
        }

        .admin-btn:hover {
            background: var(--accent-color);
            transform: scale(1.1);
        }

        /* Enhanced Responsive Design */
        @media (max-width: 768px) {
            .nav-menu {
                display: none;
                position: absolute;
                top: 100%;
                left: 0;
                right: 0;
                background: var(--primary-color);
                flex-direction: column;
                padding: var(--spacing-lg);
                box-shadow: var(--shadow-lg);
                border-radius: 0 0 var(--radius-lg) var(--radius-lg);
            }

            .nav-menu.active {
                display: flex;
            }

            .mobile-menu-toggle {
                display: block;
            }

            .header-content {
                padding: 0 var(--spacing-md);
            }

            .main-content {
                padding: var(--spacing-lg) var(--spacing-md);
            }

            .section {
                padding: var(--spacing-lg);
                margin-bottom: var(--spacing-lg);
            }

            .courses-grid {
                grid-template-columns: 1fr;
                gap: var(--spacing-lg);
            }

            .stats-grid {
                grid-template-columns: 1fr;
                gap: var(--spacing-md);
            }

            .modal-content {
                padding: var(--spacing-lg);
                margin: var(--spacing-md);
            }

            .form-container {
                padding: var(--spacing-lg);
            }
        }

        /* Enhanced Loading States */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Enhanced Utility Classes */
        .text-center { text-align: center; }
        .text-left { text-align: left; }
        .text-right { text-align: right; }
        .font-bold { font-weight: 700; }
        .font-semibold { font-weight: 600; }
        .font-medium { font-weight: 500; }
        .text-primary { color: var(--primary-color); }
        .text-secondary { color: var(--secondary-color); }
        .text-accent { color: var(--accent-color); }
        .text-muted { color: #666; }
        .bg-primary { background: var(--primary-color); }
        .bg-secondary { background: var(--secondary-color); }
        .bg-accent { background: var(--accent-color); }
        .rounded { border-radius: var(--radius-md); }
        .rounded-lg { border-radius: var(--radius-lg); }
        .rounded-xl { border-radius: var(--radius-xl); }
        .shadow { box-shadow: var(--shadow-md); }
        .shadow-lg { box-shadow: var(--shadow-lg); }
        .transition { transition: var(--transition-normal); }

        /* Enhanced Animations */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideInLeft {
            from { transform: translateX(-100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        @keyframes bounceIn {
            0% { transform: scale(0.3); opacity: 0; }
            50% { transform: scale(1.05); }
            70% { transform: scale(0.9); }
            100% { transform: scale(1); opacity: 1; }
        }

        .animate-fadeIn { animation: fadeIn 0.6s ease-out; }
        .animate-slideInLeft { animation: slideInLeft 0.6s ease-out; }
        .animate-slideInRight { animation: slideInRight 0.6s ease-out; }
        .animate-bounceIn { animation: bounceIn 0.8s ease-out; }

        /* Enhanced Dark Mode Support */
        @media (prefers-color-scheme: dark) {
            :root {
                --bg-color: #1a1a1a;
                --text-color: #e0e0e0;
                --card-bg: #2d2d2d;
            }
        }

        /* Print Styles */
        @media print {
            .header, .nav-menu, .admin-controls, .modal {
                display: none !important;
            }
            
            .main-content {
                max-width: none;
                padding: 0;
            }
            
            .section {
                box-shadow: none;
                border: 1px solid #ddd;
                break-inside: avoid;
            }
        }
    </style>

    <!-- Enhanced JavaScript for Design Integration -->
    <script>
        // Enhanced UI Interactions
        class UIEnhancer {
            constructor() {
                this.init();
            }

            init() {
                this.setupScrollEffects();
                this.setupHoverEffects();
                this.setupMobileMenu();
                this.setupSmoothScrolling();
                this.setupParallaxEffects();
                this.setupIntersectionObserver();
            }

            setupScrollEffects() {
                let lastScrollTop = 0;
                const header = document.querySelector('.header');
                
                window.addEventListener('scroll', () => {
                    const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
                    
                    // Header hide/show on scroll
                    if (scrollTop > lastScrollTop && scrollTop > 100) {
                        header.style.transform = 'translateY(-100%)';
                    } else {
                        header.style.transform = 'translateY(0)';
                    }
                    
                    lastScrollTop = scrollTop;
                    
                    // Add shadow to header when scrolled
                    if (scrollTop > 50) {
                        header.style.boxShadow = 'var(--shadow-xl)';
                    } else {
                        header.style.boxShadow = 'var(--shadow-lg)';
                    }
                });
            }

            setupHoverEffects() {
                // Enhanced card hover effects
                document.querySelectorAll('.course-card').forEach(card => {
                    card.addEventListener('mouseenter', (e) => {
                        const rect = card.getBoundingClientRect();
                        const x = e.clientX - rect.left;
                        const y = e.clientY - rect.top;
                        
                        card.style.setProperty('--mouse-x', x + 'px');
                        card.style.setProperty('--mouse-y', y + 'px');
                    });
                });

                // Button ripple effect
                document.querySelectorAll('button, .btn-primary, .btn-secondary').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const ripple = document.createElement('span');
                        const rect = btn.getBoundingClientRect();
                        const size = Math.max(rect.width, rect.height);
                        const x = e.clientX - rect.left - size / 2;
                        const y = e.clientY - rect.top - size / 2;
                        
                        ripple.style.cssText = `
                            position: absolute;
                            width: ${size}px;
                            height: ${size}px;
                            left: ${x}px;
                            top: ${y}px;
                            background: rgba(255,255,255,0.3);
                            border-radius: 50%;
                            transform: scale(0);
                            animation: ripple 0.6s ease-out;
                            pointer-events: none;
                        `;
                        
                        btn.style.position = 'relative';
                        btn.style.overflow = 'hidden';
                        btn.appendChild(ripple);
                        
                        setTimeout(() => ripple.remove(), 600);
                    });
                });
            }

            setupMobileMenu() {
                const toggle = document.querySelector('.mobile-menu-toggle');
                const menu = document.querySelector('.nav-menu');
                
                if (toggle && menu) {
                    toggle.addEventListener('click', () => {
                        menu.classList.toggle('active');
                        toggle.innerHTML = menu.classList.contains('active') ? 
                            '<i class="fas fa-times"></i>' : '<i class="fas fa-bars"></i>';
                    });
                }
            }

            setupSmoothScrolling() {
                document.querySelectorAll('a[href^="#"]').forEach(anchor => {
                    anchor.addEventListener('click', function (e) {
                        e.preventDefault();
                        const target = document.querySelector(this.getAttribute('href'));
                        if (target) {
                            target.scrollIntoView({
                                behavior: 'smooth',
                                block: 'start'
                            });
                        }
                    });
                });
            }

            setupParallaxEffects() {
                const parallaxElements = document.querySelectorAll('[data-parallax]');
                
                window.addEventListener('scroll', () => {
                    const scrolled = window.pageYOffset;
                    
                    parallaxElements.forEach(element => {
                        const rate = scrolled * -0.5;
                        element.style.transform = `translateY(${rate}px)`;
                    });
                });
            }

            setupIntersectionObserver() {
                const observerOptions = {
                    threshold: 0.1,
                    rootMargin: '0px 0px -50px 0px'
                };

                const observer = new IntersectionObserver((entries) => {
                    entries.forEach(entry => {
                        if (entry.isIntersecting) {
                            entry.target.classList.add('animate-fadeIn');
                            
                            // Stagger animations for grid items
                            if (entry.target.classList.contains('course-card')) {
                                const delay = Array.from(entry.target.parentNode.children).indexOf(entry.target) * 100;
                                entry.target.style.animationDelay = delay + 'ms';
                            }
                        }
                    });
                }, observerOptions);

                // Observe all sections and cards
                document.querySelectorAll('.section, .course-card, .stat-card').forEach(el => {
                    observer.observe(el);
                });
            }
        }

        // Enhanced Theme Manager
        class ThemeManager {
            constructor() {
                this.currentTheme = localStorage.getItem('theme') || 'light';
                this.init();
            }

            init() {
                this.applyTheme();
                this.setupThemeToggle();
            }

            applyTheme() {
                document.documentElement.setAttribute('data-theme', this.currentTheme);
                
                // Update theme toggle button if exists
                const themeToggle = document.querySelector('.theme-toggle');
                if (themeToggle) {
                    themeToggle.innerHTML = this.currentTheme === 'dark' ? 
                        '<i class="fas fa-sun"></i>' : '<i class="fas fa-moon"></i>';
                }
            }

            toggleTheme() {
                this.currentTheme = this.currentTheme === 'light' ? 'dark' : 'light';
                localStorage.setItem('theme', this.currentTheme);
                this.applyTheme();
            }

            setupThemeToggle() {
                const themeToggle = document.querySelector('.theme-toggle');
                if (themeToggle) {
                    themeToggle.addEventListener('click', () => this.toggleTheme());
                }
            }
        }

        // Enhanced Performance Monitor
        class PerformanceMonitor {
            constructor() {
                this.metrics = {};
                this.init();
            }

            init() {
                this.measurePageLoad();
                this.setupResourceMonitoring();
                this.setupUserInteractionTracking();
            }

            measurePageLoad() {
                window.addEventListener('load', () => {
                    const navigation = performance.getEntriesByType('navigation')[0];
                    this.metrics.pageLoad = {
                        domContentLoaded: navigation.domContentLoadedEventEnd - navigation.domContentLoadedEventStart,
                        loadComplete: navigation.loadEventEnd - navigation.loadEventStart,
                        totalTime: navigation.loadEventEnd - navigation.fetchStart
                    };
                    
                    console.log('Page Load Metrics:', this.metrics.pageLoad);
                });
            }

            setupResourceMonitoring() {
                const observer = new PerformanceObserver((list) => {
                    list.getEntries().forEach((entry) => {
                        if (entry.entryType === 'resource') {
                            // Monitor slow resources
                            if (entry.duration > 1000) {
                                console.warn('Slow resource detected:', entry.name, entry.duration + 'ms');
                            }
                        }
                    });
                });
                
                observer.observe({ entryTypes: ['resource'] });
            }

            setupUserInteractionTracking() {
                // Track first input delay
                const observer = new PerformanceObserver((list) => {
                    list.getEntries().forEach((entry) => {
                        if (entry.entryType === 'first-input') {
                            this.metrics.firstInputDelay = entry.processingStart - entry.startTime;
                            console.log('First Input Delay:', this.metrics.firstInputDelay + 'ms');
                        }
                    });
                });
                
                observer.observe({ entryTypes: ['first-input'] });
            }
        }

        // Initialize enhanced features
        document.addEventListener('DOMContentLoaded', () => {
            new UIEnhancer();
            new ThemeManager();
            new PerformanceMonitor();
        });

        // Add ripple animation CSS
        const rippleCSS = `
            <style>
                @keyframes ripple {
                    to {
                        transform: scale(4);
                        opacity: 0;
                    }
                }
            </style>
        `;
        document.head.insertAdjacentHTML('beforeend', rippleCSS);
    </script>


</body>
</html>


